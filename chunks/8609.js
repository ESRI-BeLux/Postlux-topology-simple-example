"use strict";(self.webpackChunkarcgis_typescript_template=self.webpackChunkarcgis_typescript_template||[]).push([[8609],{38382:(e,t,r)=>{r.d(t,{C:()=>w,b:()=>T});var i=r(47635),n=r(77788),s=r(29592),o=r(31790),a=r(38587),l=r(73713),c=r(23932),d=r(15479),h=r(65630),u=r(24578),p=r(78546),f=r(83660),g=r(69952),m=r(92121),_=r(41014),v=r(92624),y=r(7782),O=r(33763);function T(e){const t=new v.N5,{vertex:r,fragment:T,attributes:w,varyings:b}=t;(0,g.NB)(r,e),t.include(o.d,e),t.include(l.c,e),t.include(u.A,e),t.include(a.g,e),w.add(O.r.POSITION,"vec3"),e.vvColor&&w.add(O.r.COLORFEATUREATTRIBUTE,"float"),b.add("vColor","vec4"),b.add("vpos","vec3");const C=e.multipassEnabled&&(e.output===n.V.Color||e.output===n.V.Alpha);C&&b.add("depth","float"),r.uniforms.add(new m.E("eColor",(e=>e.color)));const S=e.output===n.V.LinearDepth;S&&(t.include(c.L,e),(0,i.xJ)(t),(0,i.Mu)(t)),r.code.add(_.H`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${e.hasVertexColors?"vColor *= eColor;":e.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;"}
      ${C?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${S?_.H`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:_.H`transformPosition(proj, view, vpos);`}
    }
  `),t.include(s.HQ,e),C&&t.include(h.Q,e),T.include(f.a);const A=e.output===n.V.Highlight;return A&&t.include(d.Qh,e),T.code.add(_.H`
  void main() {
    discardBySlice(vpos);
    ${C?"terrainDepthTest(depth);":""}
    vec4 fColor = vColor;

    ${e.output===n.V.ObjectAndLayerIdColor?_.H`fColor.a = 1.0;`:""}

    if (fColor.a < ${_.H.float(p.y)}) {
      discard;
    }

    ${e.output===n.V.Alpha?_.H`fragColor = vec4(fColor.a);`:""}

    ${e.output===n.V.Color?_.H`fragColor = highlightSlice(fColor, vpos); ${e.transparencyPassType===y.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}`:""}
    ${A?_.H`outputHighlight();`:""};
    ${e.output===n.V.LinearDepth?_.H`outputDepth(linearDepth);`:""};
    ${e.output===n.V.ObjectAndLayerIdColor?_.H`outputObjectAndLayerIdColor();`:""}
  }
  `),t}const w=Object.freeze(Object.defineProperty({__proto__:null,build:T},Symbol.toStringTag,{value:"Module"}))},32052:(e,t,r)=>{r.d(t,{H:()=>M,b:()=>R,c:()=>D});var i=r(53334),n=r(56560),s=r(76982),o=r(77788),a=r(29592),l=r(38587),c=r(65895),d=r(87331),h=r(73227),u=r(16075),p=r(15479),f=r(24578),g=r(78546),m=r(83660),_=r(80002),v=r(15510),y=r(69952),O=r(66579),T=r(92121),w=r(19635),b=r(41014),C=r(92624),S=r(19778),A=r(7782),x=r(33763);function R(e){const t=new C.N5,r=e.signedDistanceFieldEnabled;if(t.include(d.Q,e),t.include(a.HQ,e),e.occlusionPass)return t.include(h.I,e),t;const{vertex:n,fragment:R}=t;t.include(v.Y6),R.include(_.W),R.include(m.a),t.include(f.A,e),t.include(l.g,e),t.include(u.y),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),t.varyings.add("voccluded","float"),n.uniforms.add(new T.E("viewport",((e,t)=>t.camera.fullViewport)),new O.G("screenOffset",((e,t)=>(0,i.hZ)(P,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio))),new O.G("anchorPosition",(e=>D(e))),new T.E("materialColor",(e=>e.color))),(0,y.Nz)(n),r&&(n.uniforms.add(new T.E("outlineColor",(e=>e.outlineColor))),R.uniforms.add(new T.E("outlineColor",(e=>E(e)?e.outlineColor:s.uY)),new w.m("outlineSize",(e=>E(e)?e.outlineSize:0)))),e.pixelSnappingEnabled&&n.include(c.K),e.hasScreenSizePerspective&&((0,v.pM)(n),(0,v.OH)(n)),e.debugDrawLabelBorder&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(x.r.UV0,"vec2"),t.attributes.add(x.r.COLOR,"vec4"),t.attributes.add(x.r.SIZE,"vec2"),t.attributes.add(x.r.FEATUREATTRIBUTE,"vec4"),n.code.add(b.H`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.hasScreenSizePerspective?b.H`
            inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
            vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:b.H`
            inputSize = size;
            vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(featureAttribute).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);
      bool visible = testHUDVisibility(posProj);
      voccluded = visible ? 0.0 : 1.0;
    `);const M=b.H`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,I=e.pixelSnappingEnabled?r?b.H`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:b.H`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:b.H`posProj += quadOffset;`;n.code.add(b.H`
    ${e.occlusionTestEnabled?"if (visible) {":""}
    ${M}
    ${e.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${e.output===o.V.ObjectAndLayerIdColor?b.H`vcolor.a = 1.0;`:""}

    bool alphaDiscard = vcolor.a < ${b.H.float(g.y)};
    ${r?`alphaDiscard = alphaDiscard && outlineColor.a < ${b.H.float(g.y)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${I}
      gl_Position = posProj;
    }

    vtc = uv;

    ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${e.occlusionTestEnabled?b.H`} else { vtc = vec2(0.0);
      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),R.uniforms.add(new S.N("tex",(e=>e.texture)));const N=e.debugDrawLabelBorder?b.H`(isBorder > 0.0 ? 0.0 : ${b.H.float(g.H)})`:b.H.float(g.H),F=b.H`
    ${e.debugDrawLabelBorder?b.H`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${e.sampleSignedDistanceFieldTexelCenter?b.H`
      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;
      `:b.H`
      vec2 samplePos = vtc;
      `}

    ${r?b.H`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${N} ||
          fillPixelColor.a + outlinePixelColor.a < ${b.H.float(g.y)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        fragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${N}) {
          discard;
        }

        fragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:b.H`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${N}) {
            discard;
          }
          fragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?b.H`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;switch(e.output){case o.V.Color:R.code.add(b.H`
        void main() {
          ${F}
          ${e.transparencyPassType===A.y.FrontFace?"fragColor.rgb /= fragColor.a;":""}
        }`);break;case o.V.Alpha:R.code.add(b.H`
        void main() {
          ${F}
          fragColor = vec4(fragColor.a);
        }`);break;case o.V.ObjectAndLayerIdColor:R.code.add(b.H`
        void main() {
          ${F}
          outputObjectAndLayerIdColor();
        }`);break;case o.V.Highlight:R.constants.add("occludedHighlightFlag","vec4",p.U),R.constants.add("unoccludedHighlightFlag","vec4",p.bO),R.code.add(b.H`
        void main() {
          ${F}
          if (voccluded == 1.0) {
            fragColor = occludedHighlightFlag;
          } else {
            fragColor = unoccludedHighlightFlag;
          }
        }`)}return t}function E(e){return e.outlineColor[3]>0&&e.outlineSize>0}function D(e,t=P){return e.textureIsSignedDistanceField?function(e,t,r){null!=t?(0,i.hZ)(r,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):(0,i.hZ)(r,0,0)}(e.anchorPosition,e.distanceFieldBoundingBox,t):(0,i.C)(t,e.anchorPosition),t}const P=(0,n.vt)(),M=Object.freeze(Object.defineProperty({__proto__:null,build:R,calculateAnchorPosForRendering:D},Symbol.toStringTag,{value:"Module"}))},58062:(e,t,r)=>{r.d(t,{O:()=>d,a:()=>u,b:()=>h});var i=r(68986),n=r(28019),s=r(19635),o=r(88531),a=r(41014),l=r(92624),c=r(19778);class d extends a.Y{constructor(){super(...arguments),this.overlayIndex=i.vr.INNER,this.opacity=1}}function h(){const e=new l.N5;return e.include(n.c),e.fragment.uniforms.add(new c.N("tex",(e=>e.texture))),e.fragment.uniforms.add(new o.c("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new s.m("opacity",(e=>e.opacity))),e.fragment.code.add(a.H`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:d,build:h},Symbol.toStringTag,{value:"Module"}))},46348:(e,t,r)=>{r.d(t,{R:()=>R,b:()=>x,r:()=>A});var i=r(47635),n=r(77788),s=r(29592),o=r(38587),a=r(37303),l=r(23932),c=r(77802),d=r(47913),h=r(65630),u=r(48425),p=r(78546),f=r(83660),g=r(69952),m=r(66579),_=r(92121),v=r(19635),y=r(41014),O=r(99040),T=r(92624),w=r(7782),b=r(33763),C=r(18994),S=r(47268);const A=1;function x(e){const t=new T.N5,{attributes:r,varyings:x,constants:R,vertex:E,fragment:D}=t;t.include(u.p),t.include(a.s,e),t.include(c.q,e);const P=e.applyMarkerOffset&&!e.draped;P&&(E.uniforms.add(new v.m("markerScale",(e=>e.markerScale))),t.include(d.r,{space:C.lM.World,draped:!1})),e.output===n.V.LinearDepth&&t.include(l.L,e),t.include(o.g,e),(0,g.NB)(E,e),E.uniforms.add(new O.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new m.G("nearFar",((e,t)=>t.camera.nearFar)),new v.m("miterLimit",(e=>"miter"!==e.join?0:e.miterLimit)),new _.E("viewport",((e,t)=>t.camera.fullViewport))),E.constants.add("LARGE_HALF_FLOAT","float",65500),r.add(b.r.POSITION,"vec3"),r.add(b.r.PREVPOSITION,"vec3"),r.add(b.r.NEXTPOSITION,"vec3"),r.add(b.r.SUBDIVISIONFACTOR,"float"),r.add(b.r.UV0,"vec2"),x.add("vColor","vec4"),x.add("vpos","vec3"),x.add("vLineDistance","float"),x.add("vLineWidth","float"),(0,i.Mu)(t);const M=e.multipassEnabled&&(e.output===n.V.Color||e.output===n.V.Alpha);M&&x.add("depth","float");const I=e.stippleEnabled;I&&x.add("vLineSizeInv","float"),R.add("aaWidth","float",e.stippleEnabled?0:1);const N=e.capType===S.x.ROUND,F=e.stippleEnabled&&N,L=e.falloffEnabled||F;L&&x.add("vLineDistanceNorm","float"),N&&(x.add("vSegmentSDF","float"),x.add("vReverseSegmentSDF","float")),E.code.add(y.H`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),E.code.add(y.H`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),(0,i.i$)(t),E.code.add(y.H`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${M?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),(0,g.Nz)(E),E.code.add(y.H`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;
      float lineSize = getSize();

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = lineWidth;
      ${I?y.H`vLineSizeInv = 1.0 / lineSize;`:""}

      vec4 pos  = view * vec4(position, 1.0);
      vec4 prev = view * vec4(prevPosition, 1.0);
      vec4 next = view * vec4(nextPosition, 1.0);
  `),P&&E.code.add(y.H`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),E.code.add(y.H`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(e.stippleEnabled||N)&&E.code.add(y.H`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${N?y.H`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),E.code.add(y.H`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?E.code.add(y.H`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?y.H`min(1.0, subdivisionFactor * ${y.H.float((A+2)/(A+1))})`:y.H`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):E.code.add(y.H`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const z=e.capType!==S.x.BUTT;return E.code.add(y.H`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${z?y.H`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),E.code.add(y.H`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = sign(uv0.y) * pos.w;

    vLineDistance =  lineWidth * lineDistNorm;
    ${L?y.H`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),N&&E.code.add(y.H`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped?E.uniforms.add(new v.m("worldToScreenRatio",((e,t)=>1/t.screenToPCSRatio))):E.code.add(y.H`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),E.code.add(y.H`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?E.code.add(y.H`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):E.code.add(y.H`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),E.uniforms.add(new v.m("stipplePatternPixelSize",(e=>(0,c.h)(e)))),E.code.add(y.H`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),E.code.add(y.H`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),M&&t.include(h.Q,e),t.include(s.HQ,e),D.include(f.a),D.code.add(y.H`
  void main() {
    discardBySlice(vpos);
    ${M?"terrainDepthTest(depth);":""}
  `),e.wireframe?D.code.add(y.H`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(N&&D.code.add(y.H`
        float sdf = min(vSegmentSDF, vReverseSegmentSDF);
        vec2 fragmentPosition = vec2(
          min(sdf, 0.0),
          vLineDistance
        ) * gl_FragCoord.w;

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${y.H.float(p.y)}) {
          discard;
        }
      `),F?D.code.add(y.H`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${y.H.float(p.y)}, stippleCoverage);
      `):D.code.add(y.H`float stippleAlpha = getStippleAlpha();`),e.output!==n.V.ObjectAndLayerIdColor&&D.code.add(y.H`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),D.uniforms.add(new _.E("intrinsicColor",(e=>e.color))),D.code.add(y.H`vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&(D.uniforms.add(new _.E("innerColor",(e=>e.innerColor??e.color)),new v.m("innerWidth",((e,t)=>e.innerWidth*t.camera.pixelRatio))),D.code.add(y.H`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),D.code.add(y.H`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&(D.uniforms.add(new v.m("falloff",(e=>e.falloff))),D.code.add(y.H`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),e.stippleEnabled||D.code.add(y.H`float featherStartDistance = max(vLineWidth - 2.0, 0.0);
float value = abs(vLineDistance) * gl_FragCoord.w;
float feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`)),D.code.add(y.H`
    ${e.output===n.V.ObjectAndLayerIdColor?y.H`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${y.H.float(p.y)}) {
      discard;
    }

    ${e.output===n.V.Alpha?y.H`fragColor = vec4(finalColor.a);`:""}
    ${e.output===n.V.Color?y.H`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===n.V.Color&&e.transparencyPassType===w.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}
    ${e.output===n.V.Highlight?y.H`fragColor = vec4(1.0);`:""}
    ${e.output===n.V.LinearDepth?y.H`outputDepth(linearDepth);`:""}
    ${e.output===n.V.ObjectAndLayerIdColor?y.H`outputObjectAndLayerIdColor();`:""}
  }
  `),t}const R=Object.freeze(Object.defineProperty({__proto__:null,build:x,ribbonlineNumRoundJoinSubdivisions:A},Symbol.toStringTag,{value:"Module"}))},30607:(e,t,r)=>{r.d(t,{T:()=>c,a:()=>h,b:()=>d});var i=r(19913),n=r(28019),s=r(64802),o=r(41014),a=r(92624),l=r(19778);class c extends o.Y{constructor(){super(...arguments),this.color=(0,i.fA)(1,1,1)}}function d(){const e=new a.N5;return e.include(n.c),e.fragment.uniforms.add(new l.N("tex",(e=>e.texture)),new s.t("uColor",(e=>e.color))),e.fragment.code.add(o.H`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);
}`),e}const h=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:c,build:d},Symbol.toStringTag,{value:"Module"}))},7775:(e,t,r)=>{r.d(t,{a:()=>_,c:()=>v,g:()=>w,h:()=>E,u:()=>O}),r(6273);var i=r(80861),n=r(4506),s=r(82444),o=r(25336),a=r(26110),l=r(80347),c=r(19913),d=r(60929),h=r(94669),u=r(87368),p=r(63918),f=r(74695),g=r(11631);const m=()=>i.A.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function _(e=L){return{plane:(0,u.vt)(e.plane),origin:(0,c.o8)(e.origin),basis1:(0,c.o8)(e.basis1),basis2:(0,c.o8)(e.basis2)}}function v(e,t=_()){return y(e.origin,e.basis1,e.basis2,t)}function y(e,t,r,i=_()){return(0,l.c)(i.origin,e),(0,l.c)(i.basis1,t),(0,l.c)(i.basis2,r),O(i),function(e,t){Math.abs((0,l.k)(e.basis1,e.basis2)/((0,l.l)(e.basis1)*(0,l.l)(e.basis2)))>1e-6&&m().warn(t,"Provided basis vectors are not perpendicular"),Math.abs((0,l.k)(e.basis1,P(e)))>1e-6&&m().warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,l.k)(P(e),e.origin)-e.plane[3])>1e-6&&m().warn(t,"Plane offset is not consistent with plane origin")}(i,"fromValues()"),i}function O(e){(0,u.mR)(e.basis2,e.basis1,e.origin,e.plane)}function T(e,t,r){e!==r&&v(e,r);const i=(0,l.h)(g.rq.get(),P(e),t);return(0,l.g)(r.origin,r.origin,i),r.plane[3]-=t,r}function w(e,t=_()){const r=(e[2]-e[0])/2,i=(e[3]-e[1])/2;return(0,l.s)(t.origin,e[0]+r,e[1]+i,0),(0,l.s)(t.basis1,r,0,0),(0,l.s)(t.basis2,0,i,0),(0,u.fA)(0,0,1,0,t.plane),t}function b(e,t,r){return!!(0,u.Ui)(e.plane,t,r)&&M(e,r)}function C(e,t,r){const i=z.get();F(e,t,i,z.get());let s=Number.POSITIVE_INFINITY;for(const o of B){const a=N(e,o,H.get()),c=g.rq.get();if((0,u.T7)(i,a,c)){const e=(0,l.E)(g.rq.get(),t.origin,c),i=Math.abs((0,n.XM)((0,l.k)(t.direction,e)));i<s&&(s=i,(0,l.c)(r,c))}}return s===Number.POSITIVE_INFINITY?S(e,t,r):r}function S(e,t,r){if(b(e,t,r))return r;const i=z.get(),n=z.get();F(e,t,i,n);let s=Number.POSITIVE_INFINITY;for(const o of B){const a=N(e,o,H.get()),c=g.rq.get();if((0,u.gv)(i,a,c)){const e=(0,p.kb)(t,c);if(!(0,u.Tj)(n,c))continue;e<s&&(s=e,(0,l.c)(r,c))}}return R(e,t.origin)<s&&A(e,t.origin,r),r}function A(e,t,r){const i=(0,u._I)(e.plane,t,g.rq.get()),n=(0,h.H6)(I(e,e.basis1),i,-1,1,g.rq.get()),s=(0,h.H6)(I(e,e.basis2),i,-1,1,g.rq.get());return(0,l.f)(r,(0,l.g)(g.rq.get(),n,s),e.origin),r}function x(e,t,r){const{origin:i,basis1:n,basis2:s}=e,o=(0,l.f)(g.rq.get(),t,i),a=(0,f.gr)(n,o),c=(0,f.gr)(s,o),d=(0,f.gr)(P(e),o);return(0,l.s)(r,a,c,d)}function R(e,t){const r=x(e,t,g.rq.get()),{basis1:i,basis2:n}=e,s=(0,l.l)(i),o=(0,l.l)(n),a=Math.max(Math.abs(r[0])-s,0),c=Math.max(Math.abs(r[1])-o,0),d=r[2];return a*a+c*c+d*d}function E(e,t){return Math.sqrt(R(e,t))}function D(e,t){const r=-e.plane[3];return(0,f.gr)(P(e),t)-r}function P(e){return(0,u.Qj)(e.plane)}function M(e,t){const r=(0,l.f)(g.rq.get(),t,e.origin),i=(0,l.p)(e.basis1),n=(0,l.p)(e.basis2),s=(0,l.k)(e.basis1,r),o=(0,l.k)(e.basis2,r);return-s-i<0&&s-i<0&&-o-n<0&&o-n<0}function I(e,t){const r=H.get();return(0,l.c)(r.origin,e.origin),(0,l.c)(r.vector,t),r}function N(e,t,r){const{basis1:i,basis2:n,origin:s}=e,o=(0,l.h)(g.rq.get(),i,t.origin[0]),a=(0,l.h)(g.rq.get(),n,t.origin[1]);(0,l.g)(r.origin,o,a),(0,l.g)(r.origin,r.origin,s);const c=(0,l.h)(g.rq.get(),i,t.direction[0]),d=(0,l.h)(g.rq.get(),n,t.direction[1]);return(0,l.h)(r.vector,(0,l.g)(c,c,d),2),r}function F(e,t,r,i){const n=P(e);(0,u.mR)(n,t.direction,t.origin,r),(0,u.mR)((0,u.Qj)(r),n,t.origin,i)}const L={plane:(0,u.vt)(),origin:(0,c.fA)(0,0,0),basis1:(0,c.fA)(1,0,0),basis2:(0,c.fA)(0,1,0)},z=new s.I(u.vt),H=new s.I(h.vt),V=(0,c.vt)(),j=new s.I((()=>_())),B=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],U=(0,a.vt)(),W=(0,a.vt)();Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=(0,u.vt)(),this.origin=(0,c.vt)(),this.basis1=(0,c.vt)(),this.basis2=(0,c.vt)()}},altitudeAt:D,axisAt:function(e,t,r,i){return function(e,t,r){switch(t){case d._.X:(0,l.c)(r,e.basis1),(0,l.n)(r,r);break;case d._.Y:(0,l.c)(r,e.basis2),(0,l.n)(r,r);break;case d._.Z:(0,l.c)(r,P(e))}return r}(e,r,i)},closestPoint:S,closestPointOnSilhouette:C,copy:v,copyWithoutVerify:function(e,t){(0,l.c)(t.origin,e.origin),(0,l.c)(t.basis1,e.basis1),(0,l.c)(t.basis2,e.basis2),(0,u.C)(t.plane,e.plane)},create:_,distance:E,distance2:R,distanceToSilhouette:function(e,t){let r=Number.NEGATIVE_INFINITY;for(const i of B){const n=N(e,i,H.get()),s=(0,h.kb)(n,t);s>r&&(r=s)}return Math.sqrt(r)},elevate:T,equals:function(e,t){return(0,l.j)(e.basis1,t.basis1)&&(0,l.j)(e.basis2,t.basis2)&&(0,l.j)(e.origin,t.origin)},extrusionContainsPoint:function(e,t){return(0,u.Tj)(e.plane,t)&&M(e,t)},fromAABoundingRect:w,fromValues:y,intersectRay:b,intersectRayClosestSilhouette:function(e,t,r){if(b(e,t,r))return r;const i=C(e,t,g.rq.get());return(0,l.g)(r,t.origin,(0,l.h)(g.rq.get(),t.direction,(0,l.q)(t.origin,i)/(0,l.l)(t.direction))),r},normal:P,projectPoint:A,projectPointLocal:x,rotate:function(e,t,r,i){return e!==i&&v(e,i),(0,o.$0)(W,t,r),(0,l.e)(i.basis1,e.basis1,W),(0,l.e)(i.basis2,e.basis2,W),O(i),i},setAltitudeAt:function(e,t,r,i){const n=D(e,t),s=(0,l.h)(V,P(e),r-n);return(0,l.g)(i,t,s),i},setExtent:function(e,t,r){return w(t,r),T(r,D(e,e.origin),r),r},transform:function(e,t,r){return e!==r&&v(e,r),(0,o.B8)(U,t),(0,o.mg)(U,U),(0,l.e)(r.basis1,e.basis1,U),(0,l.e)(r.basis2,e.basis2,U),(0,l.e)((0,u.Qj)(r.plane),(0,u.Qj)(e.plane),U),(0,l.e)(r.origin,e.origin,t),(0,u.mP)(r.plane,r.plane,r.origin),r},up:L,updateUnboundedPlane:O,wrap:function(e,t,r){const i=j.get();return i.origin=e,i.basis1=t,i.basis2=r,i.plane=(0,u.LV)(0,0,0,0),O(i),i}},Symbol.toStringTag,{value:"Module"}))},39637:(e,t,r)=>{r.d(t,{T:()=>s,U:()=>n});var i=r(4506);function n(e,t,r=0){const n=(0,i.qE)(e,0,l);for(let e=0;e<4;e++)t[r+e]=Math.floor(256*c(n*o[e]))}function s(e,t=0){let r=0;for(let i=0;i<4;i++)r+=e[t+i]*a[i];return r}const o=[1,256,65536,16777216],a=[1/256,1/65536,1/16777216,1/4294967296],l=s(new Uint8ClampedArray([255,255,255,255]));function c(e){return e-Math.floor(e)}},6590:(e,t,r)=>{function i(){return new Float32Array(3)}function n(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function s(e,t,r){const i=new Float32Array(3);return i[0]=e,i[1]=t,i[2]=r,i}function o(){return i()}function a(){return s(1,1,1)}function l(){return s(1,0,0)}function c(){return s(0,1,0)}function d(){return s(0,0,1)}r.d(t,{fA:()=>s,o8:()=>n,vt:()=>i});const h=o(),u=a(),p=l(),f=c(),g=d();Object.freeze(Object.defineProperty({__proto__:null,ONES:u,UNIT_X:p,UNIT_Y:f,UNIT_Z:g,ZEROS:h,clone:n,create:i,createView:function(e,t){return new Float32Array(e,t,3)},fromValues:s,ones:a,unitX:l,unitY:c,unitZ:d,zeros:o},Symbol.toStringTag,{value:"Module"}))},10379:(e,t,r)=>{r.d(t,{E:()=>s});var i=r(19913),n=(r(34561),r(42722));function s(e,t,r){return!!(0,n.F)(e,t,o,r.spatialReference)&&(r.x=o[0],r.y=o[1],r.z=o[2],!0)}const o=(0,i.vt)()},45876:(e,t,r)=>{r.d(t,{$e:()=>a,j1:()=>l,mO:()=>c,vt:()=>o});var i=r(82444),n=r(80347),s=r(63918);function o(e){return e?{ray:(0,s.vt)(e.ray),c0:e.c0,c1:e.c1}:{ray:(0,s.vt)(),c0:0,c1:Number.MAX_VALUE}}function a(e,t=o()){return(0,s.C)(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function l(e,t){return d(e,e.c0,t)}function c(e,t){return d(e,e.c1,t)}function d(e,t,r){return(0,n.g)(r,e.ray.origin,(0,n.h)(r,e.ray.direction,t))}new i.I((()=>o()))},74224:(e,t,r)=>{r.d(t,{C:()=>m,FB:()=>i,ig:()=>y,m7:()=>v,ui:()=>_,vt:()=>g});var i,n,s,o=r(82444),a=r(25336),l=r(80347),c=r(19913),d=r(74772),h=r(76982),u=r(45876),p=r(87368),f=r(11631);function g(e){return e?[(0,p.vt)(e[0]),(0,p.vt)(e[1]),(0,p.vt)(e[2]),(0,p.vt)(e[3]),(0,p.vt)(e[4]),(0,p.vt)(e[5])]:[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()]}function m(e,t){for(let r=0;r<O;r++)(0,p.C)(e[r],t[r]);return e}function _(e,t,r,s=b){const o=(0,a.lw)(f.Rc.get(),t,e);(0,a.B8)(o,o);for(let e=0;e<T;++e){const t=(0,d.t)(f.Km.get(),w[e],o);(0,l.s)(s[e],t[0]/t[3],t[1]/t[3],t[2]/t[3])}!function(e,t){(0,p.Cr)(t[n.FAR_BOTTOM_LEFT],t[n.NEAR_BOTTOM_LEFT],t[n.NEAR_TOP_LEFT],e[i.LEFT]),(0,p.Cr)(t[n.NEAR_BOTTOM_RIGHT],t[n.FAR_BOTTOM_RIGHT],t[n.FAR_TOP_RIGHT],e[i.RIGHT]),(0,p.Cr)(t[n.FAR_BOTTOM_LEFT],t[n.FAR_BOTTOM_RIGHT],t[n.NEAR_BOTTOM_RIGHT],e[i.BOTTOM]),(0,p.Cr)(t[n.NEAR_TOP_LEFT],t[n.NEAR_TOP_RIGHT],t[n.FAR_TOP_RIGHT],e[i.TOP]),(0,p.Cr)(t[n.NEAR_BOTTOM_LEFT],t[n.NEAR_BOTTOM_RIGHT],t[n.NEAR_TOP_RIGHT],e[i.NEAR]),(0,p.Cr)(t[n.FAR_BOTTOM_RIGHT],t[n.FAR_BOTTOM_LEFT],t[n.FAR_TOP_LEFT],e[i.FAR])}(r,s)}function v(e,t){for(let r=0;r<O;r++){const i=e[r];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0}function y(e,t){for(let r=0;r<O;r++){const i=e[r];if(!(0,p.b6)(i,t))return!1}return!0}(s=i||(i={}))[s.LEFT=0]="LEFT",s[s.RIGHT=1]="RIGHT",s[s.BOTTOM=2]="BOTTOM",s[s.TOP=3]="TOP",s[s.NEAR=4]="NEAR",s[s.FAR=5]="FAR",function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(n||(n={})),n.FAR_BOTTOM_RIGHT,n.NEAR_BOTTOM_RIGHT,n.NEAR_BOTTOM_LEFT,n.FAR_BOTTOM_LEFT,n.NEAR_BOTTOM_LEFT,n.NEAR_BOTTOM_RIGHT,n.NEAR_TOP_RIGHT,n.NEAR_TOP_LEFT,n.FAR_BOTTOM_RIGHT,n.FAR_BOTTOM_LEFT,n.FAR_TOP_LEFT,n.FAR_TOP_RIGHT,n.NEAR_BOTTOM_RIGHT,n.FAR_BOTTOM_RIGHT,n.FAR_TOP_RIGHT,n.NEAR_TOP_RIGHT,n.FAR_BOTTOM_LEFT,n.NEAR_BOTTOM_LEFT,n.NEAR_TOP_LEFT,n.FAR_TOP_LEFT,n.FAR_TOP_LEFT,n.NEAR_TOP_LEFT,n.NEAR_TOP_RIGHT,n.FAR_TOP_RIGHT;const O=6,T=8,w=[(0,h.fA)(-1,-1,-1,1),(0,h.fA)(1,-1,-1,1),(0,h.fA)(1,1,-1,1),(0,h.fA)(-1,1,-1,1),(0,h.fA)(-1,-1,1,1),(0,h.fA)(1,-1,1,1),(0,h.fA)(1,1,1,1),(0,h.fA)(-1,1,1,1)],b=(new o.I(u.vt),[(0,c.vt)(),(0,c.vt)(),(0,c.vt)(),(0,c.vt)(),(0,c.vt)(),(0,c.vt)(),(0,c.vt)(),(0,c.vt)()])},75423:(e,t,r)=>{function i(e){return"point"===e.type}r.d(t,{v:()=>i})},29740:(e,t,r)=>{var i,n;function s(e){return null!=e&&!e.running}r.d(t,{c:()=>n,c2:()=>i,pi:()=>s}),function(e){e[e.RENDERING=0]="RENDERING",e[e.FADING=1]="FADING",e[e.FINISHED=2]="FINISHED"}(i||(i={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA"}(n||(n={}))},99164:(e,t,r)=>{r.d(t,{OQ:()=>i,ny:()=>g});var i,n,s=r(4506),o=r(25336),a=r(26110),l=r(80347),c=r(19913),d=r(43785),h=r(99263),u=r(29740),p=r(16120),f=r(47273);class g{constructor(){this.readChannels=u.c.RG,this.renderingStage=u.c2.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=(0,c.vt)(),this.parallax=new m,this.parallaxNew=new m,this.pointOnGround=(0,c.vt)(),this.fadeMode=i.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(e){const t=this.parallax,r=(0,l.l)(e.eye);if(t.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(r*r-h.$O.radius*h.$O.radius,0))/r,(0,d.Cr)(_,t.anchorPointClouds,v),(0,o.e$)(t.transform,a.zK,v[3],(0,d.yo)(v)),this.fadeMode===i.CROSS_FADE){const e=this.parallaxNew;(0,d.Cr)(_,e.anchorPointClouds,v),(0,o.e$)(e.transform,a.zK,v[3],(0,d.yo)(v))}}updateFading(e,t,r,i){this.isFading&&this._advanceFading(r,i),this._evaluateFading(e,t,r)}_evaluateFading(e,t,r){const n=e.relativeElevation,s=this._calculateDistanceToAnchorPoint(e);if((n>1.7*p.ni||n<-p.ni||s>b)&&this.opacity>0)this._setFade(i.HIDE,r);else if(!this.isFading)if((n>p.ni||n<-.35*p.ni||s>w)&&this.opacity>0)this._setFade(i.FADE_OUT,r);else if(n<=p.ni&&n>=-.35*p.ni&&t===f.M.IDLE&&(0,u.pi)(this.data)){if(0===this.opacity)return void this._setFade(i.FADE_IN,r);(s>T||this.renderingStage===u.c2.FADING)&&this._setFade(i.CROSS_FADE,r)}}_advanceFading(e,t){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,t)}_advanceFadingFactorAndOpacity(e,t){if(this.fadeFactor<1)return this.fadeFactor=t?(0,s.qE)((e-this.startTime)/(O*t),0,1):1,this.fadeMode===i.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===i.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===i.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===i.FADE_OUT&&(this.opacity=0),this.fadeMode===i.FADE_IN&&(this.opacity=1),this.fadeMode===i.CROSS_FADE&&(this.opacity=1),this.fadeMode=i.NONE}_switchReadChannels(){const e=this.fadeMode===i.CROSS_FADE&&1===this.fadeFactor,t=this.fadeMode===i.FADE_IN&&0===this.fadeFactor;this.renderingStage===u.c2.FADING&&(e||t)&&(this.readChannels=1-this.readChannels,this.renderingStage=u.c2.FINISHED)}_calculateDistanceToAnchorPoint(e){return(0,l.n)(this.pointOnGround,e.eye),(0,l.h)(this.pointOnGround,this.pointOnGround,h.$O.radius),(0,l.l)((0,l.f)(y,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===i.CROSS_FADE&&(0===this.fadeFactor&&(0,l.c)(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&(0,l.c)(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===i.FADE_IN&&0===this.fadeFactor&&(0,l.c)(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(e,t){switch(e){case i.HIDE:this.opacity=0;break;case i.FADE_OUT:this.opacity=1;break;case i.FADE_IN:this.opacity=0;break;case i.CROSS_FADE:this.opacity=1}this.fadeMode=e,this.fadeFactor=0,this.startTime=t}get isFading(){return this.fadeMode===i.FADE_OUT||this.fadeMode===i.FADE_IN||this.fadeMode===i.CROSS_FADE}}(n=i||(i={}))[n.NONE=0]="NONE",n[n.HIDE=1]="HIDE",n[n.FADE_OUT=2]="FADE_OUT",n[n.FADE_IN=3]="FADE_IN",n[n.CROSS_FADE=4]="CROSS_FADE";class m{constructor(){this.anchorPointClouds=(0,c.vt)(),this.radiusCurvatureCorrectionFactor=0,this.transform=(0,a.vt)()}}const _=(0,c.fA)(0,0,1),v=(0,d.vt)(),y=(0,c.vt)(),O=1.25,T=34e3,w=64e3,b=2e5},16120:(e,t,r)=>{r.d(t,{k9:()=>C,ni:()=>b});var i,n=r(82392),s=r(84977),o=r(81482),a=(r(6273),r(80861),r(67498),r(85716)),l=r(26325);let c=i=class extends s.oY{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new i({cloudCover:this.cloudCover})}};(0,n._)([(0,a.e)({cloudy:"cloudy"})],c.prototype,"type",void 0),(0,n._)([(0,o.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=i=(0,n._)([(0,l.$)("esri.views.3d.environment.CloudyWeather")],c);const d=c;var h;let u=h=class extends s.oY{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new h({fogStrength:this.fogStrength})}};(0,n._)([(0,a.e)({foggy:"foggy"})],u.prototype,"type",void 0),(0,n._)([(0,o.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],u.prototype,"fogStrength",void 0),u=h=(0,n._)([(0,l.$)("esri.views.3d.environment.FoggyWeather")],u);const p=u;var f;let g=f=class extends s.oY{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new f({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,n._)([(0,a.e)({rainy:"rainy"})],g.prototype,"type",void 0),(0,n._)([(0,o.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"cloudCover",void 0),(0,n._)([(0,o.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"precipitation",void 0),g=f=(0,n._)([(0,l.$)("esri.views.3d.environment.RainyWeather")],g);const m=g;var _;let v=_=class extends s.oY{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new _({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};(0,n._)([(0,a.e)({snowy:"snowy"})],v.prototype,"type",void 0),(0,n._)([(0,o.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"cloudCover",void 0),(0,n._)([(0,o.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"precipitation",void 0),(0,n._)([(0,o.MZ)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],v.prototype,"snowCover",void 0),v=_=(0,n._)([(0,l.$)("esri.views.3d.environment.SnowyWeather")],v);const y=v;var O;let T=O=class extends s.oY{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new O({cloudCover:this.cloudCover})}};(0,n._)([(0,a.e)({sunny:"sunny"})],T.prototype,"type",void 0),(0,n._)([(0,o.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],T.prototype,"cloudCover",void 0),T=O=(0,n._)([(0,l.$)("esri.views.3d.environment.SunnyWeather")],T);const w={key:"type",base:T,typeMap:{sunny:T,cloudy:d,rainy:m,snowy:y,foggy:p}};Object.keys(w.typeMap);const b=1e4,C=1e5},93129:(e,t,r)=>{r.d(t,{F:()=>s});var i=r(69172),n=r(35542);class s{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=(0,i.Ao)(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const r=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?r:e+r}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return null!=r&&(t+=(0,n.g7)(r)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=(0,i.Tg)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,t,r){if(null==e)return void(this._featureExpressionInfoContext=null);const i=e?.arcade;i&&null!=t&&null!=r?(this._featureExpressionInfoContext=(0,n.o8)(e),(0,n.gf)(this._featureExpressionInfoContext,(0,n.VG)(i.modules,t,r))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new s;return null!=e&&t.setFromElevationInfo(e),t}}},5822:(e,t,r)=>{r.d(t,{I2:()=>m,Kf:()=>v,Uk:()=>T,ai:()=>O,au:()=>p,fe:()=>y,nG:()=>g,nu:()=>_,sE:()=>f,uw:()=>i});var i,n,s=r(25336),o=r(26110),a=r(19913),l=r(63540),c=r(88133),d=r(75423),h=r(2568),u=r(33763);function p(e,t,r,i,n,s,o,a,l,d,h){const u=w[h.mode];let p,f,g=0;if((0,c.projectBuffer)(e,t,r,i,l.spatialReference,n,a))return u.requiresAlignment(h)?(g=u.applyElevationAlignmentBuffer(i,n,s,o,a,l,d,h),p=s,f=o):(p=i,f=n),(0,c.projectBuffer)(p,l.spatialReference,f,s,d.spatialReference,o,a)?g:void 0}function f(e,t,r,i,n){const s=((0,d.v)(e)?e.z:(0,h.cN)(e)?e.array[e.offset+2]:e[2])||0;switch(r.mode){case"on-the-ground":{const r=(0,h.R1)(t,e,"ground")??0;return n.verticalDistanceToGround=0,n.sampledElevation=r,void(n.z=r)}case"relative-to-ground":{const o=(0,h.R1)(t,e,"ground")??0,a=r.geometryZWithOffset(s,i);return n.verticalDistanceToGround=a,n.sampledElevation=o,void(n.z=a+o)}case"relative-to-scene":{const o=(0,h.R1)(t,e,"scene")??0,a=r.geometryZWithOffset(s,i);return n.verticalDistanceToGround=a,n.sampledElevation=o,void(n.z=a+o)}case"absolute-height":{const o=r.geometryZWithOffset(s,i),a=(0,h.R1)(t,e,"ground")??0;return n.verticalDistanceToGround=o-a,n.sampledElevation=a,void(n.z=o)}default:return void(n.z=0)}}function g(e,t,r,i){return f(e,t,r,i,C),C.z}function m(e,t,r){return null==t||null==r?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===r?e.staysOnTheGround:t===r||"on-the-ground"!==t&&"on-the-ground"!==r?i.UPDATE:e.onTheGroundChanged}function _(e){return"relative-to-ground"===e||"relative-to-scene"===e}function v(e){return"absolute-height"!==e}function y(e,t,r,i,n){f(t,r,n,i,C),O(e,C.verticalDistanceToGround);const o=C.sampledElevation,a=(0,s.C)(b,e.transformation);return S[0]=t.x,S[1]=t.y,S[2]=C.z,(0,l.l)(t.spatialReference,S,a,i.spatialReference)?e.transformation=a:console.warn("Could not locate symbol object properly, it might be misplaced"),o}function O(e,t){for(let r=0;r<e.geometries.length;++r){const i=e.geometries[r].getMutableAttribute(u.r.CENTEROFFSETANDDISTANCE);i&&i.data[3]!==t&&(i.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[r],u.r.CENTEROFFSETANDDISTANCE))}}class T{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}(n=i||(i={}))[n.NONE=0]="NONE",n[n.UPDATE=1]="UPDATE",n[n.RECREATE=2]="RECREATE";const w={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,r,i,n,s,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;t*=3,i*=3;for(let s=0;s<n;++s){const n=e[t],s=e[t+1],o=e[t+2];r[i]=n,r[i+1]=s,r[i+2]=null==c?o+l:l,t+=3,i+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,r=e.featureExpressionInfoContext;return 0!==t||null!=r}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,n,s){let o=0;const a=s.spatialReference;t*=3,i*=3;for(let l=0;l<n;++l){const n=e[t],l=e[t+1],c=e[t+2],d=s.getElevation(n,l,c,a,"ground")??0;o+=d,r[i]=n,r[i+1]=l,r[i+2]=d,t+=3,i+=3}return o/n},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,n,s,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),d=a.featureExpressionInfoContext,h=s.spatialReference;t*=3,i*=3;for(let o=0;o<n;++o){const n=e[t],o=e[t+1],a=e[t+2],u=s.getElevation(n,o,a,h,"ground")??0;l+=u,r[i]=n,r[i+1]=o,r[i+2]=null==d?a+u+c:u+c,t+=3,i+=3}return l/n},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,r,i,n,s,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),d=a.featureExpressionInfoContext,h=s.spatialReference;t*=3,i*=3;for(let o=0;o<n;++o){const n=e[t],o=e[t+1],a=e[t+2],u=s.getElevation(n,o,a,h,"scene")??0;l+=u,r[i]=n,r[i+1]=o,r[i+2]=null==d?a+u+c:u+c,t+=3,i+=3}return l/n},requiresAlignment:()=>!0}},b=(0,o.vt)(),C=new T,S=(0,a.vt)()},35542:(e,t,r)=>{r.d(t,{KF:()=>f,MF:()=>p,VG:()=>d,g7:()=>u,gf:()=>h,o8:()=>l,q6:()=>c});var i=r(80861),n=r(37623),s=r(96124),o=r(83911);const a=()=>i.A.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function l(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function c(e,t,r,i){const s=e?.expression;if("string"!=typeof s)return null;const a=function(e){return"0"===e?0:null}(s);if(null!=a)return{cachedResult:a};const l=await(0,o.lw)();(0,n.Te)(r);const c=l.arcadeUtils,d=c.createSyntaxTree(s);return c.dependsOnView(d)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:c.createFunction(d),context:c.createExecContext(null,{sr:t}),modules:l}}}function d(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)}function h(e,t){if(null!=e&&!g(e)){if(!t||!e.arcade)return void a().errorOncePerTick("Arcade support required but not provided");const r=t;r._geometry&&(r._geometry=(0,s.wZ)(r._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function u(e){if(null!=e){if(g(e))return e.cachedResult;const t=e.arcade;let r=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof r&&(e.cachedResult=0,r=0),r}return 0}function p(e,t=!1){let r=e?.featureExpressionInfo;const i=r?.expression;return t||"0"===i||(r=null),r??null}const f={cachedResult:0};function g(e){return null!=e.cachedResult}},73682:(e,t,r)=>{r.d(t,{$2:()=>C,$C:()=>O,Hj:()=>w,Mh:()=>b,W$:()=>m,pW:()=>T,t8:()=>y,vY:()=>S});var i=r(5262),n=r(25336),s=r(26110),o=r(19913),a=r(74772),l=r(76982),c=r(34561),d=r(46373),h=r(2532),u=r(23064),p=r(11021),f=r(82320),g=r(96124);function m(e,t){if("point"===e.type)return v(e,t,!1);if((0,g.gr)(e))switch(e.type){case"extent":return v(e.center,t,!1);case"polygon":return v(e.centroid,t,!1);case"polyline":return v(_(e),t,!0);case"mesh":return v(e.origin,t,!1)}else switch(e.type){case"extent":return v(function(e){return(0,f.T)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),null!=e.zmin&&null!=e.zmax&&isFinite(e.zmin)&&isFinite(e.zmax)?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return v(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const r=(0,u.S8)(e.rings,!!e.hasZ);return(0,f.T)(r[0],r[1],r[2],e.spatialReference)}(e),t,!0);case"polyline":return v(_(e),t,!0)}}function _(e){const t=e.paths[0];if(!t||0===t.length)return null;const r=(0,p.$H)(t,(0,p.Yl)(t)/2);return(0,f.T)(r[0],r[1],r[2],e.spatialReference)}function v(e,t,r){const i=r?e:(0,g.EL)(e);return t&&e?(0,c.projectPoint)(e,i,t)?i:null:i}function y(e,t,r,i=0){if(e){t||(t=(0,h.vt)());const n=e;let s=.5*n.width*(r-1),o=.5*n.height*(r-1);return n.width<1e-7*n.height?s+=o/20:n.height<1e-7*n.width&&(o+=s/20),(0,a.s)(t,n.xmin-s-i,n.ymin-o-i,n.xmax+s+i,n.ymax+o+i),t}return null}function O(e,t,r=null){const i=(0,l.o8)(l.Un);return null!=e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),null!=t?i[3]=t:null!=e&&e.length>3&&(i[3]=e[3]),r&&(i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r),i}function T(e=o.Un,t,r,i=1){const n=new Array(3);if(null==t||null==r)n[0]=1,n[1]=1,n[2]=1;else{let i,s=0;for(let o=2;o>=0;o--){const a=e[o];let l;const c=null!=a,d=0===o&&!i&&!c,h=r[o];"symbol-value"===a||d?l=0!==h?t[o]/h:1:c&&"proportional"!==a&&isFinite(a)&&(l=0!==h?a/h:1),null!=l&&(n[o]=l,i=l,s=Math.max(s,Math.abs(l)))}for(let e=2;e>=0;e--)null==n[e]?n[e]=i:0===n[e]&&(n[e]=.001*s)}for(let e=2;e>=0;e--)n[e]/=i;return(0,o.ci)(n)}function w(e){return b(function(e){return null!=e.isPrimitive}(e)?[e.width,e.depth,e.height]:e)?null:"Symbol sizes may not be negative values"}function b(e){const t=e=>null==e||e>=0;return Array.isArray(e)?e.every(t):t(e)}function C(e,t,r,i=(0,s.vt)()){return e&&(0,n.Qr)(i,i,-e/180*Math.PI),t&&(0,n.eL)(i,i,t/180*Math.PI),r&&(0,n.Z8)(i,i,r/180*Math.PI),i}function S(e,t,r){if(null!=r.minDemResolution)return r.minDemResolution;const n=(0,i.GA)(t),s=(0,d.VL)(e)*n,o=(0,d.yr)(e)*n,a=(0,d.uJ)(e)*(t.isGeographic?1:n);return 0===s&&0===o&&0===a?r.minDemResolutionForPoints:.01*Math.max(s,o,a)}},161:(e,t,r)=>{var i,n,s;r.d(t,{O7:()=>n,Om:()=>i,sv:()=>s}),function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(i||(i={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(n||(n={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(s||(s={}))},2568:(e,t,r)=>{r.d(t,{R1:()=>o,aY:()=>n,cN:()=>s});var i=r(75423);class n{constructor(e,t=null,r=0){this.array=e,this.spatialReference=t,this.offset=r}}function s(e){return"array"in e}function o(e,t,r="ground"){if((0,i.v)(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,r);if(s(t)){let i=t.offset;return e.getElevation(t.array[i++],t.array[i++],t.array[i]||0,t.spatialReference??e.spatialReference,r)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,r)}},29386:(e,t,r)=>{r.d(t,{U:()=>s});var i=r(68716),n=r(67277);function s(e,t=0){const r=e.stride;return Array.from(e.fields.keys()).map((i=>{const s=e.fields.get(i),a=s.constructor.ElementCount,l=o(s.constructor.ElementType),c=s.offset,d=!(!s.optional||!s.optional.glNormalized);return new n._(i,a,l,c,r,d,t)}))}function o(e){const t=a[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const a={u8:i.pe.UNSIGNED_BYTE,u16:i.pe.UNSIGNED_SHORT,u32:i.pe.UNSIGNED_INT,i8:i.pe.BYTE,i16:i.pe.SHORT,i32:i.pe.INT,f32:i.pe.FLOAT}},41410:(e,t,r)=>{r.d(t,{t:()=>m,z:()=>y});var i=r(53334),n=r(56560),s=r(76982),o=r(34670),a=r(99269),l=r(75644),c=r(68435),d=r(51831),h=r(84456),u=r(10941),p=r(61723),f=r(40753),g=r(33763);function m(e,t,r=null){const n=[],m=t.mapPositions;!function(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:i}=e,n=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&i,s=r.length/3-(n?1:0),o=new Array(2*(s-1)),a=n?r.slice(0,-3):r;let l=0;for(let e=0;e<s-1;e++)o[l++]=e,o[l++]=e+1;t.push([g.r.POSITION,new u.n(a,o,3,n)])}(t,n);const y=n[0][1].data,O=n[0][1].indices.length,T=(0,d.EH)(O);return function(e,t,r){if(null!=e.attributeData.colorFeature)return;const i=e.attributeData.color;t.push([g.r.COLOR,new u.n(i??s.Un,r,4)])}(t,n,T),function(e,t,r){null==e.attributeData.sizeFeature&&t.push([g.r.SIZE,new u.n([e.attributeData.size??1],r,1,!0)])}(t,n,T),function(e,t,r){e.attributeData.normal&&t.push([g.r.NORMAL,new u.n(e.attributeData.normal,r,3)])}(t,n,T),function(e,t,r){null!=e.attributeData.colorFeature&&t.push([g.r.COLORFEATUREATTRIBUTE,new u.n([e.attributeData.colorFeature],r,1,!0)])}(t,n,T),function(e,t,r){null!=e.attributeData.sizeFeature&&t.push([g.r.SIZEFEATUREATTRIBUTE,new u.n([e.attributeData.sizeFeature],r,1,!0)])}(t,n,T),function(e,t,r){null!=e.attributeData.opacityFeature&&t.push([g.r.OPACITYFEATUREATTRIBUTE,new u.n([e.attributeData.opacityFeature],r,1,!0)])}(t,n,T),function(e,t,r){if(null==e.overlayInfo||e.overlayInfo.renderCoordsHelper.viewingMode!==h.RT.Global||!e.overlayInfo.spatialReference.isGeographic)return;const n=(0,l.jh)(r.length),s=(0,o.tO)(e.overlayInfo.spatialReference);for(let e=0;e<n.length;e+=3)(0,a.RC)(r,e,n,e,s);const d=r.length/3,p=(0,c.oe)(d+1);let f=_,m=v,y=0,O=0;(0,i.hZ)(f,n[O++],n[O++]),O++,p[0]=0;for(let e=1;e<d+1;++e)e===d&&(O=0),(0,i.hZ)(m,n[O++],n[O++]),O++,y+=(0,i.xg)(f,m),p[e]=y,[f,m]=[m,f];t.push([g.r.DISTANCETOSTART,new u.n(p,t[0][1].indices,1,!0)])}(t,n,y),new f.V(e,n,m,p.X.Line,r)}const _=(0,n.vt)(),v=(0,n.vt)();function y(e,t){if(null==e||0===e.length)return[];const r=[];return e.forEach((e=>{const i=e.length,n=(0,l.jh)(3*i);e.forEach(((e,t)=>{n[3*t]=e[0],n[3*t+1]=e[1],n[3*t+2]=e[2]}));const s={attributeData:{position:n,normal:t},removeDuplicateStartEnd:!1};r.push(s)})),r}},4498:(e,t,r)=>{r.d(t,{Cz:()=>n,DZ:()=>o,PV:()=>s,vO:()=>i}),r(11519),r(68716),r(89958),r(88416);const i=64,n=i/2,s=i/(n/5),o=.25},11519:(e,t,r)=>{r.d(t,{CN:()=>a,Q_:()=>o,ny:()=>l,sZ:()=>c}),r(6273);var i=r(39637),n=r(41038),s=r(68716);const o=128,a=.5;function l(e){return"cross"===e||"x"===e}function c(e,t=o,r=t*a,i=0){const l=function(e,t=o,r=t*a,i=0){switch(e){case"circle":default:return function(e,t){const r=e/2-.5;return f(e,u(r,r,t/2))}(t,r);case"square":return function(e,t){return d(e,t,!1)}(t,r);case"cross":return function(e,t,r=0){return h(e,t,!1,r)}(t,r,i);case"x":return function(e,t,r=0){return h(e,t,!0,r)}(t,r,i);case"kite":return function(e,t){return d(e,t,!0)}(t,r);case"triangle":return function(e,t){return f(e,p(e/2,t,t/2))}(t,r);case"arrow":return function(e,t){const r=t,i=t/2,n=e/2,s=.8*r,o=u(n,(e-t)/2-s,Math.sqrt(s*s+i*i)),a=p(n,r,i);return f(e,((e,t)=>Math.max(a(e,t),-o(e,t))))}(t,r)}}(e,t,r,i);return new n.g(l,{mipmap:!1,wrap:{s:s.pF.CLAMP_TO_EDGE,t:s.pF.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0})}function d(e,t,r){return r&&(t/=Math.SQRT2),f(e,((i,n)=>{let s=i-.5*e+.25,o=.5*e-n-.75;if(r){const e=(s+o)/Math.SQRT2;o=(o-s)/Math.SQRT2,s=e}return Math.max(Math.abs(s),Math.abs(o))-.5*t}))}function h(e,t,r,i=0){t-=i,r&&(t*=Math.SQRT2);const n=.5*t;return f(e,((t,s)=>{let o,a=t-.5*e,l=.5*e-s-1;if(r){const e=(a+l)/Math.SQRT2;l=(l-a)/Math.SQRT2,a=e}return a=Math.abs(a),l=Math.abs(l),o=a>l?a>n?Math.sqrt((a-n)*(a-n)+l*l):l:l>n?Math.sqrt(a*a+(l-n)*(l-n)):a,o-=i/2,o}))}function u(e,t,r){return(i,n)=>{const s=i-e,o=n-t;return Math.sqrt(s*s+o*o)-r}}function p(e,t,r){const i=Math.sqrt(t*t+r*r);return(n,s)=>{const o=Math.abs(n-e)-r,a=s-e+t/2+.75,l=(t*o+r*a)/i,c=-a;return Math.max(l,c)}}function f(e,t){const r=new Uint8Array(4*e*e);for(let n=0;n<e;n++)for(let s=0;s<e;s++){const o=s+e*n;let a=t(s,n);a=a/e+.5,(0,i.U)(a,r,4*o)}return r}},86652:(e,t,r)=>{r.d(t,{A:()=>c,C:()=>l});var i=r(88133),n=r(75644),s=r(30544),o=r(5822),a=r(62187);function l(e,t,r,i){const a="polygon"===e.type?s.Wq.CCW_IS_HOLE:s.Wq.NONE,l="polygon"===e.type?e.rings:e.paths,{position:c,outlines:h}=(0,s.jp)(l,!!e.hasZ,a,e.spatialReference),u=(0,n.jh)(c.length),p=(0,o.au)(c,e.spatialReference,0,u,0,c,0,c.length/3,t,r,i),f=null!=p;return{lines:f?d(h,c,u):[],projectionSuccess:f,sampledElevation:p}}function c(e,t){const r="polygon"===e.type?s.Wq.CCW_IS_HOLE:s.Wq.NONE,n="polygon"===e.type?e.rings:e.paths,{position:o,outlines:l}=(0,s.jp)(n,!1,r),c=(0,i.projectBuffer)(o,e.spatialReference,0,o,t,0,o.length/3);for(let e=2;e<o.length;e+=3)o[e]=a.bi;return{lines:c?d(l,o):[],projectionSuccess:c}}function d(e,t,r=null){const i=new Array;for(const{index:s,count:o}of e){if(o<=1)continue;const e=3*s,a=3*o;i.push({position:(0,n.l5)(t,3*s,3*o),mapPositions:null!=r?(0,n.l5)(r,e,a):void 0})}return i}},62187:(e,t,r)=>{r.d(t,{bi:()=>ar});var i,n,s=r(82392),o=r(57888),a=r(80294),l=r(57725),c=r(41785),d=r(61985),h=r(98592),u=r(81482),p=r(6273),f=r(80861),g=(r(67498),r(26325)),m=r(25336),_=r(80347),v=r(19913),y=r(84456),O=r(161),T=r(31882),w=r(68986),b=r(2532),C=r(96024);class S{constructor(){this._extent=(0,b.vt)(),this.resolution=0,this.renderLocalOrigin=(0,C.f)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new A}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,b.cY)(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,b.cY)(this._extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,b.C)(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class A{constructor(){this.extents=[(0,b.vt)(),(0,b.vt)(),(0,b.vt)()],this.numViews=0}}(n=i||(i={}))[n.Color=0]="Color",n[n.ColorNoRasterImage=1]="ColorNoRasterImage",n[n.Highlight=2]="Highlight",n[n.WaterNormal=3]="WaterNormal",n[n.Occluded=4]="Occluded",n[n.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor";class x{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){return null!=this._handle?.getTexture()}dispose(){this._handle=(0,l.Gz)(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,t,r){this._handle&&this._handle.fbo.width===t&&this._handle.fbo.height===r||(this._handle?.release(),this._handle=this._fbos.acquire(t,r,this._name,this._format)),e.unbindTexture(this._handle?.fbo.colorTexture),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}}var R=r(38236),E=r(77788);class D{constructor(e,t,r,i,n=R.N.RGBA_MIPMAP){this.output=r,this.content=i,this.fbo=new x(e,n,t)}get valid(){return this.fbo.valid}}class P{constructor(e){this.targets=[new D(e,"overlay color",E.V.Color,i.Color),new D(e,"overlay IM color",E.V.Color,i.ColorNoRasterImage),new D(e,"overlay highlight",E.V.Highlight,i.Highlight,R.N.RGBA4),new D(e,"overlay water",E.V.Normal,i.WaterNormal),new D(e,"overlay occluded",E.V.Color,i.Occluded)],(0,p.A)("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new D(e,"overlay oid",E.V.ObjectAndLayerIdColor,i.ObjectAndLayerIdColor))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,r)=>t.valid?e|=1<<r:e),0)}}var M,I,N=r(76982),F=r(83143);F.Zo,(I=M||(M={}))[I.Material=0]="Material",I[I.ShadowMap=1]="ShadowMap",I[I.Highlight=2]="Highlight",r(40574),r(35212),r(25853);var L,z,H=r(7804);r(34088),H.n,r(19635),r(41014),r(19778),(z=L||(L={}))[z.Disabled=0]="Disabled",z[z.Enabled=1]="Enabled",z[z.EnabledWithWater=2]="EnabledWithWater",z[z.COUNT=3]="COUNT",H.n,(0,N.vt)();var V=r(30607),j=r(13926),B=r(51662);class U{constructor(e){this._context=e,this._perConstructorInstances=new j.O,this._frameCounter=0,this._keepAliveFrameCount=G}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=k){const r=t.key;let i=this._perConstructorInstances.get(e,r);if(null==i){const n=new e(this._context,t,(()=>this.release(n)));i=new W(n),this._perConstructorInstances.set(e,r,i)}return++i.refCount,i.technique}releaseAndAcquire(e,t,r){if(null!=r){if(t.key===r.key)return r;this.release(r)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==G&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,r)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,r))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{e.push((async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,r))})),await Promise.all(e)}}class W{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const G=-1,k=new B.K;var Z=r(45845),q=r(75526),$=r(26421);class Y{constructor(e,t,r,i){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new j.O}dispose(){this._textureRepository.destroy()}acquire(e,t,r){this._ownMaterial(e);const i=e.produces.get(t);if(!i||!i(r))return null;let n=this._id2glMaterialRef.get(r,e.id);if(null==n){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRepository:this._textureRepository,output:r});n=new X(t),this._id2glMaterialRef.set(r,e.id,n)}return n.ref(),n.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);null!=r&&(r.unref(),r.referenced||((0,l.WD)(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&f.A.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class X{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,(0,$.vA)(this._refCnt>=0)}get referenced(){return this._refCnt>0}}var Q=r(45072),J=r(31272),K=(r(67900),r(26110)),ee=r(56560),te=r(99164),re=r(86316),ie=r(43793),ne=r(65630),se=r(10875),oe=r(15449),ae=r(7782),le=r(4477);class ce{constructor(e,t){this.shadowMap=e,this.slicePlane=t,this.slot=oe.N.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=ae.y.NONE,this.alignPixelEnabled=!1,this.decorations=se.ID.ON,this.overlayStretch=1,this._camera=new q.i,this._inverseViewport=(0,ee.vt)(),this.oldLighting=new le.TA,this.newLighting=new le.TA,this._fadedLighting=new le.TA,this._lighting=this.newLighting,this.ssr=new de,this.multipassEnabled=!1,this.multipassTerrain=new ne.h,this.multipassGeometry=new ie.U,this.hudRenderStyle=re.D.Occluded,this.cloudsFade=new te.ny}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:r}=this;e>=1?this._lighting=r:(this._fadedLighting.lerpLighting(t,r,e),this._lighting=this._fadedLighting)}}class de{constructor(){this.fadeFactor=1,this.reprojectionMatrix=(0,K.vt)()}}class he{constructor(e,t,r=null){this.rctx=e,this.sliceHelper=r,this.lastFrameCamera=new q.i,this.output=E.V.Color,this.renderOccludedMask=ue,this.bindParameters=new ce(t,null!=r?r.plane:null),this.bindParameters.alignPixelEnabled=!0}}const ue=J.m$.Occlude|J.m$.OccludeAndTransparent|J.m$.OccludeAndTransparentStencil;var pe=r(4506),fe=r(79441),ge=r(53334),me=r(74772);let _e=class extends q.i{constructor(){super(...arguments),this._projectionMatrix=(0,K.vt)()}get projectionMatrix(){return this._projectionMatrix}};(0,s._)([(0,u.MZ)()],_e.prototype,"_projectionMatrix",void 0),(0,s._)([(0,u.MZ)({readOnly:!0})],_e.prototype,"projectionMatrix",null),_e=(0,s._)([(0,g.$)("esri.views.3d.webgl-engine.lib.CascadeCamera")],_e);var ve,ye=r(80605),Oe=r(68716),Te=r(89958);!function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"}(ve||(ve={}));class we{constructor(){this.camera=new _e,this.lightMat=(0,K.vt)()}}class be{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class Ce{constructor(e,t){this._fbos=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new be,this._projectionView=(0,K.vt)(),this._projectionViewInverse=(0,K.vt)(),this._modelViewLight=(0,K.vt)(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,N.vt)(),this._cascades=[new we,new we,new we,new we],this._lastOrigin=null,this._maxTextureWidth=Math.min((0,p.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return(0,me.s)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=(0,l.Gz)(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=(0,pe.qE)(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)Ne[e]=this._cascades[e];return Ne.length=this._numCascades,Ne}start(e,t,r,i,n){(0,$.vA)(this.enabled);const{near:s,far:o}=this._clampNearFar(r);this._computeCascadeDistances(s,o,i),this._textureHeight=this._computeTextureHeight(e,n,i),this._setupMatrices(e,t);const{viewMatrix:a,projectionMatrix:l}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,l,a,t);this._lastOrigin=null,this.clear()}finish(){(0,$.vA)(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!(0,_.j)(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,v.vt)(),(0,_.c)(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){(0,m.Tl)(Fe,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)Le[16*t+e]=Fe[e]}}return Le}moveSnapshot(e){(0,$.vA)(this.enabled),this._handle?.detachDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){const t=this._handle?.getTexture()?.descriptor;if(!this.enabled||!t)return;this._snapshots[e]?.release();const{width:r,height:i}=t,n=e===ve.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(r,i,n,R.N.RGBA4);const s=this._fbos.rctx;this._bindFbo();const o=s.bindTexture(this._snapshots[e]?.getTexture(),Te.g.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(Oe.Ap.TEXTURE_2D,0,0,0,0,0,r,i),s.bindTexture(o,Te.g.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture():null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Oe.hn.COLOR_BUFFER_BIT|Oe.hn.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,t,r){const i=Math.min(window.devicePixelRatio,t)/e.pixelRatio,n=r?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,s=(0,ye.Mv)(Math.floor(Math.max(e.fullWidth,e.fullHeight)*i*n)),o=Math.min(this._maxTextureWidth,this._numCascades*s);return(0,ye.uT)(o/this._numCascades)}_ensureFbo(){this._handle?.fbo.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",R.N.RGBA4)),this._handle?.acquireDepth(R.z.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=(0,l.Gz)(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,r,i){const n=this._cascades[e],s=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],a=(t[10]*s+t[14])/Math.abs(t[11]*s+t[15]),l=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);(0,$.vA)(a<l);for(let e=0;e<8;++e){(0,me.s)(Ae,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?a:l,1);const t=xe[e];(0,me.t)(t,Ae,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}(0,_.F)(Ie,xe[0]),n.camera.viewMatrix=(0,m.Tl)(Se,this._modelViewLight,Ie);for(let e=0;e<8;++e)(0,_.e)(xe[e],xe[e],n.camera.viewMatrix);let c=xe[0][2],d=xe[0][2];for(let e=1;e<8;++e)c=Math.min(c,xe[e][2]),d=Math.max(d,xe[e][2]);c-=200,d+=200,n.camera.near=-d,n.camera.far=-c,function(e,t,r,i,n){const s=1/xe[0][3],o=1/xe[4][3];(0,$.vA)(s<o);let a=s+Math.sqrt(s*o);const l=Math.sin((0,pe.XM)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));a/=l,function(e,t,r,i,n,s,o,a){(0,ge.hZ)(ze,0,0);for(let t=0;t<4;++t)(0,ge.WQ)(ze,ze,e[t]);(0,ge.hs)(ze,ze,.25),(0,ge.hZ)(He,0,0);for(let t=4;t<8;++t)(0,ge.WQ)(He,He,e[t]);(0,ge.hs)(He,He,.25),(0,ge.Cc)(Ve[0],e[4],e[5],.5),(0,ge.Cc)(Ve[1],e[5],e[6],.5),(0,ge.Cc)(Ve[2],e[6],e[7],.5),(0,ge.Cc)(Ve[3],e[7],e[4],.5);let l=0,c=(0,ge.hG)(Ve[0],ze);for(let e=1;e<4;++e){const t=(0,ge.hG)(Ve[e],ze);t<c&&(c=t,l=e)}(0,ge.Re)(je,Ve[l],e[l+4]);const d=je[0];let h,u;je[0]=-je[1],je[1]=d,(0,ge.Re)(Be,He,ze),(0,ge.Om)(Be,je)<0&&(0,ge.ze)(je,je),(0,ge.Cc)(je,je,Be,r),(0,ge.S8)(je,je),h=u=(0,ge.Om)((0,ge.Re)(Ue,e[0],ze),je);for(let t=1;t<8;++t){const r=(0,ge.Om)((0,ge.Re)(Ue,e[t],ze),je);r<h?h=r:r>u&&(u=r)}(0,ge.C)(i,ze),(0,ge.hs)(Ue,je,h-t),(0,ge.WQ)(i,i,Ue);let p=-1,f=1,g=0,m=0;for(let t=0;t<8;++t){(0,ge.Re)(We,e[t],i),(0,ge.S8)(We,We);const r=je[0]*We[1]-je[1]*We[0];r>0?r>p&&(p=r,g=t):r<f&&(f=r,m=t)}(0,$.MX)(p>0,"leftArea"),(0,$.MX)(f<0,"rightArea"),(0,ge.hs)(Ge,je,h),(0,ge.WQ)(Ge,Ge,ze),(0,ge.hs)(ke,je,u),(0,ge.WQ)(ke,ke,ze),Ze[0]=-je[1],Ze[1]=je[0];const _=(0,$.L)(i,e[m],ke,(0,ge.WQ)(Ue,ke,Ze),1,n),v=(0,$.L)(i,e[g],ke,Ue,1,s),y=(0,$.L)(i,e[g],Ge,(0,ge.WQ)(Ue,Ge,Ze),1,o),O=(0,$.L)(i,e[m],Ge,Ue,1,a);(0,$.MX)(_,"rayRay"),(0,$.MX)(v,"rayRay"),(0,$.MX)(y,"rayRay"),(0,$.MX)(O,"rayRay")}(xe,a,l,Re,Ee,De,Pe,Me),function(e,t,r,i,n){(0,ge.Re)(Xe,r,i),(0,ge.hs)(Xe,Xe,.5),Qe[0]=Xe[0],Qe[1]=Xe[1],Qe[2]=0,Qe[3]=Xe[1],Qe[4]=-Xe[0],Qe[5]=0,Qe[6]=Xe[0]*Xe[0]+Xe[1]*Xe[1],Qe[7]=Xe[0]*Xe[1]-Xe[1]*Xe[0],Qe[8]=1,Qe[qe(0,2)]=-(0,ge.Om)(Ye(Qe,0),e),Qe[qe(1,2)]=-(0,ge.Om)(Ye(Qe,1),e);let s=(0,ge.Om)(Ye(Qe,0),r)+Qe[qe(0,2)],o=(0,ge.Om)(Ye(Qe,1),r)+Qe[qe(1,2)],a=(0,ge.Om)(Ye(Qe,0),i)+Qe[qe(0,2)],l=(0,ge.Om)(Ye(Qe,1),i)+Qe[qe(1,2)];s=-(s+a)/(o+l),Qe[qe(0,0)]+=Qe[qe(1,0)]*s,Qe[qe(0,1)]+=Qe[qe(1,1)]*s,Qe[qe(0,2)]+=Qe[qe(1,2)]*s,s=1/((0,ge.Om)(Ye(Qe,0),r)+Qe[qe(0,2)]),o=1/((0,ge.Om)(Ye(Qe,1),r)+Qe[qe(1,2)]),Qe[qe(0,0)]*=s,Qe[qe(0,1)]*=s,Qe[qe(0,2)]*=s,Qe[qe(1,0)]*=o,Qe[qe(1,1)]*=o,Qe[qe(1,2)]*=o,Qe[qe(2,0)]=Qe[qe(1,0)],Qe[qe(2,1)]=Qe[qe(1,1)],Qe[qe(2,2)]=Qe[qe(1,2)],Qe[qe(1,2)]+=1,s=(0,ge.Om)(Ye(Qe,1),t)+Qe[qe(1,2)],o=(0,ge.Om)(Ye(Qe,2),t)+Qe[qe(2,2)],a=(0,ge.Om)(Ye(Qe,1),r)+Qe[qe(1,2)],l=(0,ge.Om)(Ye(Qe,2),r)+Qe[qe(2,2)],s=-.5*(s/o+a/l),Qe[qe(1,0)]+=Qe[qe(2,0)]*s,Qe[qe(1,1)]+=Qe[qe(2,1)]*s,Qe[qe(1,2)]+=Qe[qe(2,2)]*s,s=(0,ge.Om)(Ye(Qe,1),t)+Qe[qe(1,2)],o=(0,ge.Om)(Ye(Qe,2),t)+Qe[qe(2,2)],a=-o/s,Qe[qe(1,0)]*=a,Qe[qe(1,1)]*=a,Qe[qe(1,2)]*=a,n[0]=Qe[0],n[1]=Qe[1],n[2]=0,n[3]=Qe[2],n[4]=Qe[3],n[5]=Qe[4],n[6]=0,n[7]=Qe[5],n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=Qe[6],n[13]=Qe[7],n[14]=0,n[15]=Qe[8]}(Re,Ee,Pe,Me,n.projectionMatrix),n.projectionMatrix[10]=2/(r-i),n.projectionMatrix[14]=-(r+i)/(r-i)}(r,i,c,d,n.camera),(0,m.lw)(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const h=this._textureHeight;n.camera.viewport=[e*h,0,h,h]}_setupMatrices(e,t){(0,m.lw)(this._projectionView,e.projectionMatrix,e.viewMatrix),(0,m.B8)(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===y.RT.Global?e.eye:(0,_.s)(Ie,0,0,1);(0,m.t5)(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_clampNearFar(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}_computeCascadeDistances(e,t,r){const i=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor((0,$.kL)(t/e,4)),i);const n=(t-e)/this._numCascades,s=(t/e)**(1/this._numCascades);let o=e,a=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=(0,pe.Cc)(o,a,this.settings.splitSchemeLambda),o*=s,a+=n}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const Se=(0,K.vt)(),Ae=(0,N.vt)(),xe=[];for(let e=0;e<8;++e)xe.push((0,N.vt)());const Re=(0,ee.vt)(),Ee=(0,ee.vt)(),De=(0,ee.vt)(),Pe=(0,ee.vt)(),Me=(0,ee.vt)(),Ie=(0,v.vt)(),Ne=[],Fe=(0,K.vt)(),Le=K.zK.concat(K.zK,K.zK,K.zK,K.zK),ze=(0,ee.vt)(),He=(0,ee.vt)(),Ve=[(0,ee.vt)(),(0,ee.vt)(),(0,ee.vt)(),(0,ee.vt)()],je=(0,ee.vt)(),Be=(0,ee.vt)(),Ue=(0,ee.vt)(),We=(0,ee.vt)(),Ge=(0,ee.vt)(),ke=(0,ee.vt)(),Ze=(0,ee.vt)();function qe(e,t){return 3*t+e}const $e=(0,ee.vt)();function Ye(e,t){return(0,ge.hZ)($e,e[t],e[t+3]),$e}const Xe=(0,ee.vt)(),Qe=(0,fe.vt)();var Je=r(73783),Ke=r(69891),et=r(30165),tt=r(76388);r(2680);class rt extends tt.R6{constructor(e,t,r){super(e,t),this.triangleNr=r}}class it{constructor(){this.adds=new c.A,this.removes=new c.A,this.updates=new c.A({allocator:e=>e||new nt,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class nt{}class st{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var ot,at=r(57809),lt=r(80561);function ct(e){return e.geometry.indexCount>=1}!function(e){e[e.Default=0]="Default",e[e.Screenshot=1]="Screenshot",e[e.ObjectAndLayerID=2]="ObjectAndLayerID"}(ot||(ot={}));var dt=r(3223),ht=r(29386),ut=r(4330);class pt extends F.gy{constructor(e=(0,v.vt)()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}class ft{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function gt(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;){r=!1;for(let i=0;i<e.length;++i){const n=e.data[i],s=t.get(n.to);if(!s)return;n.to=s.to,t.delete(s.from),e.removeUnordered(s),r=!0}}}class mt extends ft{constructor(e,t,r){super(t,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class _t{constructor(){this.first=0,this.count=0}}class vt{constructor(){this._numElements=0,this._instances=new Map,this.holes=new c.A({allocator:e=>e||new ft,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=yt(),this.drawCommandsHighlight=yt(),this.drawCommandsOccludees=yt(),this.drawCommandsShadowHighlightRest=yt()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,r){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,i.from=t,i.to=r,this._numElements+=i.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),r=this.holes.front();return null!=this.vao&&1===this.holes.length&&r.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=r.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const e of t)e.isVisible&&(Ot(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e),Ot(e.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,e))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function yt(){return new c.A({allocator:e=>e||new _t,deallocator:e=>e})}function Ot(e,t){const r=e.back();if(null==r){const r=e.pushNew();return r.first=t.from,void(r.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(r,t)){const e=t.from-r.first+t.numElements;r.count=e}else{const r=e.pushNew();r.first=t.from,r.count=t.numElements}}class Tt{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}var wt=r(48156);class bt{constructor(e,t){this._cache=e(t,((e,t,r)=>this._remove(e,t,r)))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const r=t.pop();if(t.length>0){if(r){const i=this._cache.getSize(e)-Math.round(r.usedMemory);this._cache.updateSize(e,t,i)}}else this._cache.pop(e);return r}put(e,t,r=wt.Cn){const i=this._cache.peek(e);if(!i)return void this._cache.put(e,[t],t.usedMemory,r);i.push(t);const n=this._cache.getSize(e)+Math.round(t.usedMemory);this._cache.updateSize(e,i,n)}_remove(e,t,r){switch(t){case wt.k2.ALL:return e.forEach((e=>e.dispose())),0;case wt.k2.SOME:{const t=e.shift();return t&&(r-=Math.round(t.usedMemory),t.dispose()),r}}}}var Ct=r(5801),St=r(89325);class At{constructor(e,t,r){this._rctx=e,this._locations=t,this._layout=r,this._cache=new bt(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let r=this._cache.pop(t);return r||(r=new Ct.Z(this._rctx,this._locations,{geometry:this._layout},{geometry:St.g.createVertex(this._rctx,Oe._U.STATIC_DRAW)}),r.vertexBuffers.geometry.setSize(e),r)}deleteVao(e){if(null==e)return;const t=e.byteSize.toString();this._cache.put(t,e)}}let xt=class extends Z.Ot{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=(0,l.WD)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=(0,l.WD)(this._vaoCache)}initialize(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==E.V.Highlight&&t!==E.V.ShadowHighlight||this._hasHighlights))&&e(t)))}))}get produces(){return this._produces}initializeRenderContext(e,t){const{rctx:r}=e.renderContext;this._glMaterials=new ut.c(this.material,t??e.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new At(r,this.material.vertexAttributeLocations,(0,ht.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get materialReference(){return this.material}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const r=t.vertexBufferLayout.stride/4;for(const i of e){const e=i.renderGeometry,n=this._dataByOrigin.get(e.localOrigin.id),s=n?.findBuffer(e.id);if(null==s)return;const o=s.instances.get(e.id);if(i.updateType&(lt.k.GEOMETRY|lt.k.TRANSFORMATION)){const i=jt(t.elementCount(o.geometry.geometry)*r),n=t.vertexBufferLayout.createView(i.buffer);this._writeGeometry(e,n,0),s.vao.vertexBuffers.geometry.setSubData(i,o.from*r,0,o.numElements*r)}i.updateType&(lt.k.HIGHLIGHT|lt.k.OCCLUDEE|lt.k.VISIBILITY)&&(s.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new j.O;for(const t of e){const e=t.localOrigin;if(null==e)continue;let i=r.get(e.id,null);null==i&&(i=new Rt(e.vec3),r.set(e.id,null,i)),i.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const i=this._dataByOrigin.get(t.id),n=i?.findBuffer(e.id);if(null==n)continue;let s=r.get(t.id,n);null==s&&(s=new Rt(t.vec3),r.set(t.id,n,s)),s.changes.push(e)}return r}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:r,_dataByOrigin:i}=this,n=r.vertexBufferLayout.stride/4,s=this._computeDeltas(e,t);s.forEach(((e,t)=>{const o=e.get(null),a=null!=o?o.changes:[];s.delete(t,null);let l=i.get(t);if(e.forEach(((e,o)=>{if(s.delete(t,o),null==o)return void(0,$.vA)(!1,"No VAO for removed geometries");if(o.instances.size===e.changes.length)return this._vaoCache.deleteVao(o.vao),(0,dt.Xy)(l.buffers,o),void(0===l.buffers.length&&0===a.length&&i.delete(t));const c=o.numElements,d=o.vao.byteSize/4,h=a.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),u=e.changes.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),p=Math.min((c+h-u)*n,Ht),f=p>d;p>Nt&&p<d/2?(e.changes.forEach((({id:e})=>o.deleteInstance(e))),o.instances.forEach((({geometry:e})=>a.push(e))),this._vaoCache.deleteVao(o.vao),(0,dt.Xy)(l.buffers,o)):f?this._applyAndRebuild(o,a,e):this._applyRemoves(o,e)})),a.length>0)for(null==l&&(l=new Tt(o.origin),i.set(t,l)),l.buffers.forEach((e=>this._applyAdds(e,a)));a.length>0;)l.buffers.push(this._applyAndRebuild(new vt,a,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,a.Bs)(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,r){if(null!=r)for(const t of r.changes)e.deleteInstance(t.id);const i=this._bufferWriter,n=i.vertexBufferLayout.stride,s=n/4,o=Math.floor(Ht/s);let a=e.numElements;for(;t.length>0;){const r=t.pop(),n=i.elementCount(r.geometry);if(a+n>o&&a>0){t.push(r);break}a+=n;const s=new mt(r,0,0);(0,$.vA)(null==e.instances.get(r.id)),e.addInstance(r.id,s)}const l=a*s,c=jt(l),d=i.vertexBufferLayout.createView(c.buffer);let h=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,d,h);const n=h;h+=i.elementCount(t.geometry.geometry),e.updateInstance(r,n,h),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Bt(l)),e.vao.vertexBuffers.geometry.setSubData(c,0,0,h*s),e.holes.clear();const u=e.holes.pushNew();return u.from=h,u.to=Math.floor(e.vao.byteSize/n),e.updateDrawCommands(n),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const r of t.changes){const t=r.id,i=e.instances.get(t);if(!i)continue;e.deleteInstance(t);const n=It.back();if(n){if(n.to===i.from){n.to=i.to;continue}if(n.from===i.to){n.from=i.from;continue}}const s=It.pushNew();s.from=i.from,s.to=i.to}gt(It);const r=this._bufferWriter.vertexBufferLayout.stride/4,i=It.reduce(((e,t)=>Math.max(e,t.numElements)),0)*r,n=jt(i);n.fill(0,0,i);const s=e.vao.vertexBuffers.geometry;It.forAll((e=>s.setSubData(n,e.from*r,0,e.numElements*r))),e.holes.pushArray(It.data,It.length),It.forAll(((e,t)=>It.data[t]=null)),It.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,n=e.numElements,s=t.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),o=Math.min((n+s)*i,Ht),a=4*o;if(e.vao.byteSize<Bt(Ht-Nt)&&a>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);gt(e.holes);const l=new Array;for(const i of t){const t=r.elementCount(i.geometry),n=Et(e.holes,t);l.push(n)}const c=e.vao.vertexBuffers.geometry;let d=0,h=0,u=0;const p=jt(o),f=r.vertexBufferLayout.createView(p.buffer);t.forEach(((t,n)=>{const s=l[n];if(null==s)return;if(u!==s){const e=u-h;e>0&&c.setSubData(p,h*i,0,e*i),h=s,d=0}const o=r.elementCount(t.geometry);this._writeGeometry(t,f,d),d+=o,u=s+o;const a=new mt(t,s,s+o);(0,$.vA)(null==e.instances.get(t.id)),e.addInstance(t.id,a),e.drawCommandsDirty=!0}));const g=u-h;g>0&&c.setSubData(p,h*i,0,g*i),(0,dt.$i)(t,((e,t)=>null==l[t]))}_writeGeometry(e,t,r){if(null===this._bufferWriter)return;const i=e.localOrigin.vec3;(0,$.M_)(Dt,-i[0],-i[1],-i[2]);const n=(0,m.lw)(Pt,Dt,e.transformation);(0,m.B8)(Mt,n),(0,m.mg)(Mt,Mt),this._bufferWriter.write(n,Mt,e.geometry,t,r)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:r}=e,i=this.material.produces.get(r.slot);if(!i||!i(t))return null;const n=t===E.V.Highlight||t===E.V.ShadowHighlight;if(n&&!this._hasHighlights)return null;const s=t===E.V.ShadowExcludeHighlight,o=!(n||s);for(const i of this._dataByOrigin.values())for(const a of i.buffers){if(n&&!a.hasHighlights)continue;const i=(n?a.drawCommandsHighlight:s&&a.needsMultipleCommands()?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault)||null,l=o&&a.drawCommandsOccludees||null;if(i?.length||l?.length){const i=this._glMaterials.load(e.rctx,r.slot,t),n=null!=i?i.beginSlot(r):null;if(null!=n)return n}}return null}renderNode(e,t){const{output:r,bindParameters:i}=e,n=r===E.V.Highlight||r===E.V.ShadowHighlight,s=r===E.V.ShadowExcludeHighlight,o=!(n||s),a=e.rctx,l=e.bindParameters.slot===oe.N.OCCLUDER_MATERIAL,c=e.bindParameters.slot===oe.N.TRANSPARENT_OCCLUDER_MATERIAL;a.runAppleAmdDriverHelper(),a.bindTechnique(t,i,this.material.parameters);for(const e of this._dataByOrigin.values())for(const r of e.buffers){if(n&&!r.hasHighlights)continue;const d=(n?r.drawCommandsHighlight:s&&r.needsMultipleCommands()?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null,h=o&&r.drawCommandsOccludees||null;(d?.length||h?.length)&&(t.program.bindDraw(new pt(e.origin),i,this.material.parameters),t.ensureAttributeLocations(r.vao),a.bindVAO(r.vao),d?.length&&(a.setPipelineState(t.getPipeline(!1,l,c)),d.forAll((e=>a.drawArrays(t.primitiveType,e.first,e.count)))),h?.length&&(a.setPipelineState(t.getPipeline(!0,l,c)),h.forAll((e=>a.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};(0,s._)([(0,u.MZ)({constructOnly:!0})],xt.prototype,"material",void 0),xt=(0,s._)([(0,g.$)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],xt);class Rt{constructor(e){this.origin=e,this.changes=new Array}}function Et(e,t){let r;if(!e.some((e=>!(e.numElements<t||(r=e,0)))))return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}const Dt=(0,K.vt)(),Pt=(0,K.vt)(),Mt=(0,K.vt)(),It=new c.A({allocator:e=>e||new ft,deallocator:null}),Nt=65536,Ft=4*Nt,Lt=1024,zt=16777216,Ht=zt/4;let Vt=new Float32Array(Nt);function jt(e){return Vt.length<e&&(Vt=new Float32Array(e)),Vt}function Bt(e){const t=4*e;return t<=Lt?Lt:t<Ft?(0,pe.cU)(t):Math.max(Math.min(Math.ceil(1.5*t/Ft)*Ft,zt),t)}let Ut=class extends Je.A{constructor(e){super(e),this._pending=new Wt,this._changes=new it,this._materialRenderers=new c.A,this._sortedMaterialRenderers=new c.A,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll((e=>e.destroy())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return this._materialRenderers.some((e=>0!==e.numGeometries&&!e.queryRenderOccludedState(J.m$.Occlude)))}get isEmpty(){return!this.updating&&0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(e){if(null==e)return 0;const t=this._materialRenderers.find((t=>t.materialReference===e));return t?.usedMemory??0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,r=e=>{let r=t.get(e);return r||(r=new st,t.set(e,r)),r};return e.removes.forAll((e=>{ct(e)&&r(e.material).removes.push(e)})),e.adds.forAll((e=>{ct(e)&&r(e.material).adds.push(e)})),e.updates.forAll((e=>{ct(e.renderGeometry)&&r(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1;return e.forEach(((e,r)=>{let i=this._materialRenderers.find((e=>e.materialReference===r));if(!i&&e.adds.length>0){const e=new xt({material:r});e.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),i=e,this._materialRenderers.push(i),t=!0}i&&(i.modify(e),0===i.numGeometries&&(this._materialRenderers.removeUnordered(i),i.destroy(),t=!0))})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),this._hasHighlights=this._materialRenderers.some((e=>{const t=e.produces.get(oe.N.DRAPED_MATERIAL);return!!t&&t(E.V.Highlight)})),this._hasWater=this._materialRenderers.some((e=>{const t=e.produces.get(oe.N.DRAPED_WATER);return!!t&&t(E.V.Normal)})),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const r=this._validateRenderGeometries(e);for(const e of r)this._geometries.set(e.id,e);const i=this._pending.empty;for(const e of r)this._pending.adds.add(e);i&&this.notifyChange("updating"),t===lt.q.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const r=this._pending.empty,i=this._pending.adds;for(const t of e)i.has(t)?(this._pending.removed.add(t),i.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);r&&!this._pending.empty&&this.notifyChange("updating"),t===lt.q.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(r),e.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case lt.k.TRANSFORMATION:case lt.k.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case lt.k.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((r=>t=!!r.updateAnimation&&r.updateAnimation(e)||t)),t}shouldRender(e){return this._sortedMaterialRenderers.some((t=>t.prepareTechnique(e)))}render(e){this._sortedMaterialRenderers.forAll((t=>{const r=t.prepareTechnique(e);null!=r&&t.renderNode(e,r)}))}intersect(e,t,r,i,n){return this._geometries.forEach((s=>{if(i&&!i(s))return;this._intersectRenderGeometry(s,r,t,0,e,n);const o=this.rendererContext.longitudeCyclical;o&&(s.boundingSphere[0]-s.boundingSphere[3]<o.min&&this._intersectRenderGeometry(s,r,t,o.range,e,n),s.boundingSphere[0]+s.boundingSphere[3]>o.max&&this._intersectRenderGeometry(s,r,t,-o.range,e,n)),n++})),n}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll(((e,t)=>{e.drapedPriority=t,this._sortedMaterialRenderers.push(e)})),this._sortedMaterialRenderers.sort(((e,t)=>t.materialReference?.renderPriority===e.materialReference?.renderPriority?e.drapedPriority-t.drapedPriority:(t.materialReference?.renderPriority||0)-(e.materialReference?.renderPriority||0)))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,r,i,n,s){if(!e.visible)return;let o=0;i+=e.transformation[12],o=e.transformation[13],Gt[0]=r[0]-i,Gt[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,n,Gt,((r,i,o)=>{!function(e,t,r,i,n,s,o){const a=new rt(s,o,t),l=t=>{t.set(et.dz.OVERLAY,a,e.dist,e.normal,e.transformation,r,i)};if((null==n.results.min.drapedLayerOrder||r>=n.results.min.drapedLayerOrder)&&(null==n.results.min.dist||n.results.ground.dist<=n.results.min.dist)&&l(n.results.min),n.options.store!==et.oH.MIN&&(null==n.results.max.drapedLayerOrder||r<n.results.max.drapedLayerOrder)&&(null==n.results.max.dist||n.results.ground.dist>n.results.max.dist)&&l(n.results.max),n.options.store===et.oH.ALL){const e=(0,at.G7)(n.ray);l(e),n.results.all.push(e)}}(t,o,s,e.material.renderPriority,n,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const r of e){const e=r.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const r of e){const e=r.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin((0,Ke.g)(e.boundingSphere))),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,s._)([(0,u.MZ)()],Ut.prototype,"drapeSource",void 0),(0,s._)([(0,u.MZ)()],Ut.prototype,"updating",null),(0,s._)([(0,u.MZ)()],Ut.prototype,"rctx",null),(0,s._)([(0,u.MZ)({constructOnly:!0})],Ut.prototype,"rendererContext",void 0),(0,s._)([(0,u.MZ)()],Ut.prototype,"_materialRepository",null),(0,s._)([(0,u.MZ)()],Ut.prototype,"_localOriginFactory",null),(0,s._)([(0,u.MZ)({readOnly:!0})],Ut.prototype,"isEmpty",null),(0,s._)([(0,u.MZ)()],Ut.prototype,"_materialRenderers",void 0),(0,s._)([(0,u.MZ)()],Ut.prototype,"_geometries",void 0),Ut=(0,s._)([(0,g.$)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Ut);class Wt{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const Gt=(0,ee.vt)();var kt=r(21979),Zt=r(19362),qt=r(74242),$t=r(24441),Yt=r(15651);class Xt extends Zt.w{initializeProgram(e){return new $t.B(e.rctx,Xt.shader.get().build(),qt.D)}initializePipeline(){return this.configuration.hasAlpha?(0,Yt.Ey)({blending:(0,Yt.p3)(Oe.dn.SRC_ALPHA,Oe.dn.ONE,Oe.dn.ONE_MINUS_SRC_ALPHA,Oe.dn.ONE_MINUS_SRC_ALPHA),colorWrite:Yt.wE}):(0,Yt.Ey)({colorWrite:Yt.wE})}}Xt.shader=new kt.$(V.a,(()=>r.e(5510).then(r.bind(r,5510))));class Qt extends B.K{constructor(){super(...arguments),this.hasAlpha=!1}}(0,s._)([(0,B.W)()],Qt.prototype,"hasAlpha",void 0);var Jt=r(34402),Kt=r(50162),er=r(58062);class tr extends Zt.w{initializeProgram(e){return new $t.B(e.rctx,tr.shader.get().build(),qt.D)}initializePipeline(){return(0,Yt.Ey)({blending:(0,Yt.ox)(Oe.dn.ONE,Oe.dn.ONE_MINUS_SRC_ALPHA),colorWrite:Yt.wE})}}tr.shader=new kt.$(er.a,(()=>r.e(6174).then(r.bind(r,76174))));var rr=r(49437),ir=r(88416);let nr=class extends Z.RW{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new er.O,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new c.A,this._passParameters=new V.T,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new q.i,this.worldToPCSRatio=1,this.events=new o.A,this.longitudeCyclical=null,this.produces=new Map([[oe.N.DRAPED_MATERIAL,e=>e!==E.V.Highlight||this.hasHighlights],[oe.N.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,t=this.view._stage.renderView,{waterTextures:r,stippleTextures:i,markerTextures:n}=t;this._shaderTechniques=new U({rctx:this._rctx,viewingMode:y.RT.Local,stippleTextureRepository:i,markerTextureRepository:n,waterTextureRepository:r}),this._renderContext=new he(this._rctx,new Ce(e,this.view.state.viewingMode),null),this.addHandles([(0,d.wB)((()=>r.updating),(()=>this.events.emit("content-changed")),d.pc),(0,d.wB)((()=>this.spatialReference),(e=>this._localOriginFactory=new Q.g(e)),d.pc),(0,d.on)((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new Y(t.textureRepository,this._shaderTechniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=oe.N.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=ae.y.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new Kt.$p((0,v.fA)(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(rr.W6.STAGE,this))}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=(0,l.Gz)(this._debugTextureTechnique),this._passParameters.texture=(0,l.WD)(this._passParameters.texture),this._shaderTechniques=(0,l.pR)(this._shaderTechniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||(0,a.Bs)(this._renderers,(e=>e.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMemoryForMaterial(e){return Array.from(this._renderers.values()).reduce(((t,r)=>t+r.getMemoryForMaterial(e)),0)}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Ut)}createDrapeSourceRenderer(e,t,r){const i=this._renderers.get(e);null!=i&&i.destroy();const n=new t({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,n),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles((0,d.wB)((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),n}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&(0,h.bw)(e,(e=>e.drapeTargetType===O.sv.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=(0,h.bw)(e,(e=>e.drapeSourceType===O.Om.Features)),this._hasDrapedRasterSource=(0,h.bw)(e,(e=>e.drapeSourceType===O.Om.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new P(this.view._stage.renderer.fboCache),this._overlays=[new S,new S]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=(0,l.WD)(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){if(null!=e)return e===i.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(i.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let r=!1;for(const[i,n]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&n.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=(0,a.Bs)(this._renderers,(e=>e.hasHighlights)),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(rr.Bb,(e=>e.updatePolicy===Jt.q.SYNC))}get isEmpty(){return!T.b.OVERLAY_DRAW_DEBUG_TEXTURE&&!(0,a.Bs)(this._renderers,(e=>!e.isEmpty))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=lr;const t=this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext)));return this._renderContext.renderOccludedMask=e,t}renders(e){return T.b.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==i.Occluded||this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext)))}get mode(){return this.isEmpty?L.Disabled:this._renderTargets?.getTexture(i.WaterNormal)?L.EnabledWithWater:this._renderTargets?.getTexture(i.Color)?L.Enabled:L.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((r=>t=r.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(const t of this._renderTargets.targets){if(t.content===i.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(w.vr.INNER,t,e),n=this._drawTarget(w.vr.OUTER,t,e);(r||n)&&t.fbo.generateMipMap()}}}_drawTarget(e,t,r){const n=this._overlays[e],s=n.canvasGeometries;if(0===s.numViews)return!1;const{alignPixelEnabled:o,contentPixelRatio:a}=r;this._screenToWorldRatio=a*n.mapUnitsPerPixel/this._bindParameters.overlayStretch;const l=t.output;if(this.isEmpty||l===E.V.Highlight&&!this.hasHighlights||l===E.V.Normal&&!this.hasWater||!n.hasSomeSizedView())return!1;const c=this._rctx;if(this._camera.pixelRatio=n.pixelRatio*a,this._renderContext.output=l,this._bindParameters.alignPixelEnabled=o,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=l===E.V.Normal?oe.N.DRAPED_WATER:oe.N.DRAPED_MATERIAL,t.content===i.Occluded&&(this._renderContext.renderOccludedMask=lr),!this.renders(t.content))return this._renderContext.renderOccludedMask=ue,!1;const d=n.resolution;this._rctx.setViewport(e===w.vr.INNER?0:d,0,d,d);const h=2*n.resolution,u=n.resolution,p=t.fbo;if(p.bind(c,h,u),e===w.vr.INNER&&(c.setClearColor(0,0,0,0),c.clearSafe(Oe.hn.COLOR_BUFFER_BIT)),T.b.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==i.Occluded)for(let t=0;t<s.numViews;t++)this._setViewParameters(s.extents[t],n),this._ensureDebugPatternResources(n.resolution,or[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll((({drapeSource:r,renderer:o})=>{if(t.content===i.ColorNoRasterImage&&r.drapeSourceType===O.Om.RasterImage)return;const{fullOpacity:a}=r,d=null!=a&&a<1&&l===E.V.Color?this.bindTemporaryFramebuffer(h,u):null;for(let e=0;e<s.numViews;e++)this._setViewParameters(s.extents[e],n),o.render(this._renderContext);if(d){p.bind(c,h,u),this._overlayParameters.texture=d.getTexture(),this._overlayParameters.opacity=a,this._overlayParameters.overlayIndex=e;const t=this.pluginContext.techniqueRepository.acquire(tr);this._rctx.bindTechnique(t,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),t.release(),d.release()}})),c.bindFramebuffer(null),this._renderContext.renderOccludedMask=ue,!0}bindTemporaryFramebuffer(e,t){const r=this.view._stage.renderer.fboCache,i=r.acquire(e,t,"overlay tmp");return r.rctx.unbindTexture(i.fbo.colorTexture),r.rctx.bindFramebuffer(i.fbo),r.rctx.clearSafe(Oe.hn.COLOR_BUFFER_BIT),i}async reloadShaders(){await this._shaderTechniques.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let n=0;for(const{renderer:s}of this._sortedRenderers)n=s.intersect?.(e,t,r,i,n)??n}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers,t=e.length;this._renderers.forEach(((r,i)=>{const n=e.indexOf(i.layer),s=n>=0,o=i.renderGroup??(s?O.O7.MapLayer:O.O7.ViewLayer),a=t*o+(s?n:0);this._sortedRenderers.push(new sr(i,r,a))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],(0,m.v3)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),(0,m.kN)(r.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=(0,a.Bs)(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_ensureDebugPatternResources(e,t){if((0,_.s)(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let t=0;t<e;t++)for(let n=0;n<e;n++){const s=Math.floor(n/10),o=Math.floor(t/10);s<2||o<2||10*s>e-20||10*o>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&s&&1&o?1&n^1&t?0:255:1&s^1&o?0:128)}const n=new ir.R(e);n.samplingMode=Oe.Cj.NEAREST,this._passParameters.texture=new Te.g(this._rctx,n,r);const s=new Qt;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniques.acquire(Xt,s)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),sortedDrapeSources:Array.from(this._sortedRenderers).map((({drapeSource:e})=>e)),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};(0,s._)([(0,u.MZ)()],nr.prototype,"hasHighlights",void 0),(0,s._)([(0,u.MZ)()],nr.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,s._)([(0,u.MZ)()],nr.prototype,"_shaderTechniques",void 0),(0,s._)([(0,u.MZ)({constructOnly:!0})],nr.prototype,"view",void 0),(0,s._)([(0,u.MZ)()],nr.prototype,"worldToPCSRatio",void 0),(0,s._)([(0,u.MZ)()],nr.prototype,"spatialReference",void 0),(0,s._)([(0,u.MZ)({type:Boolean,readOnly:!0})],nr.prototype,"updating",null),(0,s._)([(0,u.MZ)()],nr.prototype,"isEmpty",null),(0,s._)([(0,u.MZ)({readOnly:!0})],nr.prototype,"rendersOccludedDraped",null),nr=(0,s._)([(0,g.$)("esri.views.3d.terrain.OverlayRenderer")],nr);class sr{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const or=[[1,.5,.5],[.5,.5,1]],ar=-2,lr=J.m$.OccludeAndTransparent},68986:(e,t,r)=>{var i,n,s,o;r.d(t,{vr:()=>i}),function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(i||(i={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(n||(n={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(s||(s={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(o||(o={}))},37303:(e,t,r)=>{r.d(t,{s:()=>d});var i=r(24578),n=r(64802),s=r(19635),o=r(4930),a=r(41014),l=r(33763);const c=8;function d(e,t){const r=e.vertex;r.uniforms.add(new s.m("intrinsicWidth",(e=>e.width))),t.vvSize?(e.attributes.add(l.r.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new n.t("vvSizeMinSize",(e=>e.vvSize.minSize)),new n.t("vvSizeMaxSize",(e=>e.vvSize.maxSize)),new n.t("vvSizeOffset",(e=>e.vvSize.offset)),new n.t("vvSizeFactor",(e=>e.vvSize.factor))),r.code.add(a.H`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(l.r.SIZE,"float"),r.code.add(a.H`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(l.r.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add(new o.x("vvOpacityValues",(e=>e.vvOpacity.values),c),new o.x("vvOpacityOpacities",(e=>e.vvOpacity.opacityValues),c)),r.code.add(a.H`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):r.code.add(a.H`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.include(i.A,t),e.attributes.add(l.r.COLORFEATUREATTRIBUTE,"float"),r.code.add(a.H`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(e.attributes.add(l.r.COLOR,"vec4"),r.code.add(a.H`vec4 getColor(){
return applyOpacity(color);
}`))}},65895:(e,t,r)=>{r.d(t,{K:()=>s});var i=r(27981),n=r(41014);function s(e){e.uniforms.add(new i.e("alignPixelEnabled",((e,t)=>t.alignPixelEnabled))),e.code.add(n.H`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),e.code.add(n.H`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)}},87331:(e,t,r)=>{r.d(t,{Q:()=>h,R:()=>d});var i=r(11255),n=r(15510),s=r(69952),o=r(92121),a=r(19635),l=r(41014),c=r(33763);const d=.5;function h(e,t){e.include(n.Y6),e.attributes.add(c.r.POSITION,"vec3"),e.attributes.add(c.r.NORMAL,"vec3"),e.attributes.add(c.r.CENTEROFFSETANDDISTANCE,"vec4");const r=e.vertex;(0,s.NB)(r,t),(0,s.yu)(r,t),r.uniforms.add(new o.E("viewport",((e,t)=>t.camera.fullViewport)),new a.m("polygonOffset",(e=>e.shaderPolygonOffset)),new a.m("cameraGroundRelative",((e,t)=>t.camera.aboveGround?1:-1))),t.hasVerticalOffset&&(0,i.V)(r),r.constants.add("smallOffsetAngle","float",.984807753012208),r.code.add(l.H`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),r.code.add(l.H`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = ${t.multipassEnabled?l.H.float(0):l.H`sign(pointGroundDistance)`};
      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is
      // dropped is instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),t.draped&&!t.hasVerticalOffset||(0,s.S7)(r),t.draped||(r.uniforms.add(new a.m("perDistancePixelRatio",((e,t)=>Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)))),r.code.add(l.H`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * ${l.H.float(d)};

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `)),t.screenCenterOffsetUnitsEnabled&&(0,s.Nz)(r),t.hasScreenSizePerspective&&(0,n.OH)(r),r.code.add(l.H`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      vec3 centerOffset = centerOffsetAndDistance.xyz;
      float pointGroundDistance = centerOffsetAndDistance.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.hasVerticalOffset?l.H`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled?"":l.H`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `)}},73227:(e,t,r)=>{r.d(t,{I:()=>a});var i=r(65895),n=r(43793),s=r(65630),o=r(41014);function a(e,t){const{vertex:r,fragment:a}=e;r.include(i.K),t.multipassEnabled&&(r.include(n.H),e.varyings.add("depth","float")),r.code.add(o.H`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassEnabled?o.H`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.include(s.Q,t),a.code.add(o.H`
  void main() {
    fragColor = vec4(1);
    ${t.multipassEnabled?o.H`
        if(terrainDepthTest(depth)) {
          fragColor.g = 0.5;
        }`:""}
  }
  `)}},86316:(e,t,r)=>{var i;r.d(t,{D:()=>i}),function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(i||(i={}))},16075:(e,t,r)=>{r.d(t,{y:()=>c});var i=r(65895),n=r(86316),s=r(92121),o=r(19635),a=r(41014),l=r(19778);function c(e){e.vertex.uniforms.add(new o.m("renderTransparentlyOccludedHUD",((e,t)=>t.hudRenderStyle===n.D.Occluded?1:t.hudRenderStyle===n.D.NotOccluded?0:.75)),new s.E("viewport",((e,t)=>t.camera.fullViewport)),new l.N("hudVisibilityTexture",((e,t)=>t.hudVisibility?.getTexture()))),e.vertex.include(i.K),e.vertex.code.add(a.H`bool testHUDVisibility(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}},38596:(e,t,r)=>{r.d(t,{v:()=>s,z:()=>n});var i=r(41014);function n(e){e.fragment.code.add(i.H`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function s(e){e.fragment.code.add(i.H`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},77802:(e,t,r)=>{r.d(t,{q:()=>f,h:()=>g});var i=r(80002),n=r(69952),s=r(92121),o=r(19635),a=r(41014),l=r(19778);function c(e){return e.pattern.map((t=>Math.round(t*e.pixelRatio)))}function d(e){return c(e).reduce(((e,t)=>Math.max(e,t)))}r(39637),r(68716),r(89958),r(88416);var h=r(74772),u=r(76982);const p=(0,u.vt)();function f(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){const r=!(t.draped&&t.stipplePreferContinuous),{vertex:c,fragment:f}=e;f.include(i.W),t.draped||((0,n.yu)(c,t),c.uniforms.add(new o.m("worldToScreenPerDistanceRatio",((e,t)=>1/t.camera.perScreenPixelRatio))),c.code.add(a.H`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),c.code.add(a.H`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${m};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),c.code.add(a.H`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),c.code.add(a.H`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),(0,n.Nz)(c),c.code.add(a.H`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),f.uniforms.add(new l.N("stipplePatternTexture",(e=>e.stippleTexture)),new o.m("stipplePatternSDFNormalizer",(e=>function(e){return e?(Math.floor(.5*(d(e)-1))+.5)/e.pixelRatio:1}(e.stipplePattern))),new o.m("stipplePatternPixelSizeInv",(e=>1/g(e)))),f.code.add(a.H`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),t.stippleOffColorEnabled?(f.uniforms.add(new s.E("stippleOffColor",(e=>function(e){return null==e?u.uY:4===e.length?e:(0,h.s)(p,e[0],e[1],e[2],1)}(e.stippleOffColor)))),f.code.add(a.H`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):f.code.add(a.H`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}(e,t):function(e){e.fragment.code.add(a.H`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}(e)}function g(e){const t=e.stipplePattern;return t?function(e){if(null==e)return 1;const t=c(e);return Math.floor(t.reduce(((e,t)=>e+t)))}(e.stipplePattern)/t.pixelRatio:1}const m=a.H.float(.4)},47913:(e,t,r)=>{r.d(t,{r:()=>l});var i=r(4498),n=r(69952),s=r(19635),o=r(41014),a=r(18994);function l(e,t){const{vertex:r,constants:l}=e;l.add("markerSizePerLineWidth","float",i.PV),(0,n.Nz)(r),null==r.uniforms.get("markerScale")&&r.constants.add("markerScale","float",1),r.code.add(o.H`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),t.space===a.lM.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new s.m("perRenderPixelRatio",((e,t)=>t.camera.perRenderPixelRatio))),r.code.add(o.H`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))}},43793:(e,t,r)=>{r.d(t,{H:()=>a,U:()=>l});var i=r(16937),n=r(66579),s=r(41014),o=r(19778);function a(e){e.include(i.D),e.uniforms.add(new o.N("geometryDepthTexture",((e,t)=>t.multipassGeometry.linearDepth?.getTexture())),new n.G("nearFar",((e,t)=>t.camera.nearFar))),e.code.add(s.H`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}class l{}},25853:(e,t,r)=>{r.d(t,{E:()=>A});var i=r(38596),n=r(41014);function s(e){e.fragment.code.add(n.H`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var o=r(75762),a=r(60060),l=r(16937),c=r(66579),d=r(19635),h=r(99040),u=r(19778);function p(e,t){const r=e.fragment;r.include(l.D),r.uniforms.add(new c.G("nearFar",((e,t)=>t.camera.nearFar))),r.uniforms.add(new u.N("depthMap",((e,t)=>t.linearDepth?.getTexture()))),r.uniforms.add(new h.X("proj",((e,t)=>t.camera.projectionMatrix))),r.uniforms.add(new d.m("invResolutionHeight",((e,t)=>1/t.camera.height))),r.uniforms.add(new h.X("reprojectionMatrix",((e,t)=>t.ssr.reprojectionMatrix))),r.code.add(n.H`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}var f=r(4506),g=r(99263),m=r(29740),_=r(99164),v=r(16120),y=r(40574),O=r(27981),T=r(64802),w=r(7804),b=r(34088);class C extends w.n{constructor(e,t){super(e,"samplerCube",b.c.Pass,((r,i,n)=>r.bindTexture(e,t(i,n))))}}function S(e){const t=e.fragment;t.uniforms.add(new h.X("rotationMatrixClouds",((e,t)=>t.cloudsFade.parallax.transform)),new h.X("rotationMatrixCloudsCrossFade",((e,t)=>t.cloudsFade.parallaxNew.transform)),new T.t("anchorPosition",((e,t)=>t.cloudsFade.parallax.anchorPointClouds)),new T.t("anchorPositionCrossFade",((e,t)=>t.cloudsFade.parallaxNew.anchorPointClouds)),new d.m("cloudsHeight",(()=>v.k9)),new d.m("radiusCurvatureCorrectionFactor",((e,t)=>t.cloudsFade.parallax.radiusCurvatureCorrectionFactor)),new d.m("totalFadeInOut",((e,t)=>1-t.cloudsFade.opacity)),new d.m("crossFadeAnchorFactor",((e,t)=>(0,f.qE)(t.cloudsFade.fadeFactor,0,1))),new C("cubeMap",((e,t)=>t.cloudsFade.data?.cubeMap?.colorTexture??null)),new O.e("crossFade",((e,t)=>t.cloudsFade.fadeMode===_.OQ.CROSS_FADE)),new O.e("readChannelsRG",((e,t)=>t.cloudsFade.readChannels===m.c.RG)),new O.e("fadeTextureChannels",((e,t)=>t.cloudsFade.renderingStage===m.c2.FADING))),t.constants.add("planetRadius","float",g.$O.radius),t.code.add(n.H`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.code.add(n.H`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.code.add(n.H`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),(0,y.Gc)(t),(0,y.O4)(t),t.code.add(n.H`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.code.add(n.H`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = texture(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),t.code.add(n.H`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),t.code.add(n.H`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),t.code.add(n.H`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function A(e,t){e.include(o.f,t),e.include(s),e.include(i.v),t.hasCloudsReflections&&e.include(S,t),t.hasScreenSpaceReflections&&e.include(p,t);const r=e.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",a.O).add("ssrHeightFadeEnd","float",a.b).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(n.H`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add(new d.m("lightingSpecularStrength",((e,t)=>t.lighting.mainLight.specularStrength)),new d.m("lightingEnvironmentStrength",((e,t)=>t.lighting.mainLight.environmentStrength))),r.code.add(n.H`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.hasCloudsReflections&&r.code.add(n.H`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),t.hasScreenSpaceReflections?(r.uniforms.add(new h.X("view",((e,t)=>t.camera.viewMatrix)),new u.N("lastFrameColorTexture",((e,t)=>t.ssr.lastFrameColor?.getTexture())),new d.m("fadeFactorSSR",((e,t)=>t.ssr.fadeFactor))),r.code.add(n.H`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(n.H`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.hasCloudsReflections?t.hasScreenSpaceReflections?r.code.add(n.H`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(n.H`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(n.H`return waterRenderedColor;
}`)}},75526:(e,t,r)=>{r.d(t,{i:()=>b});var i,n=r(82392),s=r(73783),o=r(80861),a=r(4506),l=r(23572),c=r(81482),d=(r(6273),r(67498),r(26325)),h=r(25336),u=r(26110),p=r(53334),f=r(56560),g=r(80347),m=r(19913),_=r(74772),v=r(76982),y=r(74224),O=r(63918),T=r(74695),w=r(84456);let b=i=class extends s.A{constructor(e){super(e),this._ray=(0,O.vt)(),this._viewport=(0,v.fA)(0,0,1,1),this._padding=(0,v.fA)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,f.fA)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,u.vt)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,u.vt)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,u.vt)(),this._frustumDirty=!0,this._frustum=(0,y.vt)(),this._fullViewport=(0,v.vt)(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=(0,m.vt)(),this._up=(0,m.vt)(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return(0,g.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,h.C)(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),(0,g.s)((0,m.vt)(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),(0,g.s)((0,m.vt)(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),(0,g.s)((0,m.vt)(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=(0,_.b)((0,v.vt)(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&(0,_.e)(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=(0,_.b)((0,v.vt)(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&(0,_.e)(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[E.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[E.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[E.RIGHT]+this._padding[E.LEFT]}set fullWidth(e){this.width=e-(this._padding[E.RIGHT]+this._padding[E.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[E.TOP]+this._padding[E.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[E.TOP]+this._padding[E.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[E.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[E.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){(0,_.a)(this._padding,e)||(this._viewport[0]+=e[E.LEFT]-this._padding[E.LEFT],this._viewport[1]+=e[E.BOTTOM]-this._padding[E.BOTTOM],this._viewport[2]-=e[E.RIGHT]+e[E.LEFT]-(this._padding[E.RIGHT]+this._padding[E.LEFT]),this._viewport[3]-=e[E.TOP]+e[E.BOTTOM]-(this._padding[E.TOP]+this._padding[E.BOTTOM]),(0,_.c)(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,h.lw)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2)*2,i=r*this._aspect,n=r/this.rows,s=i/this.columns,o=-i/2+this.column*s,a=o+s,l=-r/2+this.row*n,c=l+n,d=(0,h.$h)((0,u.vt)(),o*(1+2*this._padding[E.LEFT]/e),a*(1+2*this._padding[E.RIGHT]/e),l*(1+2*this._padding[E.BOTTOM]/t),c*(1+2*this._padding[E.TOP]/t),this.near,this.far),p=this._get("projectionMatrix");return p&&(0,h.aI)(p,d)?p:d}get inverseProjectionMatrix(){return(0,h.B8)((0,u.vt)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,u.vt)()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return e=this._fov,t=this.width,r=this.height,2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+r*r));var e,t,r}set fovX(e){this._fov=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/t)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return e=this._fov,t=this.width,r=this.height,2*Math.atan(r*Math.tan(.5*e)/Math.sqrt(t*t+r*r));var e,t,r}set fovY(e){this._fov=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/r)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,g.q)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,h.B8)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,h.mg)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){(0,g.c)(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,(0,_.c)(this._viewport,e.viewport),this.notifyChange("_viewport"),(0,_.c)(this._padding,e.padding),this.notifyChange("_padding"),(0,p.C)(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,h.C)(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,y.C)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,h.C)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,_.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new i).copyFrom(this)}equals(e){return(0,g.j)(this.eye,e.eye)&&(0,g.j)(this.center,e.center)&&(0,g.j)(this.up,e.up)&&(0,_.a)(this._viewport,e.viewport)&&(0,_.a)(this._padding,e.padding)&&(0,p.t2)(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||(0,_.d)(e.screenPadding,this.screenPadding)>=t||(0,_.d)(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;(0,g.z)(A,e.eye,e.center),(0,g.z)(x,this.eye,this.center);const r=(0,g.k)(A,x),i=(0,g.x)(A),n=(0,g.x)(x),s=5e-4;return r*r>=(1-1e-10)*i*n&&(0,g.w)(e.eye,this.eye)<Math.max(i,n)*s*s}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs((0,T.gr)(this.viewForward,(0,g.f)(A,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=(0,l.gs)()){return e[0]=(this.padding[E.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[E.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,r=.5){return e[0]=this.padding[E.LEFT]+this.width*t,e[1]=this.padding[E.BOTTOM]+this.height*r,e[2]=.5,e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t){e!==C&&(0,g.c)(C,e),C[3]=1,(0,_.t)(C,C,this.projectionMatrix);const r=Math.abs(C[3]);(0,g.h)(C,C,1/r);const i=this.fullViewport;t[0]=(0,a.Cc)(0,i[0]+i[2],.5+.5*C[0]),t[1]=(0,a.Cc)(0,i[1]+i[3],.5+.5*C[1]),t[2]=.5*(C[2]+1),t[3]=r}unapplyProjection(e,t){const r=this.fullViewport;C[0]=(e[0]/(r[0]+r[2])*2-1)*e[3],C[1]=(e[1]/(r[1]+r[3])*2-1)*e[3],C[2]=(2*e[2]-1)*e[3],C[3]=e[3],null!=this.inverseProjectionMatrix&&((0,_.t)(C,C,this.inverseProjectionMatrix),t[0]=C[0],t[1]=C[1],t[2]=C[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,R),this.renderToScreen(R,t),t}projectToRenderScreen(e,t){if(C[0]=e[0],C[1]=e[1],C[2]=e[2],C[3]=1,(0,_.t)(C,C,this.viewProjectionMatrix),0===C[3])return null;const r=C;(0,g.h)(r,r,1/Math.abs(C[3]));const i=this.fullViewport,n=(0,a.Cc)(0,i[0]+i[2],.5+.5*r[0]),s=(0,a.Cc)(0,i[1]+i[3],.5+.5*r[1]);return"x"in t?(t.x=n,t.y=s):(t[0]=n,t[1]=s,t.length>2&&(t[2]=.5*(r[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,R),t)}unprojectFromRenderScreen(e,t){if((0,h.lw)(S,this.projectionMatrix,this.viewMatrix),!(0,h.B8)(S,S))return null;const r=this.fullViewport;return C[0]=2*(e[0]-r[0])/r[2]-1,C[1]=2*(e[1]-r[1])/r[3]-1,C[2]=2*e[2]-1,C[3]=1,(0,_.t)(C,C,S),0===C[3]?null:(t[0]=C[0]/C[3],t[1]=C[1]/C[3],t[2]=C[2]/C[3],t)}constrainWindowSize(e,t,r,i){const n=e*this.pixelRatio,s=t*this.pixelRatio,o=Math.max(n-r/2,0),a=Math.max(this.fullHeight-s-i/2,0),l=-Math.min(n-r/2,0),c=-Math.min(this.fullHeight-s-i/2,0),d=r-l- -Math.min(this.fullWidth-n-r/2,0),h=i-c- -Math.min(s-i/2,0);return[Math.round(o),Math.round(a),Math.round(d),Math.round(h)]}computeUp(e){e===w.RT.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}_computeUpGlobal(){(0,g.f)(A,this.center,this.eye);const e=(0,g.l)(this.center);e<1?((0,g.s)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,g.k)(A,this.center))>.9999*(0,g.l)(A)*e||((0,g.b)(this._up,A,this.center),(0,g.b)(this._up,this._up,A),(0,g.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,g.E)(A,this.eye,this.center),Math.abs(A[2])<=.9999&&((0,g.h)(A,A,A[2]),(0,g.s)(this._up,-A[0],-A[1],1-A[2]),(0,g.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,r=""){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,g.j)(e,t)||((0,g.c)(t,e),this._markViewDirty(),r.length&&this.notifyChange(r)):o.A.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,y.ui)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,h.t5)(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,n._)([(0,c.MZ)()],b.prototype,"_viewport",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"_padding",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"_fov",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"_nearFar",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"_viewDirty",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"_viewMatrix",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"_pixelRatio",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"pixelRatio",null),(0,n._)([(0,c.MZ)()],b.prototype,"row",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"column",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"_rows",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"rows",null),(0,n._)([(0,c.MZ)()],b.prototype,"_columns",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"columns",null),(0,n._)([(0,c.MZ)()],b.prototype,"eye",null),(0,n._)([(0,c.MZ)()],b.prototype,"center",null),(0,n._)([(0,c.MZ)()],b.prototype,"_center",void 0),(0,n._)([(0,c.MZ)()],b.prototype,"up",null),(0,n._)([(0,c.MZ)()],b.prototype,"_up",void 0),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"viewForward",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"viewUp",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"viewRight",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"nearFar",null),(0,n._)([(0,c.MZ)()],b.prototype,"near",null),(0,n._)([(0,c.MZ)()],b.prototype,"far",null),(0,n._)([(0,c.MZ)()],b.prototype,"viewport",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"screenViewport",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"screenPadding",null),(0,n._)([(0,c.MZ)()],b.prototype,"x",null),(0,n._)([(0,c.MZ)()],b.prototype,"y",null),(0,n._)([(0,c.MZ)()],b.prototype,"width",null),(0,n._)([(0,c.MZ)()],b.prototype,"height",null),(0,n._)([(0,c.MZ)()],b.prototype,"fullWidth",null),(0,n._)([(0,c.MZ)()],b.prototype,"fullHeight",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"_aspect",null),(0,n._)([(0,c.MZ)()],b.prototype,"padding",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"projectionMatrix",null),(0,n._)([(0,c.MZ)({readOnly:!0})],b.prototype,"inverseProjectionMatrix",null),(0,n._)([(0,c.MZ)()],b.prototype,"fov",null),(0,n._)([(0,c.MZ)()],b.prototype,"fovX",null),(0,n._)([(0,c.MZ)()],b.prototype,"fovY",null),b=i=(0,n._)([(0,d.$)("esri.views.3d.webgl-engine.lib.Camera")],b);const C=(0,v.vt)(),S=(0,u.vt)(),A=(0,m.vt)(),x=(0,m.vt)(),R=(0,l.r_)();var E,D;(D=E||(E={}))[D.TOP=0]="TOP",D[D.RIGHT=1]="RIGHT",D[D.BOTTOM=2]="BOTTOM",D[D.LEFT=3]="LEFT"},4330:(e,t,r)=>{r.d(t,{c:()=>n});var i=r(10875);class n{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,r){const n=this._material.produces.get(t);if(!n||!n(r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,t,r));const s=this._map.get(r);if(null!=s){if(s.ensureResources(e)===i.Am.LOADED)return s;this._repository.requestRender()}return null}}},74316:(e,t,r)=>{r.d(t,{zC:()=>ie,C1:()=>S,EE:()=>X,nW:()=>Q,td:()=>D,_B:()=>te,Nq:()=>K,DJ:()=>q,uX:()=>Z,Z8:()=>ee,CM:()=>k,Gj:()=>Y,Ho:()=>G,Nb:()=>J,Xl:()=>se,xh:()=>re});var i,n=r(56560),s=r(80347),o=r(6590),a=r(19913),l=r(75644),c=r(68435),d=r(51831),h=r(87368),u=r(63918),p=r(10941);!function(e){e.length=function(e,t){const r=e[t],i=e[t+1],n=e[t+2];return Math.sqrt(r*r+i*i+n*n)},e.normalize=function(e,t){const r=e[t],i=e[t+1],n=e[t+2],s=1/Math.sqrt(r*r+i*i+n*n);e[t]*=s,e[t+1]*=s,e[t+2]*=s},e.scale=function(e,t,r){e[t]*=r,e[t+1]*=r,e[t+2]*=r},e.add=function(e,t,r,i,n,s=t){(n=n||e)[s]=e[t]+r[i],n[s+1]=e[t+1]+r[i+1],n[s+2]=e[t+2]+r[i+2]},e.subtract=function(e,t,r,i,n,s=t){(n=n||e)[s]=e[t]-r[i],n[s+1]=e[t+1]-r[i+1],n[s+2]=e[t+2]-r[i+2]}}(i||(i={}));var f=r(61723),g=r(40753),m=r(26421),_=r(33763);const v=i,y=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],O=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],T=[0,0,1,0,1,1,0,1],w=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],b=new Array(36);for(let e=0;e<6;e++)for(let t=0;t<6;t++)b[6*e+t]=e;const C=new Array(36);for(let e=0;e<6;e++)C[6*e]=0,C[6*e+1]=1,C[6*e+2]=2,C[6*e+3]=2,C[6*e+4]=3,C[6*e+5]=0;function S(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(24);for(let e=0;e<8;e++)r[3*e]=y[e][0]*t[0],r[3*e+1]=y[e][1]*t[1],r[3*e+2]=y[e][2]*t[2];return new g.V(e,[[_.r.POSITION,new p.n(r,w,3,!0)],[_.r.NORMAL,new p.n(O,b,3)],[_.r.UV0,new p.n(T,C,2)]])}const A=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],x=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],R=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],E=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function D(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(18);for(let e=0;e<6;e++)r[3*e]=A[e][0]*t[0],r[3*e+1]=A[e][1]*t[1],r[3*e+2]=A[e][2]*t[2];return new g.V(e,[[_.r.POSITION,new p.n(r,R,3,!0)],[_.r.NORMAL,new p.n(x,E,3)]])}const P=(0,o.fA)(-.5,0,-.5),M=(0,o.fA)(.5,0,-.5),I=(0,o.fA)(0,0,.5),N=(0,o.fA)(0,.5,0),F=(0,o.vt)(),L=(0,o.vt)(),z=(0,o.vt)(),H=(0,o.vt)(),V=(0,o.vt)();(0,s.f)(F,P,N),(0,s.f)(L,P,M),(0,s.b)(z,F,L),(0,s.n)(z,z),(0,s.f)(F,M,N),(0,s.f)(L,M,I),(0,s.b)(H,F,L),(0,s.n)(H,H),(0,s.f)(F,I,N),(0,s.f)(L,I,P),(0,s.b)(V,F,L),(0,s.n)(V,V);const j=[P,M,I,N],B=[0,-1,0,z[0],z[1],z[2],H[0],H[1],H[2],V[0],V[1],V[2]],U=[0,1,2,3,1,0,3,2,1,3,0,2],W=[0,0,0,1,1,1,2,2,2,3,3,3];function G(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(12);for(let e=0;e<4;e++)r[3*e]=j[e][0]*t[0],r[3*e+1]=j[e][1]*t[1],r[3*e+2]=j[e][2]*t[2];return new g.V(e,[[_.r.POSITION,new p.n(r,U,3,!0)],[_.r.NORMAL,new p.n(B,W,3)]])}function k(e,t,r,i,n={uv:!0}){const s=-Math.PI,o=2*Math.PI,a=-Math.PI/2,l=Math.PI,h=Math.max(3,Math.floor(r)),u=Math.max(2,Math.floor(i)),f=(h+1)*(u+1),m=(0,c.oe)(3*f),v=(0,c.oe)(3*f),y=(0,c.oe)(2*f),O=[];let T=0;for(let e=0;e<=u;e++){const r=[],i=e/u,n=a+i*l,c=Math.cos(n);for(let e=0;e<=h;e++){const a=e/h,l=s+a*o,d=Math.cos(l)*c,u=Math.sin(n),p=-Math.sin(l)*c;m[3*T]=d*t,m[3*T+1]=u*t,m[3*T+2]=p*t,v[3*T]=d,v[3*T+1]=u,v[3*T+2]=p,y[2*T]=a,y[2*T+1]=i,r.push(T),++T}O.push(r)}const w=new Array;for(let e=0;e<u;e++)for(let t=0;t<h;t++){const r=O[e][t],i=O[e][t+1],n=O[e+1][t+1],s=O[e+1][t];0===e?(w.push(r),w.push(n),w.push(s)):e===u-1?(w.push(r),w.push(i),w.push(n)):(w.push(r),w.push(i),w.push(n),w.push(n),w.push(s),w.push(r))}const b=[[_.r.POSITION,new p.n(m,w,3,!0)],[_.r.NORMAL,new p.n(v,w,3,!0)]];return n.uv&&b.push([_.r.UV0,new p.n(y,w,2,!0)]),n.offset&&(b[0][0]=_.r.OFFSET,b.push([_.r.POSITION,new p.n(Float64Array.from(n.offset),(0,d.EH)(w.length),3,!0)])),new g.V(e,b)}function Z(e,t,r,i){const n=function(e,t,r){const i=e;let n,s;if(r)n=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],s=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const e=i*(1+Math.sqrt(5))/2;n=[-i,e,0,i,e,0,-i,-e,0,i,-e,0,0,-i,e,0,i,e,0,-i,-e,0,i,-e,e,0,-i,e,0,i,-e,0,-i,-e,0,i],s=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let t=0;t<n.length;t+=3)v.scale(n,t,e/v.length(n,t));let o={};function a(t,r){t>r&&([t,r]=[r,t]);const i=t.toString()+"."+r.toString();if(o[i])return o[i];let s=n.length;return n.length+=3,v.add(n,3*t,n,3*r,n,s),v.scale(n,s,e/v.length(n,s)),s/=3,o[i]=s,s}for(let e=0;e<t;e++){const e=s.length,t=new Array(4*e);for(let r=0;r<e;r+=3){const e=s[r],i=s[r+1],n=s[r+2],o=a(e,i),l=a(i,n),c=a(n,e),d=4*r;t[d]=e,t[d+1]=o,t[d+2]=c,t[d+3]=i,t[d+4]=l,t[d+5]=o,t[d+6]=n,t[d+7]=c,t[d+8]=l,t[d+9]=o,t[d+10]=l,t[d+11]=c}s=t,o={}}const l=(0,c.Wz)(n);for(let e=0;e<l.length;e+=3)v.normalize(l,e);return[[_.r.POSITION,new p.n((0,c.Wz)(n),s,3,!0)],[_.r.NORMAL,new p.n(l,s,3,!0)]]}(t,r,i);return new g.V(e,n)}function q(e,t,r,i,s,o,l,c,h=null){const u=r?(0,a.o8)(r):(0,a.vt)(),m=t?(0,a.o8)(t):(0,a.fA)(0,0,1);l??=(0,n.vt)();const v=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],y=null!=s&&2===s.length?s:[1,1],O=(0,d.EH)(1),T=[[_.r.POSITION,new p.n(u,O,3,!0)],[_.r.NORMAL,new p.n(m,O,3,!0)],[_.r.UV0,new p.n(l,O,l.length)],[_.r.COLOR,new p.n(v,O,4,!0)],[_.r.SIZE,new p.n(y,O,2)]];if(null!=o&&(o=[o[0],o[1],o[2],o[3]],T.push([_.r.CENTEROFFSETANDDISTANCE,new p.n(o,O,4)])),c){const e=[c[0],c[1],c[2],c[3]];T.push([_.r.FEATUREATTRIBUTE,new p.n(e,O,4)])}return new g.V(e,T,null,f.X.Point,h)}const $=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function Y(e,t=$){const r=new Array(12);for(let e=0;e<4;e++)for(let i=0;i<3;i++)r[3*e+i]=t[e][i];const i=[0,1,2,2,3,0],n=[0,0,0,0,0,0],s=[[_.r.POSITION,new p.n(r,i,3,!0)],[_.r.NORMAL,new p.n([0,0,1],n,3,!0)],[_.r.UV0,new p.n([0,0,1,0,1,1,0,1],i,2,!0)],[_.r.COLOR,new p.n([255,255,255,255],n,4,!0)]];return new g.V(e,s)}function X(e,t,r,i,n,s=!0,a=!0){let l=0;const d=r,h=t;let u=(0,o.fA)(0,l,0),f=(0,o.fA)(0,l+h,0),m=(0,o.fA)(0,-1,0),v=(0,o.fA)(0,1,0);n&&(l=h,f=(0,o.fA)(0,0,0),u=(0,o.fA)(0,l,0),m=(0,o.fA)(0,1,0),v=(0,o.fA)(0,-1,0));const y=[f,u],O=[m,v],T=i+2,w=Math.sqrt(h*h+d*d);if(n)for(let e=i-1;e>=0;e--){const t=e*(2*Math.PI/i),r=(0,o.fA)(Math.cos(t)*d,l,Math.sin(t)*d);y.push(r);const n=(0,o.fA)(h*Math.cos(t)/w,-d/w,h*Math.sin(t)/w);O.push(n)}else for(let e=0;e<i;e++){const t=e*(2*Math.PI/i),r=(0,o.fA)(Math.cos(t)*d,l,Math.sin(t)*d);y.push(r);const n=(0,o.fA)(h*Math.cos(t)/w,d/w,h*Math.sin(t)/w);O.push(n)}const b=new Array,C=new Array;if(s){for(let e=3;e<y.length;e++)b.push(1),b.push(e-1),b.push(e),C.push(0),C.push(0),C.push(0);b.push(y.length-1),b.push(2),b.push(1),C.push(0),C.push(0),C.push(0)}if(a){for(let e=3;e<y.length;e++)b.push(e),b.push(e-1),b.push(0),C.push(e),C.push(e-1),C.push(1);b.push(0),b.push(2),b.push(y.length-1),C.push(1),C.push(2),C.push(O.length-1)}const S=(0,c.oe)(3*T);for(let e=0;e<T;e++)S[3*e]=y[e][0],S[3*e+1]=y[e][1],S[3*e+2]=y[e][2];const A=(0,c.oe)(3*T);for(let e=0;e<T;e++)A[3*e]=O[e][0],A[3*e+1]=O[e][1],A[3*e+2]=O[e][2];const x=[[_.r.POSITION,new p.n(S,b,3,!0)],[_.r.NORMAL,new p.n(A,C,3,!0)]];return new g.V(e,x)}function Q(e,t,r,i,n,a,l){const d=n?(0,o.o8)(n):(0,o.fA)(1,0,0),h=a?(0,o.o8)(a):(0,o.fA)(0,0,0);l??=!0;const u=(0,o.vt)();(0,s.n)(u,d);const f=(0,o.vt)();(0,s.h)(f,u,Math.abs(t));const m=(0,o.vt)();(0,s.h)(m,f,-.5),(0,s.g)(m,m,h);const v=(0,o.fA)(0,1,0);Math.abs(1-(0,s.k)(u,v))<.2&&(0,s.s)(v,0,0,1);const y=(0,o.vt)();(0,s.b)(y,u,v),(0,s.n)(y,y),(0,s.b)(v,y,u);const O=2*i+(l?2:0),T=i+(l?2:0),w=(0,c.oe)(3*O),b=(0,c.oe)(3*T),C=(0,c.oe)(2*O),S=new Array(3*i*(l?4:2)),A=new Array(3*i*(l?4:2));l&&(w[3*(O-2)]=m[0],w[3*(O-2)+1]=m[1],w[3*(O-2)+2]=m[2],C[2*(O-2)]=0,C[2*(O-2)+1]=0,w[3*(O-1)]=w[3*(O-2)]+f[0],w[3*(O-1)+1]=w[3*(O-2)+1]+f[1],w[3*(O-1)+2]=w[3*(O-2)+2]+f[2],C[2*(O-1)]=1,C[2*(O-1)+1]=1,b[3*(T-2)]=-u[0],b[3*(T-2)+1]=-u[1],b[3*(T-2)+2]=-u[2],b[3*(T-1)]=u[0],b[3*(T-1)+1]=u[1],b[3*(T-1)+2]=u[2]);const x=(e,t,r)=>{S[e]=t,A[e]=r};let R=0;const E=(0,o.vt)(),D=(0,o.vt)();for(let e=0;e<i;e++){const t=e*(2*Math.PI/i);(0,s.h)(E,v,Math.sin(t)),(0,s.h)(D,y,Math.cos(t)),(0,s.g)(E,E,D),b[3*e]=E[0],b[3*e+1]=E[1],b[3*e+2]=E[2],(0,s.h)(E,E,r),(0,s.g)(E,E,m),w[3*e]=E[0],w[3*e+1]=E[1],w[3*e+2]=E[2],C[2*e]=e/i,C[2*e+1]=0,w[3*(e+i)]=w[3*e]+f[0],w[3*(e+i)+1]=w[3*e+1]+f[1],w[3*(e+i)+2]=w[3*e+2]+f[2],C[2*(e+i)]=e/i,C[2*e+1]=1;const n=(e+1)%i;x(R++,e,e),x(R++,e+i,e),x(R++,n,n),x(R++,n,n),x(R++,e+i,e),x(R++,n+i,n)}if(l){for(let e=0;e<i;e++){const t=(e+1)%i;x(R++,O-2,T-2),x(R++,e,T-2),x(R++,t,T-2)}for(let e=0;e<i;e++){const t=(e+1)%i;x(R++,e+i,T-1),x(R++,O-1,T-1),x(R++,t+i,T-1)}}const P=[[_.r.POSITION,new p.n(w,S,3,!0)],[_.r.NORMAL,new p.n(b,A,3,!0)],[_.r.UV0,new p.n(C,S,2,!0)]];return new g.V(e,P)}function J(e,t,r,i,n,s){i=i||10,n=null==n||n,(0,m.vA)(t.length>1);const o=[],a=[];for(let e=0;e<i;e++){o.push([0,-e-1,-(e+1)%i-1]);const t=e/i*2*Math.PI;a.push([Math.cos(t)*r,Math.sin(t)*r])}return K(e,a,t,[[0,0,0]],o,n,s)}function K(e,t,r,i,n,l,d=(0,o.fA)(0,0,0)){const f=t.length,m=(0,c.oe)(r.length*f*3+(6*i.length||0)),v=(0,c.oe)(r.length*f*3+(i?6:0)),y=new Array,O=new Array;let T=0,w=0;const b=(0,a.vt)(),C=(0,a.vt)(),S=(0,a.vt)(),A=(0,a.vt)(),x=(0,a.vt)(),R=(0,a.vt)(),E=(0,a.vt)(),D=(0,a.vt)(),P=(0,a.vt)(),M=(0,a.vt)(),I=(0,a.vt)(),N=(0,a.vt)(),F=(0,a.vt)(),L=(0,h.vt)();(0,s.s)(P,0,1,0),(0,s.f)(C,r[1],r[0]),(0,s.n)(C,C),l?((0,s.g)(D,r[0],d),(0,s.n)(S,D)):(0,s.s)(S,0,0,1),se(C,S,P,P,x,S,oe),(0,s.c)(A,S),(0,s.c)(N,x);for(let e=0;e<i.length;e++)(0,s.h)(R,x,i[e][0]),(0,s.h)(D,S,i[e][2]),(0,s.g)(R,R,D),(0,s.g)(R,R,r[0]),m[T++]=R[0],m[T++]=R[1],m[T++]=R[2];v[w++]=-C[0],v[w++]=-C[1],v[w++]=-C[2];for(let e=0;e<n.length;e++)y.push(n[e][0]>0?n[e][0]:-n[e][0]-1+i.length),y.push(n[e][1]>0?n[e][1]:-n[e][1]-1+i.length),y.push(n[e][2]>0?n[e][2]:-n[e][2]-1+i.length),O.push(0),O.push(0),O.push(0);let z=i.length;const H=i.length-1;for(let e=0;e<r.length;e++){let i=!1;e>0&&((0,s.c)(b,C),e<r.length-1?((0,s.f)(C,r[e+1],r[e]),(0,s.n)(C,C)):i=!0,(0,s.g)(M,b,C),(0,s.n)(M,M),(0,s.g)(I,r[e-1],A),(0,h.O_)(r[e],M,L),(0,h.Ui)(L,(0,u.LV)(I,b),D)?((0,s.f)(D,D,r[e]),(0,s.n)(S,D),(0,s.b)(x,M,S),(0,s.n)(x,x)):se(M,A,N,P,x,S,oe),(0,s.c)(A,S),(0,s.c)(N,x)),l&&((0,s.g)(D,r[e],d),(0,s.n)(F,D));for(let n=0;n<f;n++)if((0,s.h)(R,x,t[n][0]),(0,s.h)(D,S,t[n][1]),(0,s.g)(R,R,D),(0,s.n)(E,R),v[w++]=E[0],v[w++]=E[1],v[w++]=E[2],(0,s.g)(R,R,r[e]),m[T++]=R[0],m[T++]=R[1],m[T++]=R[2],!i){const e=(n+1)%f;y.push(z+n),y.push(z+f+n),y.push(z+e),y.push(z+e),y.push(z+f+n),y.push(z+f+e);for(let e=0;e<6;e++){const t=y.length-6;O.push(y[t+e]-H)}}z+=f}const V=r[r.length-1];for(let e=0;e<i.length;e++)(0,s.h)(R,x,i[e][0]),(0,s.h)(D,S,i[e][1]),(0,s.g)(R,R,D),(0,s.g)(R,R,V),m[T++]=R[0],m[T++]=R[1],m[T++]=R[2];const j=w/3;v[w++]=C[0],v[w++]=C[1],v[w++]=C[2];const B=z-f;for(let e=0;e<n.length;e++)y.push(n[e][0]>=0?z+n[e][0]:-n[e][0]-1+B),y.push(n[e][2]>=0?z+n[e][2]:-n[e][2]-1+B),y.push(n[e][1]>=0?z+n[e][1]:-n[e][1]-1+B),O.push(j),O.push(j),O.push(j);const U=[[_.r.POSITION,new p.n(m,y,3,!0)],[_.r.NORMAL,new p.n(v,O,3,!0)]];return new g.V(e,U)}function ee(e,t,r,i){(0,m.vA)(t.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),(0,m.vA)(3===t[0].length,"createPolylineGeometry(): malformed vertex"),(0,m.vA)(null==r||r.length===t.length,"createPolylineGeometry: need same number of points and normals"),(0,m.vA)(null==r||3===r[0].length,"createPolylineGeometry(): malformed normal");const n=(0,l.jh)(3*t.length),s=new Array(2*(t.length-1));let o=0,a=0;for(let e=0;e<t.length;e++){for(let r=0;r<3;r++)n[o++]=t[e][r];e>0&&(s[a++]=e-1,s[a++]=e)}const h=[[_.r.POSITION,new p.n(n,s,3,!0)]];if(r){const e=(0,c.oe)(3*r.length);let i=0;for(let n=0;n<t.length;n++)for(let t=0;t<3;t++)e[i++]=r[n][t];h.push([_.r.NORMAL,new p.n(e,s,3,!0)])}return i&&h.push([_.r.COLOR,new p.n(i,(0,d.tM)(i.length/4),4)]),new g.V(e,h,null,f.X.Line)}function te(e,t,r,i,n,s=0){const o=new Array(18),a=[[-r,s,n/2],[i,s,n/2],[0,t+s,n/2],[-r,s,-n/2],[i,s,-n/2],[0,t+s,-n/2]];for(let e=0;e<6;e++)o[3*e]=a[e][0],o[3*e+1]=a[e][1],o[3*e+2]=a[e][2];return new g.V(e,[[_.r.POSITION,new p.n(o,[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5],3,!0)]])}function re(e,t){const r=e.getMutableAttribute(_.r.POSITION).data;for(let e=0;e<r.length;e+=3){const i=r[e],n=r[e+1],o=r[e+2];(0,s.s)(ae,i,n,o),(0,s.e)(ae,ae,t),r[e]=ae[0],r[e+1]=ae[1],r[e+2]=ae[2]}}function ie(e,t=e){const r=e.attributes,i=r.get(_.r.POSITION).data,n=r.get(_.r.NORMAL).data;if(n){const e=t.getMutableAttribute(_.r.NORMAL).data;for(let t=0;t<n.length;t+=3){const r=n[t+1];e[t+1]=-n[t+2],e[t+2]=r}}if(i){const e=t.getMutableAttribute(_.r.POSITION).data;for(let t=0;t<i.length;t+=3){const r=i[t+1];e[t+1]=-i[t+2],e[t+2]=r}}}function ne(e,t,r,i,n){return!(Math.abs((0,s.k)(t,e))>n||((0,s.b)(r,e,t),(0,s.n)(r,r),(0,s.b)(i,r,e),(0,s.n)(i,i),0))}function se(e,t,r,i,n,s,o){return ne(e,t,n,s,o)||ne(e,r,n,s,o)||ne(e,i,n,s,o)}const oe=.99619469809,ae=(0,a.vt)()},45072:(e,t,r)=>{r.d(t,{g:()=>_});var i=r(78851),n=r(80347),s=r(19913),o=r(76982),a=r(88133),l=r(10941),c=r(61723),d=r(40753),h=r(96024),u=r(54909),p=r(58304),f=r(33763),g=r(5415),m=r(16596);class _{constructor(e){this._originSR=e,this._rootOriginId="root/"+(0,i.c)(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=p.Q.rootOrigin;if(null!=t)return this._origins.set(this._rootOriginId,(0,h.f)(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);const r=(0,h.f)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,r),r}const r=this._gridSize,i=Math.round(e[0]/r),s=Math.round(e[1]/r),o=Math.round(e[2]/r),a=`${i}/${s}/${o}`;let l=this._origins.get(a);const c=.5*r;if((0,n.f)(v,e,t.vec3),v[0]=Math.abs(v[0]),v[1]=Math.abs(v[1]),v[2]=Math.abs(v[2]),v[0]<c&&v[1]<c&&v[2]<c){if(l){const t=Math.max(...v);if((0,n.f)(v,e,l.vec3),v[0]=Math.abs(v[0]),v[1]=Math.abs(v[1]),v[2]=Math.abs(v[2]),Math.max(...v)<t)return l}return t}return l||(l=(0,h.f)(i*r,s*r,o*r,a),this._origins.set(a,l)),l}_drawOriginBox(e,t=(0,o.fA)(1,1,0,1)){const r=window.view,i=r._stage,n=t.toString();if(!this._objects.has(n)){this._material=new m.W({width:2,color:t}),i.add(this._material);const e=new g.x(i,{pickable:!1}),r=new u.B({castShadow:!1});i.add(r),e.add(r),this._objects.set(n,r)}const s=this._objects.get(n),h=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],p=h.length,_=new Array(3*p),v=new Array,y=.5*this._gridSize;for(let t=0;t<p;t++)_[3*t]=e[0]+(1&h[t]?y:-y),_[3*t+1]=e[1]+(2&h[t]?y:-y),_[3*t+2]=e[2]+(4&h[t]?y:-y),t>0&&v.push(t-1,t);(0,a.projectBuffer)(_,this._originSR,0,_,r.renderSpatialReference,0,p);const O=new d.V(this._material,[[f.r.POSITION,new l.n(_,v,3,!0)]],null,c.X.Line);i.add(O),s.addGeometry(O)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}}const v=(0,s.vt)()},57809:(e,t,r)=>{r.d(t,{G7:()=>w,hz:()=>v});var i=r(25336),n=r(26110),s=r(80347),o=r(19913),a=r(74772),l=r(76982),c=r(63918),d=r(84456),h=r(30165),u=r(76388),p=r(2680),f=r(72559);const g=1e-5;class m{constructor(e){this.options=new h.H6,this._results=new y,this.transform=new f.dg,this.tolerance=g,this.verticalOffset=null,this._ray=(0,c.vt)(),this._rayEnd=(0,o.vt)(),this._rayBeginTransformed=(0,o.vt)(),this._rayEndTransformed=(0,o.vt)(),this.viewingMode=e??d.RT.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,r){this.resetWithRay((0,c.Cr)(e,t,this._ray),r)}resetWithRay(e,t){this.camera=t,e!==this._ray&&(0,c.C)(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===d.RT.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,s.g)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,r,i,n){this.point=t,this.filterPredicate=i,this.tolerance=r??g;const s=(0,f.ou)(this.verticalOffset);if(e&&e.length>0){const t=n?e=>{n(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const r of e){const e=r.getSpatialQueryAccelerator?.();null!=e?(null!=s?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,s):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):r.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){const t=e.geometries;if(!t)return;const r=e.effectiveTransformation,i=(0,f.ou)(this.verticalOffset);for(const o of t){if(!o.visible)continue;const{material:t,id:a}=o;this.transform.setAndInvalidateLazyTransforms(r,o.transformation),(0,s.e)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),(0,s.e)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;null!=i&&(i.objectTransform=this.transform),t.intersect(o,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,r,i,s,o,c)=>{if(t>=0){if(null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;const d=s?this._results.hud:this._results,p=s?s=>{const l=new u.B$(e,a,i,c);s.set(h.dz.HUD,l,t,r,n.zK,o)}:n=>n.set(h.dz.OBJECT,{object:e,geometryId:a,triangleNr:i},t,r,l,o);if((null==d.min.drapedLayerOrder||o>=d.min.drapedLayerOrder)&&(null==d.min.dist||t<d.min.dist)&&p(d.min),this.options.store!==h.oH.MIN&&(null==d.max.drapedLayerOrder||o<d.max.drapedLayerOrder)&&(null==d.max.dist||t>d.max.dist)&&p(d.max),this.options.store===h.oH.ALL)if(s){const e=new T(this._ray);p(e),this._results.hud.all.push(e)}else{const e=new O(this._ray);p(e),this._results.all.push(e)}}}))}}sortResults(e=this._results.all){e.sort(((e,t)=>e.dist!==t.dist?(e.dist??0)-(t.dist??0):e.drapedLayerOrder!==t.drapedLayerOrder?_(e.drapedLayerOrder,t.drapedLayerOrder):_(e.drapedLayerGraphicOrder,t.drapedLayerGraphicOrder)))}}function _(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}function v(e){return new m(e)}class y{constructor(){this.min=new O((0,c.vt)()),this.max=new O((0,c.vt)()),this.hud={min:new T((0,c.vt)()),max:new T((0,c.vt)()),all:new Array},this.ground=new O((0,c.vt)()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}}class O{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?((0,s.h)(b,this.ray.direction,this.dist),(0,s.l)(b)):null}getIntersectionPoint(e){return!!(0,p.i3)(this)&&((0,s.h)(b,this.ray.direction,this.dist),(0,s.g)(e,this.ray.origin,b),!0)}getTransformedNormal(e){return(0,s.c)(C,this.normal),C[3]=0,(0,a.t)(C,C,this.transformation),(0,s.c)(e,C),(0,s.n)(e,e)}constructor(e){this.intersector=h.dz.OBJECT,this.normal=(0,o.vt)(),this.transformation=(0,n.vt)(),this._ray=(0,c.vt)(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=h.dz.OBJECT,(0,c.C)(e,this._ray)}set(e,t,r,a,l,c,d){this.intersector=e,this.dist=r,(0,s.c)(this.normal,a??o.Cb),(0,i.C)(this.transformation,l??n.zK),this.target=t,this.drapedLayerOrder=c,this.drapedLayerGraphicOrder=d}copy(e){(0,c.C)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,s.c)(this.normal,e.normal),(0,i.C)(this.transformation,e.transformation)}}class T extends O{constructor(){super(...arguments),this.intersector=h.dz.HUD}}function w(e){return new O(e)}const b=(0,o.vt)(),C=(0,l.vt)()},30165:(e,t,r)=>{var i,n;r.d(t,{H6:()=>s,dz:()=>i,oH:()=>n}),function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL",e[e.TILES3D=8]="TILES3D"}(i||(i={}));class s{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=n.ALL}}!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(n||(n={}))},76388:(e,t,r)=>{r.d(t,{B$:()=>s,R6:()=>a});var i=r(19913);class n{constructor(e,t,r){this.object=e,this.geometryId=t,this.triangleNr=r}}class s extends n{constructor(e,t,r,n){super(e,t,r),this.center=null!=n?(0,i.o8)(n):null}}class o{constructor(e){this.layerUid=e}}class a extends o{constructor(e,t){super(e),this.graphicUid=t}}},96024:(e,t,r)=>{r.d(t,{f:()=>s});var i=r(19913);class n{constructor(e,t){this.vec3=e,this.id=t}}function s(e,t,r,s){return new n((0,i.fA)(e,t,r),s)}},80561:(e,t,r)=>{var i,n;r.d(t,{k:()=>n,q:()=>i}),function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(i||(i={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(n||(n={}))},54909:(e,t,r)=>{r.d(t,{B:()=>m});var i=r(25336),n=r(26110),s=r(80347),o=r(19913),a=r(69891),l=r(45773),c=r(10875),d=r(73411),h=r(61723),u=r(32685),p=r(26421),f=r(33763),g=r(93550);class m extends d.J{get geometries(){return this._geometries}get transformation(){return this._transformation??n.zK}set transformation(e){this._transformation=(0,i.C)(this._transformation??(0,n.vt)(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?(0,i.C)(this._shaderTransformation??(0,n.vt)(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=h.X.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new _),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){(0,p.vA)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("geometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,r=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:r}),(0,f.b)(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new u.X(c.Mg.MaskOccludee);for(const t of this._geometries)t.occludees=(0,g.Ci)(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=(0,g.PC)(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new u.X(c.Mg.Highlight);for(const t of this._geometries)t.highlights=(0,g.Ci)(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=(0,g.PC)(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return(0,i.lw)(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=(0,n.vt)()){return(0,i.lw)(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new v,this._validateBoundingVolume(this._bvWorldSpace,C.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new v,this._validateBoundingVolume(this._bvObjectSpace,C.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){const r=t===C.ObjectSpace;for(const t of this._geometries){const i=t.boundingInfo;i&&y(i,e,r?t.transformation:this.getCombinedShaderTransformation(t))}(0,s.m)((0,a.g)(e.bounds),e.min,e.max,.5);for(const t of this._geometries){const i=t.boundingInfo;if(null==i)continue;const n=r?t.transformation:this.getCombinedShaderTransformation(t),o=(0,l.hG)(n);(0,s.e)(b,i.center,n);const c=(0,s.q)(b,(0,a.g)(e.bounds)),d=i.radius*o;e.bounds[3]=Math.max(e.bounds[3],c+d)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,t){this._parentLayer&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}}class _{constructor(){this.min=(0,o.fA)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,o.fA)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class v extends _{constructor(){super(...arguments),this.bounds=(0,a.c)()}}function y(e,t,r){const n=e.bbMin,o=e.bbMax;if((0,i.tZ)(r)){const e=(0,s.s)(O,r[12],r[13],r[14]);(0,s.g)(T,n,e),(0,s.g)(w,o,e);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],T[e]),t.max[e]=Math.max(t.max[e],w[e])}else if((0,s.e)(T,n,r),(0,s.j)(n,o))for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],T[e]),t.max[e]=Math.max(t.max[e],T[e]);else{(0,s.e)(w,o,r);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],T[e],w[e]),t.max[e]=Math.max(t.max[e],T[e],w[e]);for(let e=0;e<3;++e){(0,s.c)(T,n),(0,s.c)(w,o),T[e]=o[e],w[e]=n[e],(0,s.e)(T,T,r),(0,s.e)(w,w,r);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],T[e],w[e]),t.max[e]=Math.max(t.max[e],T[e],w[e])}}}const O=(0,o.vt)(),T=(0,o.vt)(),w=(0,o.vt)(),b=(0,o.vt)();var C,S;(S=C||(C={}))[S.WorldSpace=0]="WorldSpace",S[S.ObjectSpace=1]="ObjectSpace"},935:(e,t,r)=>{r.d(t,{A:()=>H});var i,n,s=r(39744),o=r(41785),a=r(80347),l=r(19913),c=r(74224),d=r(63918),h=r(69891),u=r(26421);class p{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new f,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),f.clearPool(),S[0]=null,D.prune(),L.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const r=f.acquire();for(let i=0;i<t;i++){const t=e[i];this._isDegenerate(t)?this._degenerateObjects.add(t):(r.init(this._root),this._add(t,r))}f.release(r)}remove(e,t=null){this._objectCount-=e.length;const r=f.acquire();for(const i of e){const e=t??(0,h.a)(this.objectToBoundingSphere(i),P);T(e[3])?(r.init(this._root),this._remove(i,e,r)):this._degenerateObjects.delete(i)}f.release(r),this._shrink()}update(e,t){if(!T(t[3])&&this._isDegenerate(e))return;const r=function(e){return S[0]=e,S}(e);this.remove(r,t),this.add(r)}forEachAlongRay(e,t,r){const i=(0,d.LV)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(i,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,r,i){const n=(0,d.LV)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(n,e,i))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(n,e,i)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(n,e,i)&&r(e)})),!0}))}forEach(e){this._forEachNode(this._root,(t=>{const r=t.node;return r.terminals.forAll(e),null!==r.residents&&r.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,r,i=(()=>!0),n=1/0){let s=1/0,o=1/0,l=null;const d=y(e,t),u=a=>{if(--n,!i(a))return;const d=this.objectToBoundingSphere(a);if(!(0,c.m7)(r,d))return;const u=O(e,t,(0,h.g)(d)),p=u-d[3],f=u+d[3];p<s&&(s=p,o=f,l=a)};return this._forEachNodeDepthOrdered(this._root,(i=>{if(n<=0||!(0,c.m7)(r,i.bounds))return!1;if((0,a.h)(x,d,i.halfSize),(0,a.g)(x,x,(0,h.g)(i.bounds)),O(e,t,x)>o)return!1;const s=i.node;return s.terminals.forAll((e=>u(e))),null!==s.residents&&s.residents.forAll((e=>u(e))),!0}),e,t),l}forEachInDepthRange(e,t,r,i,n,s,o){let l=-1/0,d=1/0;const u={setRange:e=>{r===p.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,e.near),d=Math.min(d,e.far)):(l=Math.max(l,-e.far),d=Math.min(d,-e.near))}};u.setRange(i);const f=O(t,r,e),g=y(t,r),m=y(t,-r),_=e=>{if(!o(e))return;const i=this.objectToBoundingSphere(e),a=(0,h.g)(i),p=O(t,r,a)-f,g=p-i[3],m=p+i[3];g>d||m<l||!(0,c.m7)(s,i)||n(e,u)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!(0,c.m7)(s,e.bounds))return!1;if((0,a.h)(x,g,e.halfSize),(0,a.g)(x,x,(0,h.g)(e.bounds)),O(t,r,x)-f>d)return!1;if((0,a.h)(x,m,e.halfSize),(0,a.g)(x,x,(0,h.g)(e.bounds)),O(t,r,x)-f<l)return!1;const i=e.node;return i.terminals.forAll((e=>_(e))),null!==i.residents&&i.residents.forAll((e=>_(e))),!0}),t,r)}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize,t.depth)))}forEachNeighbor(e,t){const r=(0,h.b)(t),i=(0,h.g)(t),n=t=>{const n=this.objectToBoundingSphere(t),s=(0,h.b)(n),o=r+s;return!((0,a.a)((0,h.g)(n),i)-o*o<=0)||e(t)};let s=!0;const o=e=>{s&&(s=n(e))};this._forEachNode(this._root,(e=>{const t=(0,h.b)(e.bounds),n=r+t;if((0,a.a)((0,h.g)(e.bounds),i)-n*n>0)return!1;const l=e.node;return l.terminals.forAll(o),s&&null!==l.residents&&l.residents.forAll(o),s})),s&&this.forEachDegenerateObject(o)}_intersectsNode(e,t){return _((0,h.g)(t.bounds),2*-t.halfSize,R),_((0,h.g)(t.bounds),2*t.halfSize,E),(0,u.O_)(e.origin,e.direction,R,E)}_intersectsNodeWithOffset(e,t,r){return _((0,h.g)(t.bounds),2*-t.halfSize,R),_((0,h.g)(t.bounds),2*t.halfSize,E),r.applyToMinMax(R,E),(0,u.O_)(e.origin,e.direction,R,E)}_intersectsObject(e,t){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||(0,h.j)(r,e)}_intersectsObjectWithOffset(e,t,r){const i=this.objectToBoundingSphere(t);return!(i[3]>0)||(0,h.j)(r.applyToBoundingSphere(i),e)}_forEachNode(e,t){let r=f.acquire().init(e);const i=[r];for(;0!==i.length;){if(r=i.pop(),t(r)&&!r.isLeaf())for(let e=0;e<r.node.children.length;e++)r.node.children[e]&&i.push(f.acquire().init(r).advance(e));f.release(r)}}_forEachNodeDepthOrdered(e,t,r,i=p.DepthOrder.FRONT_TO_BACK){let n=f.acquire().init(e);const s=[n];for(function(e,t,r){if(!L.length)for(let e=0;e<8;++e)L.push({index:0,distance:0});for(let r=0;r<8;++r){const i=w[r];L.data[r].index=r,L.data[r].distance=O(e,t,i)}L.sort(((e,t)=>e.distance-t.distance));for(let e=0;e<8;++e)r[e]=L.data[e].index}(r,i,z);0!==s.length;){if(n=s.pop(),t(n)&&!n.isLeaf())for(let e=7;e>=0;--e){const t=z[e];n.node.children[t]&&s.push(f.acquire().init(n).advance(t))}f.release(n)}}_remove(e,t,r){D.clear();const i=r.advanceTo(t,((e,t)=>{D.push(e.node),D.push(t)}))?r.node.terminals:r.node.residents;if(i.removeUnordered(e),0===i.length)for(let e=D.length-2;e>=0;e-=2){const t=D.data[e],r=D.data[e+1];if(!this._purge(t,r))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new o.A({shrink:!0})),!0)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let r=0;r<t.length;r++){const i=f.acquire().init(e);this._add(t.at(r),i),f.release(i)}}_grow(e,t){if(0!==t&&(v(e,t,(e=>this.objectToBoundingSphere(e)),M),T(M[3])&&!this._fitsInsideTree(M)))if(this._nodeIsEmpty(this._root.node))(0,h.a)(M,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(M);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(M,e):this._growRootAsSubNode(e),f.release(e)}}_rebuildTree(e,t){(0,a.c)((0,h.g)(I),(0,h.g)(t.bounds)),I[3]=t.halfSize,v([e,I],2,(e=>e),N);const r=f.acquire().init(this._root);this._root.initFrom(null,N,N[3]),this._root.increaseHalfSize(1.25),this._forEachNode(r,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),f.release(r)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return this._forEachNode(this._root,(e=>(r=Math.max(r,e.depth),r+t<=this._maximumDepth))),r+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],r=e;let i=-1/0;const n=this._root.bounds,s=this._root.halfSize;for(let e=0;e<3;e++){const o=n[e]-s-(r[e]-t),a=r[e]+t-(n[e]+s),l=Math.max(0,Math.ceil(o/(2*s))),c=Math.max(0,Math.ceil(a/(2*s)))+1,d=2**Math.ceil(Math.log(l+c)*Math.LOG2E);i=Math.max(i,d),F[e].min=l,F[e].max=c}for(let e=0;e<3;e++){let t=F[e].min,r=F[e].max;const o=(i-(t+r))/2;t+=Math.ceil(o),r+=Math.floor(o);const a=n[e]-s-t*s*2;A[e]=a+(r+t)*s}const o=i*s;return A[3]=o*C,f.acquire().initFrom(null,A,o,0)}_growRootAsSubNode(e){const t=this._root.node;(0,a.c)((0,h.g)(M),(0,h.g)(this._root.bounds)),M[3]=this._root.halfSize,this._root.init(e),e.advanceTo(M,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let r=0,i=0;for(;i<t.length&&null==e;)r=i++,e=t[r];for(;i<t.length;)if(t[i++])return-1;return r}_isDegenerate(e){return!T(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=t[0]-r&&e[0]<=t[0]+r&&e[1]>=t[1]-r&&e[1]<=t[1]+r&&e[2]>=t[2]-r&&e[2]<=t[2]+r}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:r}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:r,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(e){const t=e.children.map((e=>e?this._nodeToJSON(e):null)),r=e.residents?.map((e=>this.objectToBoundingSphere(e))),i=e.terminals?.map((e=>this.objectToBoundingSphere(e)));return{children:t,residents:r,terminals:i}}static fromJSON(e){const t=new p((e=>e),{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class f{constructor(){this.bounds=(0,h.c)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,r,i=this.depth){return this.node=null!=e?e:f.createEmptyNode(),t&&(0,h.a)(t,this.bounds),this.halfSize=r,this.depth=i,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*C}advance(e){let t=this.node.children[e];t||(t=f.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const r=w[e];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,r=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!r)return t&&t(this,-1),!1;this.node.residents=null}const i=this._childIndex(e);t&&t(this,i),this.advance(i)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new o.A({shrink:!0}),residents:new o.A({shrink:!0})}}static acquire(){return f._pool.acquire()}static release(e){f._pool.release(e)}static clearPool(){f._pool.prune()}}function g(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function m(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function _(e,t,r){r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t}function v(e,t,r,i){if(1===t){const t=r(e[0]);(0,h.a)(t,i)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,E[0]=-1/0,E[1]=-1/0,E[2]=-1/0;for(let i=0;i<t;i++){const t=r(e[i]);T(t[3])&&(g(R,t),m(E,t))}(0,a.m)((0,h.g)(i),R,E,.5),i[3]=Math.max(E[0]-R[0],E[1]-R[1],E[2]-R[2])/2}}function y(e,t){let r,i=1/0;for(let n=0;n<8;++n){const s=O(e,t,b[n]);s<i&&(i=s,r=b[n])}return r}function O(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}function T(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}f._pool=new s.A(f),i=p||(p={}),(n=i.DepthOrder||(i.DepthOrder={}))[n.FRONT_TO_BACK=1]="FRONT_TO_BACK",n[n.BACK_TO_FRONT=-1]="BACK_TO_FRONT";const w=[(0,l.fA)(-1,-1,-1),(0,l.fA)(1,-1,-1),(0,l.fA)(-1,1,-1),(0,l.fA)(1,1,-1),(0,l.fA)(-1,-1,1),(0,l.fA)(1,-1,1),(0,l.fA)(-1,1,1),(0,l.fA)(1,1,1)],b=[(0,l.fA)(-1,-1,-1),(0,l.fA)(-1,-1,1),(0,l.fA)(-1,1,-1),(0,l.fA)(-1,1,1),(0,l.fA)(1,-1,-1),(0,l.fA)(1,-1,1),(0,l.fA)(1,1,-1),(0,l.fA)(1,1,1)],C=Math.sqrt(3),S=[null],A=(0,h.c)(),x=(0,l.vt)(),R=(0,l.vt)(),E=(0,l.vt)(),D=new o.A,P=(0,h.c)(),M=(0,h.c)(),I=(0,h.c)(),N=(0,h.c)(),F=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],L=new o.A,z=[0,0,0,0,0,0,0,0],H=p},35537:(e,t,r)=>{r.d(t,{$:()=>c});var i=r(78851),n=r(25336),s=r(26110),o=r(80347),a=r(69891),l=r(45773);class c{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=(0,s.vt)(),this._shaderTransformation=null,this._boundingSphere=null,this.id=(0,i.c)(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,null!=t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){(0,n.C)(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=(0,s.vt)(),(0,n.lw)(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=(0,a.c)(),(0,o.e)((0,a.g)(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*(0,l.hG)(this.shaderTransformation)),this._boundingSphere):a.N}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}},34402:(e,t,r)=>{var i;r.d(t,{q:()=>i}),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(i||(i={}))},5801:(e,t,r)=>{r.d(t,{Z:()=>n});var i=r(40866);class n extends i.Z{}},5415:(e,t,r)=>{r.d(t,{x:()=>u});var i=r(57888),n=r(56802),s=r(57725),o=r(41785),a=r(73411),l=r(61723);const c=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var d=r(935),h=r(34402);class u extends a.J{get objects(){return this._objects}constructor(e,t,r=""){super(),this.stage=e,this.apiLayerUid=r,this.type=l.X.Layer,this.events=new i.A,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new o.A,this._objectsAdded=new o.A,this._handles=new n.A,this.apiLayerUid=r,this.visible=t?.visible??!0,this.pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??h.q.ASYNC,this._disableOctree=t?.disableOctree??!1,e.add(this);for(const t of c)this._handles.add(this.events.on(t,(r=>e.handleEvent(t,r))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),null!=this._octree&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),null!=this._octree&&this._objectsAdded.pushArray(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),null!=this._octree){for(let e=0;e<t.length;)this._objectsAdded.removeUnordered(t[e])?(t[e]=t[t.length-1],t.length-=1):++e;this._octree.remove(t)}}}sync(){this.updatePolicy!==h.q.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.length>50&&!this._disableOctree?(this._octree=new d.A((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=(0,s.pR)(this._octree),this._objectsAdded.clear()}}},2680:(e,t,r)=>{r.d(t,{i3:()=>n}),r(80347);var i=r(19913);function n(e){return null!=e?.dist}r(7775),r(30165),(0,i.vt)()},58304:(e,t,r)=>{r.d(t,{G:()=>i,Q:()=>n});const i={stableRendering:!1},n={rootOrigin:null}},29239:(e,t,r)=>{r.d(t,{v:()=>E});var i=r(6273),n=r(76982),s=r(7724),o=r(77788),a=r(10875),l=r(76687),c=r(8445),d=r(15449),h=r(33763),u=r(66356),p=r(59615),f=r(34383),g=r(21979),m=r(19362),_=r(74242),v=r(24441),y=r(28116),O=r(7782),T=r(38382),w=r(15651);f.S;class b extends m.w{initializeProgram(e){return new v.B(e.rctx,b.shader.get().build(this.configuration),_.D)}_createPipeline(e,t){const r=this.configuration,i=e===O.y.NONE,n=e===O.y.FrontFace;return(0,w.Ey)({blending:r.output!==o.V.Color&&r.output!==o.V.Alpha||!r.transparent?null:i?c.V0:(0,c.ez)(e),culling:(0,w.Xt)(r.cullFace),depthTest:r.draped?null:{func:(0,c.K_)(e)},depthWrite:r.draped?null:(i||n)&&r.writeDepth?w.kn:null,colorWrite:w.wE,stencilWrite:r.hasOccludees?y.v0:null,stencilTest:r.hasOccludees?t?y.a9:y.qh:null,polygonOffset:i||n?r.polygonOffset?C:null:(0,c.aB)(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}b.shader=new g.$(T.C,(()=>r.e(5918).then(r.bind(r,55918))));const C={factor:1,units:1};var S=r(82392),A=r(51662),x=r(18693);class R extends x.E{constructor(){super(...arguments),this.output=o.V.Color,this.cullFace=a.s2.None,this.transparencyPassType=O.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1}}(0,S._)([(0,A.W)({count:o.V.COUNT})],R.prototype,"output",void 0),(0,S._)([(0,A.W)({count:a.s2.COUNT})],R.prototype,"cullFace",void 0),(0,S._)([(0,A.W)({count:O.y.COUNT})],R.prototype,"transparencyPassType",void 0),(0,S._)([(0,A.W)()],R.prototype,"hasSlicePlane",void 0),(0,S._)([(0,A.W)()],R.prototype,"hasVertexColors",void 0),(0,S._)([(0,A.W)()],R.prototype,"transparent",void 0),(0,S._)([(0,A.W)()],R.prototype,"polygonOffset",void 0),(0,S._)([(0,A.W)()],R.prototype,"enableOffset",void 0),(0,S._)([(0,A.W)()],R.prototype,"writeDepth",void 0),(0,S._)([(0,A.W)()],R.prototype,"hasOccludees",void 0),(0,S._)([(0,A.W)()],R.prototype,"multipassEnabled",void 0),(0,S._)([(0,A.W)()],R.prototype,"cullAboveGround",void 0),(0,S._)([(0,A.W)()],R.prototype,"objectAndLayerIdColorInstanced",void 0),(0,S._)([(0,A.W)()],R.prototype,"vvColor",void 0),(0,S._)([(0,A.W)()],R.prototype,"draped",void 0),(0,S._)([(0,A.W)({constValue:!1})],R.prototype,"occlusionPass",void 0),(0,S._)([(0,A.W)({constValue:!0})],R.prototype,"hasVvInstancing",void 0),(0,S._)([(0,A.W)({constValue:!1})],R.prototype,"vvSize",void 0),(0,S._)([(0,A.W)({constValue:!1})],R.prototype,"vvOpacity",void 0);class E extends p.W{constructor(e){super(e,new P),this.supportsEdges=!0,this.produces=new Map([[d.N.OPAQUE_MATERIAL,e=>e===o.V.Highlight||(0,o.BF)(e)&&!this._isTransparent],[d.N.OPAQUE_NO_SSAO_DEPTH,e=>e===o.V.LinearDepth&&this.parameters.writeLinearDepth&&!this._isTransparent],[d.N.TRANSPARENT_MATERIAL,e=>(0,o.BF)(e)&&this._isTransparent&&this.parameters.writeDepth],[d.N.TRANSPARENT_NO_SSAO_DEPTH,e=>e===o.V.LinearDepth&&this.parameters.writeLinearDepth&&this._isTransparent&&this.parameters.writeDepth],[d.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>((0,o.BF)(e)||e===o.V.LinearDepth&&this.parameters.writeLinearDepth)&&this._isTransparent&&!this.parameters.writeDepth],[d.N.DRAPED_MATERIAL,e=>(0,o.i3)(e)]]),this._configuration=new R}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<c.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}createGLMaterial(e){return new D(e)}createBufferWriter(){const e=(0,s.BP)().vec3f(h.r.POSITION);return(0,i.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(h.r.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(h.r.COLORFEATUREATTRIBUTE):e.vec4u8(h.r.COLOR),new u.Z(e)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}}class D extends l.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==o.V.Color&&this._output!==o.V.Alpha||this._updateOccludeeState(e),this.ensureTechnique(b,e)}}class P extends f.S{constructor(){super(...arguments),this.color=n.uY,this.forceTransparentMode=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=a.s2.None,this.hasOccludees=!1,this.draped=!1}}},83938:(e,t,r)=>{r.d(t,{Ci:()=>s,Dq:()=>l,dB:()=>a,zK:()=>o});var i=r(7724),n=r(33763);const s=(0,i.BP)().vec3f(n.r.POSITION),o=(0,i.BP)().vec3f(n.r.POSITION).vec2f(n.r.UV0),a=(0,i.BP)().vec3f(n.r.POSITION).vec4u8(n.r.COLOR),l=((0,i.BP)().vec3f(n.r.POSITION).vec4u8(n.r.OBJECTANDLAYERIDCOLOR),(0,i.BP)().vec3f(n.r.POSITION).vec2f(n.r.UV0).vec4u8(n.r.OBJECTANDLAYERIDCOLOR));(0,i.BP)().vec3f(n.r.POSITION).vec4u8(n.r.COLOR).vec4u8(n.r.OBJECTANDLAYERIDCOLOR)},88417:(e,t,r)=>{r.d(t,{R:()=>Z});var i=r(6273),n=r(4506),s=r(82541),o=r(79441),a=r(25336),l=r(26110),c=r(56560),d=r(80347),h=r(19913),u=r(76982);var p=r(2532),f=r(40041),g=r(15061),m=r(31882),_=r(7724),v=r(77788),y=r(87331),O=r(71678),T=r(31272),w=r(15449),b=r(84231),C=r(26421),S=r(33763);class A{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var x=r(29290),R=r(73395),E=r(32052),D=r(84456),P=r(21979),M=r(19362),I=r(74242),N=r(8445),F=r(24441),L=r(7782),z=r(68716),H=r(15651);class V extends M.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===D.RT.Global}initializeProgram(e){return new F.B(e.rctx,V.shader.get().build(this.configuration),I.D)}initializePipeline(){const e=this.configuration.transparencyPassType,t=this.configuration,r=e===L.y.NONE,i=e===L.y.FrontFace,n=this.configuration.hasPolygonOffset?j:null,s=t.draped?null:(r||i)&&t.output!==v.V.Highlight&&(t.depthEnabled||t.occlusionPass)?H.kn:null;return(0,H.Ey)({blending:t.output===v.V.Color||t.output===v.V.Alpha||t.output===v.V.Highlight?r?B:(0,N.ez)(e):null,depthTest:t.draped?null:{func:z.MT.LEQUAL},depthWrite:s,colorWrite:H.wE,polygonOffset:n})}get primitiveType(){return this.configuration.occlusionPass?z.WR.POINTS:z.WR.TRIANGLES}}V.shader=new P.$(E.H,(()=>r.e(6884).then(r.bind(r,56884))));const j={factor:0,units:-4},B=(0,H.ox)(z.dn.ONE,z.dn.ONE_MINUS_SRC_ALPHA);var U=r(82392),W=r(51662),G=r(18693);class k extends G.E{constructor(){super(...arguments),this.output=v.V.Color,this.transparencyPassType=L.y.NONE,this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}}(0,U._)([(0,W.W)({count:v.V.COUNT})],k.prototype,"output",void 0),(0,U._)([(0,W.W)({count:L.y.COUNT})],k.prototype,"transparencyPassType",void 0),(0,U._)([(0,W.W)()],k.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,U._)([(0,W.W)()],k.prototype,"spherical",void 0),(0,U._)([(0,W.W)()],k.prototype,"occlusionTestEnabled",void 0),(0,U._)([(0,W.W)()],k.prototype,"signedDistanceFieldEnabled",void 0),(0,U._)([(0,W.W)()],k.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,U._)([(0,W.W)()],k.prototype,"vvSize",void 0),(0,U._)([(0,W.W)()],k.prototype,"vvColor",void 0),(0,U._)([(0,W.W)()],k.prototype,"hasVerticalOffset",void 0),(0,U._)([(0,W.W)()],k.prototype,"hasScreenSizePerspective",void 0),(0,U._)([(0,W.W)()],k.prototype,"debugDrawLabelBorder",void 0),(0,U._)([(0,W.W)()],k.prototype,"hasSlicePlane",void 0),(0,U._)([(0,W.W)()],k.prototype,"hasPolygonOffset",void 0),(0,U._)([(0,W.W)()],k.prototype,"depthEnabled",void 0),(0,U._)([(0,W.W)()],k.prototype,"pixelSnappingEnabled",void 0),(0,U._)([(0,W.W)()],k.prototype,"draped",void 0),(0,U._)([(0,W.W)()],k.prototype,"multipassEnabled",void 0),(0,U._)([(0,W.W)()],k.prototype,"cullAboveGround",void 0),(0,U._)([(0,W.W)()],k.prototype,"occlusionPass",void 0),(0,U._)([(0,W.W)()],k.prototype,"objectAndLayerIdColorInstanced",void 0),(0,U._)([(0,W.W)({constValue:!0})],k.prototype,"hasSliceInVertexProgram",void 0),(0,U._)([(0,W.W)({constValue:!1})],k.prototype,"hasVvInstancing",void 0);class Z extends T.im{constructor(e){super(e,new ue),this._configuration=new k,this.produces=new Map([[w.N.HUD_MATERIAL,e=>(0,v.L0)(e)&&!this.parameters.drawInSecondSlot],[w.N.LABEL_MATERIAL,e=>(0,v.L0)(e)&&this.parameters.drawInSecondSlot],[w.N.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[w.N.DRAPED_MATERIAL,e=>(0,v.L0)(e)]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=t.slot===w.N.OCCLUSION_PIXELS&&this.parameters.occlusionTest,e===v.V.Color&&(this._configuration.debugDrawLabelBorder=!!m.b.LABELS_SHOW_BORDER),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(e,t,r,i,n,o){if(!(r.options.selectionMode&&r.options.hud&&e.visible&&r.point))return;const l=this.parameters,c=r.point,u=r.camera;let{scaleX:p,scaleY:f}=this._getScreenScale(e);p*=u.pixelRatio,f*=u.pixelRatio,(0,s.z0)(te,t),e.attributes.has(S.r.FEATUREATTRIBUTE)&&function(e){const t=e[0],r=e[1],i=e[2],n=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],d=1/Math.sqrt(t*t+r*r+i*i),h=1/Math.sqrt(n*n+s*s+o*o),u=1/Math.sqrt(a*a+l*l+c*c);e[0]=t*d,e[1]=r*d,e[2]=i*d,e[3]=n*h,e[4]=s*h,e[5]=o*h,e[6]=a*u,e[7]=l*u,e[8]=c*u}(te);const g=e.attributes.get(S.r.POSITION),m=e.attributes.get(S.r.SIZE),_=e.attributes.get(S.r.NORMAL),v=e.attributes.get(S.r.CENTEROFFSETANDDISTANCE);(0,C.vA)(g.size>=3);const y=(0,E.c)(l),O="screen"===this.parameters.centerOffsetUnits;for(let e=0;e<g.data.length/g.size;e++){const i=e*g.size;(0,d.s)(X,g.data[i],g.data[i+1],g.data[i+2]),(0,d.e)(X,X,t);const n=e*m.size;de[0]=m.data[n]*p,de[1]=m.data[n+1]*f,(0,d.e)(X,X,u.viewMatrix);const s=e*v.size;if((0,d.s)(ne,v.data[s],v.data[s+1],v.data[s+2]),!O&&(X[0]+=ne[0],X[1]+=ne[1],0!==ne[2])){const e=ne[2];(0,d.n)(ne,X),(0,d.f)(X,X,(0,d.h)(ne,ne,e))}const T=e*_.size;if((0,d.s)(Q,_.data[T],_.data[T+1],_.data[T+2]),this._normalAndViewAngle(Q,te,u,ae),this._applyVerticalOffsetTransformationView(X,ae,u,Y),u.applyProjection(X,J),J[0]>-1){O&&(ne[0]||ne[1])&&(J[0]+=ne[0]*u.pixelRatio,0!==ne[1]&&(J[1]+=(0,b.m0)(ne[1],Y.factorAlignment)*u.pixelRatio),u.unapplyProjection(J,X)),J[0]+=this.parameters.screenOffset[0]*u.pixelRatio,J[1]+=this.parameters.screenOffset[1]*u.pixelRatio,J[0]=Math.floor(J[0]),J[1]=Math.floor(J[1]),(0,b.MD)(de,Y.factor,de);const e=le*u.pixelRatio;let t=0;if(l.textureIsSignedDistanceField&&(t=l.outlineSize*u.pixelRatio/2),$(c,J[0],J[1],de,e,t,l,y)){const e=r.ray;if((0,d.e)(ee,X,(0,a.B8)(ie,u.viewMatrix)),J[0]=c[0],J[1]=c[1],u.unprojectFromRenderScreen(J,X)){const t=(0,h.vt)();(0,d.c)(t,e.direction);const r=1/(0,d.l)(t);(0,d.h)(t,t,r),o((0,d.q)(e.origin,X)*r,t,-1,!0,1,ee)}}}}}intersectDraped(e,t,r,i,n,s){const o=e.attributes.get(S.r.POSITION),a=e.attributes.get(S.r.SIZE),l=this.parameters,c=(0,E.c)(l);let{scaleX:d,scaleY:h}=this._getScreenScale(e);d*=e.screenToWorldRatio,h*=e.screenToWorldRatio;const u=ce*e.screenToWorldRatio;for(let t=0;t<o.data.length/o.size;t++){const r=t*o.size,p=o.data[r],f=o.data[r+1],g=t*a.size;de[0]=a.data[g]*d,de[1]=a.data[g+1]*h;let m=0;l.textureIsSignedDistanceField&&(m=l.outlineSize*e.screenToWorldRatio/2),$(i,p,f,de,u,m,l,c)&&n(s.dist,s.normal,-1,!1)}}createBufferWriter(){return new ge(this)}_normalAndViewAngle(e,t,r,i){return function(e){return(t=e)instanceof Float32Array&&t.length>=16||function(e){return Array.isArray(e)&&e.length>=16}(e);var t}(t)&&(t=(0,s.z0)(re,t)),(0,d.t)(i.normal,e,t),(0,d.e)(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=(0,d.k)(K,he),i}_updateScaleInfo(e,t,r){const i=this.parameters;null!=i.screenSizePerspective?(0,b.cJ)(r,t,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),null!=i.screenSizePerspectiveAlignment?(0,b.cJ)(r,t,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,t,r,i,n,s,o){const a=this._normalAndViewAngle(t,r,n,ae);return this._applyVerticalGroundOffsetView(e,a,n,o),this._applyVerticalOffsetTransformationView(o,a,n,s),this._applyPolygonOffsetView(o,a,i[3],n,o),this._applyCenterOffsetView(o,i,o),o}applyShaderOffsetsNDC(e,t,r,i,n){return this._applyCenterOffsetNDC(e,t,r,i),null!=n&&(0,d.c)(n,i),this._applyPolygonOffsetNDC(i,t,r,i),i}_applyPolygonOffsetView(e,t,r,i,s){const o=i.aboveGround?1:-1;let a=Math.sign(r);0===a&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return(0,d.c)(s,e);const c=(0,n.qE)(Math.abs(t.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/i.viewport[2];return(0,d.h)(s,e,l>0?h:1/h),s}_applyVerticalGroundOffsetView(e,t,r,i){const n=(0,d.l)(e),s=r.aboveGround?1:-1,o=r.computeRenderPixelSizeAtDist(n)*y.R,a=(0,d.h)(X,t.normal,s*o);return(0,d.g)(i,e,a),i}_applyVerticalOffsetTransformationView(e,t,r,i){const n=this.parameters;if(!n.verticalOffset?.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const r=(0,d.l)(e);this._updateScaleInfo(i,r,t.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}const s=(0,d.l)(e),o=n.screenSizePerspectiveAlignment??n.screenSizePerspective,a=(0,R.kE)(r,s,n.verticalOffset,t.cosAngle,o);return this._updateScaleInfo(i,s,t.cosAngle),(0,d.h)(t.normal,t.normal,a),(0,d.g)(e,e,t.normal)}_applyCenterOffsetView(e,t,r){const i="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,d.c)(r,e),i&&(r[0]+=t[0],r[1]+=t[1],t[2]&&((0,d.n)(Q,r),(0,d.g)(r,r,(0,d.h)(Q,Q,t[2])))),r}_applyCenterOffsetNDC(e,t,r,i){const n="screen"!==this.parameters.centerOffsetUnits;return i!==e&&(0,d.c)(i,e),n||(i[0]+=t[0]/r.fullWidth*2,i[1]+=t[1]/r.fullHeight*2),i}_applyPolygonOffsetNDC(e,t,r,i){const n=this.parameters.shaderPolygonOffset;if(e!==i&&(0,d.c)(i,e),n){const e=r.aboveGround?1:-1,s=e*Math.sign(t[3]);i[2]-=(s||e)*n}return i}createGLMaterial(e){return new q(e)}calculateRelativeScreenBounds(e,t,r=(0,p.vt)()){return function(e,t,r,i){i[0]=e.anchorPosition[0]*-t[0]+e.screenOffset[0]*r,i[1]=e.anchorPosition[1]*-t[1]+e.screenOffset[1]*r}(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}_getScreenScale(e){const t=e.attributes.get(S.r.FEATUREATTRIBUTE);if(null==t)return{scaleX:1,scaleY:1};const r=(0,u.ci)(t.data,oe),[i,n]=(0,g.VC)(se,this.parameters,r);return{scaleX:i,scaleY:n}}}class q extends O.m{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(V,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}}function $(e,t,r,i,n,s,o,a){let l=t-n-(a[0]>0?i[0]*a[0]:0),c=l+i[0]+2*n,d=r-n-(a[1]>0?i[1]*a[1]:0),h=d+i[1]+2*n;const u=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&null!=u&&(l+=i[0]*u[0],d+=i[1]*u[1],c-=i[0]*(1-u[2]),h-=i[1]*(1-u[3]),l-=s,c+=s,d-=s,h+=s),e[0]>l&&e[0]<c&&e[1]>d&&e[1]<h}const Y=new class{constructor(){this.factor=new A,this.factorAlignment=new A}},X=(0,h.vt)(),Q=(0,h.vt)(),J=(0,u.vt)(),K=(0,h.vt)(),ee=(0,h.vt)(),te=(0,o.vt)(),re=(0,o.vt)(),ie=(0,l.vt)(),ne=(0,h.vt)(),se=(0,h.vt)(),oe=(0,u.vt)(),ae={normal:K,cosAngle:0},le=1,ce=2,de=[0,0],he=(0,h.fA)(0,0,1);class ue extends O.N{constructor(){super(...arguments),this.renderOccluded=T.m$.Occlude,this.isDecoration=!1,this.color=(0,u.fA)(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=(0,c.fA)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,u.fA)(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1}}const pe=(0,_.BP)().vec3f(S.r.POSITION).vec3f(S.r.NORMAL).vec2f(S.r.UV0).vec4u8(S.r.COLOR).vec2f(S.r.SIZE).vec4f(S.r.CENTEROFFSETANDDISTANCE).vec4f(S.r.FEATUREATTRIBUTE),fe=pe.clone().vec4u8(S.r.OBJECTANDLAYERIDCOLOR);class ge{constructor(e){this._material=e,this.vertexBufferLayout=(0,i.A)("enable-feature:objectAndLayerId-rendering")?fe:pe}elementCount(e){return 6*e.attributes.get(S.r.POSITION).indices.length}write(e,t,r,i,n){(0,x.Hk)(r.attributes.get(S.r.POSITION),e,i.position,n,6),(0,x.p1)(r.attributes.get(S.r.NORMAL),t,i.normal,n,6);const s=r.attributes.get(S.r.UV0).data;let o,a,l,c;if(null==s||s.length<4){const e=this._material.parameters;o=0,a=0,l=e.texCoordScale[0],c=e.texCoordScale[1]}else o=s[0],a=s[1],l=s[2],c=s[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);let d=r.attributes.get(S.r.POSITION).indices.length,h=n;const u=i.uv0;for(let e=0;e<d;++e)u.set(h,0,o),u.set(h,1,a),h++,u.set(h,0,l),u.set(h,1,a),h++,u.set(h,0,l),u.set(h,1,c),h++,u.set(h,0,l),u.set(h,1,c),h++,u.set(h,0,o),u.set(h,1,c),h++,u.set(h,0,o),u.set(h,1,a),h++;(0,x.tb)(r.attributes.get(S.r.COLOR),4,i.color,n,6);const{data:p,indices:g}=r.attributes.get(S.r.SIZE);d=g.length;const m=i.size;h=n;for(let e=0;e<d;++e){const t=p[2*g[e]],r=p[2*g[e]+1];for(let e=0;e<6;++e)m.set(h,0,t),m.set(h,1,r),h++}if(r.attributes.get(S.r.CENTEROFFSETANDDISTANCE)?(0,x.Ut)(r.attributes.get(S.r.CENTEROFFSETANDDISTANCE),i.centerOffsetAndDistance,n,6):(0,x.Pq)(i.centerOffsetAndDistance,n,6*d),r.attributes.get(S.r.FEATUREATTRIBUTE)?(0,x.Ut)(r.attributes.get(S.r.FEATUREATTRIBUTE),i.featureAttribute,n,6):(0,x.Pq)(i.featureAttribute,n,6*d),null!=r.objectAndLayerIdColor){const e=r.attributes.get(S.r.POSITION)?.indices;if(e){const t=e.length,s=i.getField(S.r.OBJECTANDLAYERIDCOLOR,f.XP);(0,x.tH)(r.objectAndLayerIdColor,s,t,n,6)}}}}},16596:(e,t,r)=>{r.d(t,{W:()=>H});var i=r(6273),n=r(80861),s=r(4506),o=r(23572),a=r(53334),l=r(80347),c=r(19913),d=r(76982),h=r(74224),u=r(94669),p=r(87368),f=r(7724),g=r(77788),m=r(76687),_=r(31272),v=r(15449),y=r(26421),O=r(33763),T=r(34383),w=r(18994),b=r(46348),C=r(21979),S=r(19362),A=r(8445),x=r(24441),R=r(28116),E=r(7782),D=r(68716),P=r(15651);const M=new Map([[O.r.POSITION,0],[O.r.PREVPOSITION,1],[O.r.NEXTPOSITION,2],[O.r.SUBDIVISIONFACTOR,3],[O.r.UV0,4],[O.r.COLOR,5],[O.r.COLORFEATUREATTRIBUTE,5],[O.r.SIZE,6],[O.r.SIZEFEATUREATTRIBUTE,6],[O.r.OPACITYFEATUREATTRIBUTE,7],[O.r.OBJECTANDLAYERIDCOLOR,8]]);class I extends S.w{initializeProgram(e){return new x.B(e.rctx,I.shader.get().build(this.configuration),M)}_makePipelineState(e,t){const r=this.configuration,i=e===E.y.NONE,n=e===E.y.FrontFace,s=(0,g.cb)(r.output);return(0,P.Ey)({blending:r.output===g.V.Color||r.output===g.V.Alpha?i?A.V0:(0,A.ez)(e):null,depthTest:{func:(0,A.K_)(e)},depthWrite:i?r.writeDepth||s?P.kn:null:(0,A.XO)(e),colorWrite:P.wE,stencilWrite:r.hasOccludees?R.v0:null,stencilTest:r.hasOccludees?t?R.a9:R.qh:null,polygonOffset:i||n?r.hasPolygonOffset?N:null:A.SE})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?N:null;this._occluderPipelineTransparent=(0,P.Ey)({blending:A.V0,polygonOffset:t,depthTest:R.sf,depthWrite:null,colorWrite:P.wE,stencilWrite:null,stencilTest:R.mK}),this._occluderPipelineOpaque=(0,P.Ey)({blending:A.V0,polygonOffset:t,depthTest:R.sf,depthWrite:null,colorWrite:P.wE,stencilWrite:R.r8,stencilTest:R.I$}),this._occluderPipelineMaskWrite=(0,P.Ey)({blending:null,polygonOffset:t,depthTest:R.m,depthWrite:null,colorWrite:null,stencilWrite:R.v0,stencilTest:R.a9})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?D.WR.LINES:D.WR.TRIANGLE_STRIP}getPipeline(e,t,r){return e?this._occludeePipelineState:this.configuration.occluder?r?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}I.shader=new C.$(b.R,(()=>r.e(3740).then(r.bind(r,53740))));const N={factor:0,units:-4};var F,L,z=r(47268);(L=F||(F={}))[L.LEFT_JOIN_START=-2]="LEFT_JOIN_START",L[L.LEFT_JOIN_END=-1]="LEFT_JOIN_END",L[L.LEFT_CAP_START=-4]="LEFT_CAP_START",L[L.LEFT_CAP_END=-5]="LEFT_CAP_END",L[L.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",L[L.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",L[L.RIGHT_CAP_START=4]="RIGHT_CAP_START",L[L.RIGHT_CAP_END=5]="RIGHT_CAP_END";class H extends _.im{constructor(e){super(e,new j),this._configuration=new z.Q,this.produces=new Map([[v.N.OPAQUE_MATERIAL,e=>e===g.V.Highlight||e===g.V.ObjectAndLayerIdColor||(e===g.V.Color||e===g.V.Alpha)&&this.parameters.renderOccluded===_.m$.OccludeAndTransparentStencil],[v.N.OPAQUE_NO_SSAO_DEPTH,e=>e===g.V.LinearDepth],[v.N.OCCLUDER_MATERIAL,e=>(0,g.Mo)(e)&&this.parameters.renderOccluded===_.m$.OccludeAndTransparentStencil],[v.N.TRANSPARENT_OCCLUDER_MATERIAL,e=>(0,g.Mo)(e)&&this.parameters.renderOccluded===_.m$.OccludeAndTransparentStencil],[v.N.TRANSPARENT_MATERIAL,e=>(e===g.V.Color||e===g.V.Alpha)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==_.m$.OccludeAndTransparentStencil],[v.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>(e===g.V.Color||e===g.V.Alpha)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==_.m$.OccludeAndTransparentStencil],[v.N.DRAPED_MATERIAL,e=>(0,g.i3)(e)]]),this._vertexAttributeLocations=M}getConfiguration(e,t){this._configuration.output=e,this._configuration.draped=t.slot===v.N.DRAPED_MATERIAL;const r=null!=this.parameters.stipplePattern&&e!==g.V.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&function(e){return e.anchor===w.kJ.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===_.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,r,i,n,o){if(!r.options.selectionMode)return;const a=e.attributes.get(O.r.POSITION).data,l=e.attributes.get(O.r.SIZE);let c=this.parameters.width;if(this.parameters.vvSize){const t=e.attributes.get(O.r.SIZEFEATUREATTRIBUTE).data[0];c*=(0,s.qE)(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else l&&(c*=l.data[0]);const d=i[0],h=i[1],u=(c/2+4)*e.screenToWorldRatio;let p=Number.MAX_VALUE,f=0;for(let e=0;e<a.length-5;e+=3){const t=a[e],r=a[e+1],i=d-t,n=h-r,o=a[e+3]-t,l=a[e+4]-r,c=(0,s.qE)((o*i+l*n)/(o*o+l*l),0,1),u=o*c-i,g=l*c-n,m=u*u+g*g;m<p&&(p=m,f=e/3)}p<u*u&&n(o.dist,o.normal,f,!1)}intersect(e,t,r,i,o,c){if(!r.options.selectionMode||!e.visible)return;if(!(0,y.zH)(t))return void n.A.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const d=e.attributes,f=d.get(O.r.POSITION).data;let g=this.parameters.width;if(this.parameters.vvSize){const e=d.get(O.r.SIZEFEATUREATTRIBUTE).data[0];g*=(0,s.qE)(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else d.has(O.r.SIZE)&&(g*=d.get(O.r.SIZE).data[0]);const m=r.camera,_=$;(0,a.C)(_,r.point);const v=g*m.pixelRatio/2+4*m.pixelRatio;(0,l.s)(ne[0],_[0]-v,_[1]+v,0),(0,l.s)(ne[1],_[0]+v,_[1]+v,0),(0,l.s)(ne[2],_[0]+v,_[1]-v,0),(0,l.s)(ne[3],_[0]-v,_[1]-v,0);for(let e=0;e<4;e++)if(!m.unprojectFromRenderScreen(ne[e],se[e]))return;(0,p.Cr)(m.eye,se[0],se[1],oe),(0,p.Cr)(m.eye,se[1],se[2],ae),(0,p.Cr)(m.eye,se[2],se[3],le),(0,p.Cr)(m.eye,se[3],se[0],ce);let T=Number.MAX_VALUE,w=0;const b=W(this.parameters,d)?f.length-2:f.length-5;for(let e=0;e<b;e+=3){G[0]=f[e]+t[12],G[1]=f[e+1]+t[13],G[2]=f[e+2]+t[14];const r=(e+3)%f.length;if(k[0]=f[r]+t[12],k[1]=f[r+1]+t[13],k[2]=f[r+2]+t[14],(0,p.mN)(oe,G)<0&&(0,p.mN)(oe,k)<0||(0,p.mN)(ae,G)<0&&(0,p.mN)(ae,k)<0||(0,p.mN)(le,G)<0&&(0,p.mN)(le,k)<0||(0,p.mN)(ce,G)<0&&(0,p.mN)(ce,k)<0)continue;if(m.projectToRenderScreen(G,Y),m.projectToRenderScreen(k,X),Y[2]<0&&X[2]>0){(0,l.f)(Z,G,k);const e=m.frustum,t=-(0,p.mN)(e[h.FB.NEAR],G)/(0,l.k)(Z,(0,p.Qj)(e[h.FB.NEAR]));(0,l.h)(Z,Z,t),(0,l.g)(G,G,Z),m.projectToRenderScreen(G,Y)}else if(Y[2]>0&&X[2]<0){(0,l.f)(Z,k,G);const e=m.frustum,t=-(0,p.mN)(e[h.FB.NEAR],k)/(0,l.k)(Z,(0,p.Qj)(e[h.FB.NEAR]));(0,l.h)(Z,Z,t),(0,l.g)(k,k,Z),m.projectToRenderScreen(k,X)}else if(Y[2]<0&&X[2]<0)continue;Y[2]=0,X[2]=0;const i=(0,u.kb)((0,u.Cr)(Y,X,K),_);i<T&&(T=i,(0,l.c)(Q,G),(0,l.c)(J,k),w=e/3)}const C=r.rayBegin,S=r.rayEnd;if(T<v*v){let e=Number.MAX_VALUE;if((0,u.ld)((0,u.Cr)(Q,J,K),(0,u.Cr)(C,S,ee),q)){(0,l.f)(q,q,C);const t=(0,l.l)(q);(0,l.h)(q,q,1/t),e=t/(0,l.q)(C,S)}c(e,q,w,!1)}}get _layout(){const e=(0,f.BP)().vec3f(O.r.POSITION).vec3f(O.r.PREVPOSITION).vec3f(O.r.NEXTPOSITION).f32(O.r.SUBDIVISIONFACTOR).vec2f(O.r.UV0);return this.parameters.vvSize?e.f32(O.r.SIZEFEATUREATTRIBUTE):e.f32(O.r.SIZE),this.parameters.vvColor?e.f32(O.r.COLORFEATUREATTRIBUTE):e.vec4f(O.r.COLOR),this.parameters.vvOpacity&&e.f32(O.r.OPACITYFEATUREATTRIBUTE),(0,i.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(O.r.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new B(this._layout,this.parameters)}createGLMaterial(e){return new V(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}}class V extends m.A{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==g.V.Color&&this._output!==g.V.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(I,e)}}class j extends T.S{constructor(){super(...arguments),this.width=0,this.color=d.Un,this.join="miter",this.cap=z.x.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class B{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t,this.numJoinSubdivisions=0;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=b.r+r}}_isClosed(e){return W(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.attributes.get(O.r.POSITION).indices.length/2+1,r=this._isClosed(e);let i=r?2:4;return i+=((r?t:t-1)-(r?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this._parameters.wireframe&&(i=2+4*(i-2)),i}write(e,t,r,n,s){const o=te,a=re,c=ie,d=r.attributes.get(O.r.POSITION),h=d.indices,u=d.data.length/3,p=r.attributes.get(O.r.DISTANCETOSTART)?.data;h&&h.length!==2*(u-1)&&console.warn("RibbonLineMaterial does not support indices");const f=r.attributes.get(O.r.SIZEFEATUREATTRIBUTE)?.data[0]??r.attributes.get(O.r.SIZE)?.data[0]??1;let g=[1,1,1,1],m=0;const _=this.vertexBufferLayout.fields.has(O.r.COLORFEATUREATTRIBUTE);_?m=r.attributes.get(O.r.COLORFEATUREATTRIBUTE).data[0]:r.attributes.has(O.r.COLOR)&&(g=r.attributes.get(O.r.COLOR).data);const v=(0,i.A)("enable-feature:objectAndLayerId-rendering")?r.objectAndLayerIdColor:null,y=this.vertexBufferLayout.fields.has(O.r.OPACITYFEATUREATTRIBUTE),T=y?r.attributes.get(O.r.OPACITYFEATUREATTRIBUTE).data[0]:0,w=new Float32Array(n.buffer),b=(0,i.A)("enable-feature:objectAndLayerId-rendering")?new Uint8Array(n.buffer):null,C=this.vertexBufferLayout.stride/4;let S=s*C;const A=S;let x=0;const R=p?(e,t,r)=>x=p[r]:(e,t,r)=>x+=(0,l.q)(e,t),E=(0,i.A)("enable-feature:objectAndLayerId-rendering"),D=(e,t,r,i,n,s,o)=>{if(w[S++]=t[0],w[S++]=t[1],w[S++]=t[2],w[S++]=e[0],w[S++]=e[1],w[S++]=e[2],w[S++]=r[0],w[S++]=r[1],w[S++]=r[2],w[S++]=i,w[S++]=o,w[S++]=n,w[S++]=f,_)w[S++]=m;else{const e=Math.min(4*s,g.length-4);w[S++]=g[e],w[S++]=g[e+1],w[S++]=g[e+2],w[S++]=g[e+3]}y&&(w[S++]=T),E&&(null!=v&&(b[4*S]=v[0],b[4*S+1]=v[1],b[4*S+2]=v[2],b[4*S+3]=v[3]),S++)};S+=C,(0,l.s)(a,d.data[0],d.data[1],d.data[2]),e&&(0,l.e)(a,a,e);const P=this._isClosed(r);if(P){const t=d.data.length-3;(0,l.s)(o,d.data[t],d.data[t+1],d.data[t+2]),e&&(0,l.e)(o,o,e)}else(0,l.s)(c,d.data[3],d.data[4],d.data[5]),e&&(0,l.e)(c,c,e),D(a,a,c,1,F.LEFT_CAP_START,0,0),D(a,a,c,1,F.RIGHT_CAP_START,0,0),(0,l.c)(o,a),(0,l.c)(a,c);const M=P?0:1,I=P?u:u-1;for(let t=M;t<I;t++){const r=(t+1)%u*3;(0,l.s)(c,d.data[r],d.data[r+1],d.data[r+2]),e&&(0,l.e)(c,c,e),R(o,a,t),D(o,a,c,0,F.LEFT_JOIN_END,t,x),D(o,a,c,0,F.RIGHT_JOIN_END,t,x);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const r=(e+1)/(i+1);D(o,a,c,r,F.LEFT_JOIN_END,t,x),D(o,a,c,r,F.RIGHT_JOIN_END,t,x)}D(o,a,c,1,F.LEFT_JOIN_START,t,x),D(o,a,c,1,F.RIGHT_JOIN_START,t,x),(0,l.c)(o,a),(0,l.c)(a,c)}P?((0,l.s)(c,d.data[3],d.data[4],d.data[5]),e&&(0,l.e)(c,c,e),x=R(o,a,I),D(o,a,c,0,F.LEFT_JOIN_END,M,x),D(o,a,c,0,F.RIGHT_JOIN_END,M,x)):(x=R(o,a,I),D(o,a,a,0,F.LEFT_CAP_END,I,x),D(o,a,a,0,F.RIGHT_CAP_END,I,x)),U(w,A+C,w,A,C),S=U(w,S-C,w,S,C),this._parameters.wireframe&&this._addWireframeVertices(n,A,S,C)}_addWireframeVertices(e,t,r,i){const n=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),s=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let o=0;const a=e=>o=U(s,e,n,o,i);for(let e=0;e<s.length-1;e+=2*i)a(e),a(e+2*i),a(e+1*i),a(e+2*i),a(e+1*i),a(e+3*i)}}function U(e,t,r,i,n){for(let s=0;s<n;s++)r[i++]=e[t++];return i}function W(e,t){return!!e.isClosed&&t.get(O.r.POSITION).indices.length>2}const G=(0,c.vt)(),k=(0,c.vt)(),Z=(0,c.vt)(),q=(0,c.vt)(),$=(0,c.vt)(),Y=(0,o.r_)(),X=(0,o.r_)(),Q=(0,c.vt)(),J=(0,c.vt)(),K=(0,u.vt)(),ee=(0,u.vt)(),te=(0,c.vt)(),re=(0,c.vt)(),ie=(0,c.vt)(),ne=[(0,o.r_)(),(0,o.r_)(),(0,o.r_)(),(0,o.r_)()],se=[(0,c.vt)(),(0,c.vt)(),(0,c.vt)(),(0,c.vt)()],oe=(0,p.vt)(),ae=(0,p.vt)(),le=(0,p.vt)(),ce=(0,p.vt)()},59615:(e,t,r)=>{r.d(t,{W:()=>s});var i=r(31272),n=r(73395);class s extends i.im{intersect(e,t,r,i,s,o){return(0,n.Uy)(e,r,i,s,void 0,o)}}},51310:(e,t,r)=>{r.d(t,{Xq:()=>a,wk:()=>o});const i={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},n={dash:i.dash,"dash-dot":[...i.dash,...i.dot],dot:i.dot,"long-dash":i["long-dash"],"long-dash-dot":[...i["long-dash"],...i.dot],"long-dash-dot-dot":[...i["long-dash"],...i.dot,...i.dot],none:null,"short-dash":i["short-dash"],"short-dash-dot":[...i["short-dash"],...i["short-dot"]],"short-dash-dot-dot":[...i["short-dash"],...i["short-dot"],...i["short-dot"]],"short-dot":i["short-dot"],solid:null},s=8;function o(e){return{pattern:[e,e],pixelRatio:2}}function a(e){return null!=e&&"style"===e.type?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(n[e],s):null}(e.style):null}},18994:(e,t,r)=>{r.d(t,{Dt:()=>h,kJ:()=>n,lM:()=>i});var i,n,s,o=r(82392),a=r(77788),l=r(51662),c=r(7782),d=r(18693);(s=i||(i={}))[s.Draped=0]="Draped",s[s.Screen=1]="Screen",s[s.World=2]="World",s[s.COUNT=3]="COUNT",function(e){e[e.Center=0]="Center",e[e.Tip=1]="Tip",e[e.COUNT=2]="COUNT"}(n||(n={}));class h extends d.E{constructor(){super(...arguments),this.output=a.V.Color,this.transparencyPassType=c.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=i.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=n.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===i.Draped}}(0,o._)([(0,l.W)({count:a.V.COUNT})],h.prototype,"output",void 0),(0,o._)([(0,l.W)({count:c.y.COUNT})],h.prototype,"transparencyPassType",void 0),(0,o._)([(0,l.W)()],h.prototype,"occluder",void 0),(0,o._)([(0,l.W)()],h.prototype,"hasSlicePlane",void 0),(0,o._)([(0,l.W)()],h.prototype,"writeDepth",void 0),(0,o._)([(0,l.W)({count:i.COUNT})],h.prototype,"space",void 0),(0,o._)([(0,l.W)()],h.prototype,"hideOnShortSegments",void 0),(0,o._)([(0,l.W)()],h.prototype,"hasCap",void 0),(0,o._)([(0,l.W)({count:n.COUNT})],h.prototype,"anchor",void 0),(0,o._)([(0,l.W)()],h.prototype,"hasTip",void 0),(0,o._)([(0,l.W)()],h.prototype,"vvSize",void 0),(0,o._)([(0,l.W)()],h.prototype,"vvColor",void 0),(0,o._)([(0,l.W)()],h.prototype,"vvOpacity",void 0),(0,o._)([(0,l.W)()],h.prototype,"hasOccludees",void 0),(0,o._)([(0,l.W)()],h.prototype,"multipassEnabled",void 0),(0,o._)([(0,l.W)()],h.prototype,"cullAboveGround",void 0),(0,o._)([(0,l.W)({constValue:!1})],h.prototype,"occlusionPass",void 0),(0,o._)([(0,l.W)({constValue:!0})],h.prototype,"hasVvInstancing",void 0),(0,o._)([(0,l.W)({constValue:!0})],h.prototype,"hasSliceTranslatedView",void 0)},47268:(e,t,r)=>{r.d(t,{Q:()=>d,x:()=>i});var i,n,s=r(82392),o=r(77788),a=r(51662),l=r(7782),c=r(18693);(n=i||(i={}))[n.BUTT=0]="BUTT",n[n.SQUARE=1]="SQUARE",n[n.ROUND=2]="ROUND",n[n.COUNT=3]="COUNT";class d extends c.E{constructor(){super(...arguments),this.output=o.V.Color,this.capType=i.BUTT,this.transparencyPassType=l.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}}(0,s._)([(0,a.W)({count:o.V.COUNT})],d.prototype,"output",void 0),(0,s._)([(0,a.W)({count:i.COUNT})],d.prototype,"capType",void 0),(0,s._)([(0,a.W)({count:l.y.COUNT})],d.prototype,"transparencyPassType",void 0),(0,s._)([(0,a.W)()],d.prototype,"occluder",void 0),(0,s._)([(0,a.W)()],d.prototype,"hasSlicePlane",void 0),(0,s._)([(0,a.W)()],d.prototype,"hasPolygonOffset",void 0),(0,s._)([(0,a.W)()],d.prototype,"writeDepth",void 0),(0,s._)([(0,a.W)()],d.prototype,"draped",void 0),(0,s._)([(0,a.W)()],d.prototype,"stippleEnabled",void 0),(0,s._)([(0,a.W)()],d.prototype,"stippleOffColorEnabled",void 0),(0,s._)([(0,a.W)()],d.prototype,"stipplePreferContinuous",void 0),(0,s._)([(0,a.W)()],d.prototype,"roundJoins",void 0),(0,s._)([(0,a.W)()],d.prototype,"applyMarkerOffset",void 0),(0,s._)([(0,a.W)()],d.prototype,"vvSize",void 0),(0,s._)([(0,a.W)()],d.prototype,"vvColor",void 0),(0,s._)([(0,a.W)()],d.prototype,"vvOpacity",void 0),(0,s._)([(0,a.W)()],d.prototype,"falloffEnabled",void 0),(0,s._)([(0,a.W)()],d.prototype,"innerColorEnabled",void 0),(0,s._)([(0,a.W)()],d.prototype,"hasOccludees",void 0),(0,s._)([(0,a.W)()],d.prototype,"multipassEnabled",void 0),(0,s._)([(0,a.W)()],d.prototype,"cullAboveGround",void 0),(0,s._)([(0,a.W)()],d.prototype,"wireframe",void 0),(0,s._)([(0,a.W)()],d.prototype,"objectAndLayerIdColorInstanced",void 0),(0,s._)([(0,a.W)({constValue:!1})],d.prototype,"occlusionPass",void 0),(0,s._)([(0,a.W)({constValue:!0})],d.prototype,"hasVvInstancing",void 0),(0,s._)([(0,a.W)({constValue:!0})],d.prototype,"hasSliceTranslatedView",void 0)},89325:(e,t,r)=>{r.d(t,{g:()=>c});var i=r(3223),n=r(80861),s=r(62088),o=r(63103),a=r(68716);const l=()=>n.A.getLogger("esri.views.webgl.BufferObject");class c{static createIndex(e,t,r){return new c(e,a.NZ.ELEMENT_ARRAY_BUFFER,t,r)}static createVertex(e,t,r){return new c(e,a.NZ.ARRAY_BUFFER,t,r)}static createUniform(e,t,r){return new c(e,a.NZ.UNIFORM_BUFFER,t,r)}static createPixelPack(e,t=a._U.STREAM_READ,r){const i=new c(e,a.NZ.PIXEL_PACK_BUFFER,t);return r&&i.setSize(r),i}static createPixelUnpack(e,t=a._U.STREAM_DRAW,r){return new c(e,a.NZ.PIXEL_UNPACK_BUFFER,t,r)}static createTransformFeedback(e,t=a._U.STATIC_DRAW,r){const i=new c(e,a.NZ.TRANSFORM_FEEDBACK_BUFFER,t);return i.setSize(r),i}constructor(e,t,r,i){this._context=e,this.bufferType=t,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(a.vt.BufferObject,this),this._glName=this._context.gl.createBuffer(),(0,o.Y2)(this._context.gl),i&&this.setData(i)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get usedMemory(){return this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER?this._indexType===a.pe.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER||this.bufferType===a.NZ.ARRAY_BUFFER}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(a.vt.BufferObject,this),this._context=null):this._glName&&l().warn("Leaked WebGL buffer object")}setSize(e,t=null){if(e<=0&&l().error("Buffer size needs to be positive!"),this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER&&null!=t)switch(this._indexType=t,t){case a.pe.UNSIGNED_SHORT:e*=2;break;case a.pe.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;this.bufferType===a.NZ.ELEMENT_ARRAY_BUFFER&&((0,s.jq)(e)&&(t/=2,this._indexType=a.pe.UNSIGNED_SHORT),(0,s.XJ)(e)&&(t/=4,this._indexType=a.pe.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e,t=null){this._size=e;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const i=this._context.gl;null!=t?i.bufferData(this.bufferType,t,this.usage):i.bufferData(this.bufferType,e,this.usage),(0,o.Y2)(i),this._isVAOAware&&this._context.bindVAO(r)}setSubData(e,t,r,i){if(!e)return;(t<0||t*e.BYTES_PER_ELEMENT>=this.usedMemory)&&l().error("offset is out of range!"),r>=i&&l().error("end must be bigger than start!"),(t+(i-r))*e.BYTES_PER_ELEMENT>this.usedMemory&&l().error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:s}=this._context;s.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,r,i-r),(0,o.Y2)(s),this._isVAOAware&&this._context.bindVAO(n)}getSubData(e,t=0,r,n){if(r<0||n<0)return void l().error("Problem getting subdata: offset and length were less than zero!");const s=function(e){return(0,i.Xj)(e)}(e)?e.BYTES_PER_ELEMENT:1;if(s*((r??0)+(n??0))>e.byteLength)return void l().error("Problem getting subdata: offset and length exceeded destination size!");t+s*(n??0)>this.usedMemory&&l().warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this.bufferType===a.NZ.TRANSFORM_FEEDBACK_BUFFER?(this._context.bindBuffer(this,a.NZ.TRANSFORM_FEEDBACK_BUFFER),o.getBufferSubData(a.NZ.TRANSFORM_FEEDBACK_BUFFER,t,e,r,n),this._context.unbindBuffer(a.NZ.TRANSFORM_FEEDBACK_BUFFER)):(this._context.bindBuffer(this,a.NZ.COPY_READ_BUFFER),o.getBufferSubData(a.NZ.COPY_READ_BUFFER,t,e,r,n),this._context.unbindBuffer(a.NZ.COPY_READ_BUFFER))}async getSubDataAsync(e,t=0,r,i){await this._context.clientWaitAsync(),this.getSubData(e,t,r,i)}}},40866:(e,t,r)=>{r.d(t,{Z:()=>c});var i=r(80861),n=r(57725),s=r(62088),o=r(68716),a=r(73360);const l=()=>i.A.getLogger("esri.views.webgl.VertexArrayObject");let c=class{constructor(e,t,r,i,n=null){this._context=e,this._locations=t,this._layout=r,this._buffers=i,this._indexBuffer=n,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Object.keys(this._buffers).reduce(((e,t)=>e+this._buffers[t].usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*s.zQ}dispose(){if(this._context){this._context.getBoundVAO()===this&&this._context.bindVAO(null);for(const e in this._buffers)this._buffers[e]?.dispose(),delete this._buffers[e];this._indexBuffer=(0,n.WD)(this._indexBuffer),this.disposeVAOOnly()}else(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&l().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(o.vt.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:e}=this._context,t=e.createVertexArray();e.bindVertexArray(t),this._bindLayout(),e.bindVertexArray(null),this._glName=t,this._context.instanceCounter.increment(o.vt.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:e,_layout:t,_indexBuffer:r}=this;e||l().error("Vertex buffer dictionary is empty!");const i=this._context.gl;for(const r in e){const i=e[r];i||l().error("Vertex buffer is uninitialized!");const n=t[r];n||l().error("Vertex element descriptor is empty!"),(0,a.yu)(this._context,this._locations,i,n)}null!=r&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,r.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}}},67277:(e,t,r)=>{r.d(t,{_:()=>i});class i{constructor(e,t,r,i,n,s=!1,o=0){this.name=e,this.count=t,this.type=r,this.offset=i,this.stride=n,this.normalized=s,this.divisor=o}}}}]);